# REQ-006 Plan

## 目标回放（1-3 行）

优化 `skill-creator` 和 `rules-creator`，让它们产出的 skills 和 rules 都带有创建日期元数据。创建日期通过系统命令获取真实日期，确保格式统一为 `YYYY-MM-DD`。

## 状态摘要（Status Summary）

- **当前阶段**：work
- **进度**：4/4
- **当前任务**：已完成
- **阻塞项**：无
- **上次更新**：2026-01-15
- **测试状态**：所有验证通过

## 文件变更清单（Files to Change）

| 操作 | 文件路径 | 说明 |
|-----|---------|-----|
| 修改 | `.cursor/skills/skill-creator/scripts/init_skill.py` | 添加日期获取逻辑，替换 `{DATE}` 占位符，添加 `metadata.created` |
| 修改 | `.cursor/skills/rules-creator/SKILL.md` | 优化实现，添加创建日期元数据支持，参考 skill-creator 最佳实践 |
| 创建 | `.cursor/skills/rules-creator/scripts/`（可选） | 如需要，创建辅助脚本 |
| 测试 | 手动验证 | 测试 init_skill.py 生成的 SKILL.md 包含日期 |

## 任务清单（Tasks）

### 工具优化任务

- [x] T1: 修改 `init_skill.py` 添加日期获取和 frontmatter 元数据（依赖: 无）
  - 修改: `.cursor/skills/skill-creator/scripts/init_skill.py`
  - **实现方案**：
    1. **日期获取**：使用 Python `datetime` 模块（更可靠，跨平台）
       ```python
       from datetime import date
       created_date = date.today().strftime('%Y-%m-%d')
       ```
    2. **修改模板**：在 `SKILL_TEMPLATE` 的 frontmatter 中添加 `metadata.created` 字段
       ```yaml
       ---
       name: {skill_name}
       description: [TODO: ...]
       metadata:
         created: "{created_date}"
       ---
       ```
    3. **模板格式化**：在 `init_skill()` 函数中，使用 `created_date` 格式化模板
       ```python
       skill_content = SKILL_TEMPLATE.format(
           skill_name=skill_name,
           skill_title=skill_title,
           created_date=created_date
       )
       ```
  - **验证**：运行脚本生成测试 skill，检查：
    - frontmatter 包含 `metadata.created: "YYYY-MM-DD"` 字段
    - 日期格式为 `YYYY-MM-DD`
    - `quick_validate.py` 验证通过（metadata 字段在允许列表中）

- [x] T2: 优化 `rules-creator` Skill 添加创建日期支持（依赖: T1）
  - 修改: `.cursor/skills/rules-creator/SKILL.md`
  - **实现方案**（基于调查结果）：
    1. **日期获取方式**：在 Instructions 中添加步骤，使用 Python `datetime` 或系统命令
       - 如果通过 Python 脚本：`from datetime import date; created_date = date.today().strftime('%Y-%m-%d')`
       - 如果通过系统命令：`date +%Y-%m-%d`（在 AI 执行时调用）
    2. **日期存储位置**（两种方案，优先方案A）：
       - **方案A**：在 frontmatter 中添加 `created` 字段（尝试，如果 Cursor 支持）
         ```yaml
         ---
         alwaysApply: true
         created: "2026-01-15"
         ---
         ```
       - **方案B**：在文件末尾添加 `Created:` 字段（与现有 `Source:` 和 `Adopted:` 保持一致）
         ```markdown
         ---
         Source: {来源经验}
         Created: {created_date}
         Adopted: {adopted_date}
         ```
    3. **更新所有模板**：在"应用规则模板"部分，为所有类型（always/fs/i/m）的模板添加创建日期
    4. **优化结构**（参考 skill-creator 最佳实践）：
       - 检查是否有可提取为 `scripts/` 的重复逻辑（如日期获取）
       - 检查是否有可提取为 `references/` 的详细说明（如 Cursor Rules 规范）
       - 确保符合 AgentSkills 规范和最佳实践（Progressive Disclosure）
  - **验证**：使用 rules-creator 创建测试规则，检查：
    - 规则文件包含创建日期（frontmatter 或文件末尾）
    - 日期格式为 `YYYY-MM-DD`

- [x] T3: 验证和测试（依赖: T1, T2）
  - **测试 skill 生成**：
    1. 运行 `python .cursor/skills/skill-creator/scripts/init_skill.py test-skill --path /tmp`
    2. 检查生成的 `SKILL.md` frontmatter：
       - 包含 `metadata.created: "YYYY-MM-DD"` 字段
       - 日期格式为 `YYYY-MM-DD`
       - 日期为当前真实日期
    3. 运行 `python .cursor/skills/skill-creator/scripts/quick_validate.py /tmp/test-skill`
       - 验证通过（metadata 字段在允许列表中）
  - **测试规则创建**：
    1. 使用 rules-creator 创建测试规则（通过 `/flow 采纳质量准则` 或直接调用）
    2. 检查生成的规则文件：
       - 包含创建日期（frontmatter `created` 字段或文件末尾 `Created:`）
       - 日期格式为 `YYYY-MM-DD`
       - 日期为当前真实日期
  - **清理测试文件**：删除 `/tmp/test-skill` 测试目录

- [x] T4: 文档和索引更新（依赖: T1, T2, T3）
  - 更新: `.workflow/requirements/INDEX.md`（Status 已在 plan 阶段更新为 `planned`）
  - 检查：所有变更符合项目规范

## 交付物（Deliverables）

- [x] 代码变更：`init_skill.py` 支持日期获取和替换
- [x] 代码变更：`rules-creator` Skill 支持创建日期元数据
- [x] 验证通过：生成的 skill 文件包含正确的创建日期（`metadata.created: "YYYY-MM-DD"`）
- [x] 索引更新：INDEX.md 状态已在 plan 阶段更新为 `planned`

## 测试规格（Test Specifications）

### 可测试行为清单

| 行为ID | 行为描述 | 测试类型 |
|-------|---------|---------|
| B1 | `init_skill.py` 生成的 SKILL.md frontmatter 包含 `metadata.created` 字段 | 手工验证 |
| B2 | `init_skill.py` 生成的日期为当前真实日期 | 手工验证 |
| B3 | `rules-creator` 创建的规则包含创建日期（frontmatter 或文件末尾） | 手工验证 |
| B4 | 所有日期格式为 `YYYY-MM-DD` | 手工验证 |
| B5 | 生成的 skill 通过 `quick_validate.py` 验证 | 手工验证 |

### 手工验证步骤

| 步骤 | 操作 | 预期行为 |
|-----|-----|---------|
| 1 | 运行 `python .cursor/skills/skill-creator/scripts/init_skill.py test-skill --path /tmp` | 成功创建 skill 目录和文件，无错误输出 |
| 2 | 检查生成的 `SKILL.md` frontmatter | 包含 `metadata.created: "YYYY-MM-DD"` 字段，日期为当前日期 |
| 3 | 运行 `python .cursor/skills/skill-creator/scripts/quick_validate.py /tmp/test-skill` | 输出 "Skill is valid!"，验证通过 |
| 4 | 使用 rules-creator 创建测试规则 | 规则文件包含创建日期（优先 frontmatter `created`，否则文件末尾 `Created:`） |
| 5 | 检查所有日期格式 | 所有日期均为 `YYYY-MM-DD` 格式 |
| 6 | 清理测试文件 | 删除 `/tmp/test-skill` 目录 |

## 复利候选（Compounding Candidates）

- [ ] （候选）工具脚本统一日期获取方式：考虑将日期获取逻辑提取为共享工具函数，供多个脚本使用

## 调查结果与方案确认

### 调查发现

1. **AgentSkills 规范**：
   - `metadata` 字段是可选字段，支持任意 key-value 映射
   - `metadata.created` 符合规范，可以用于记录创建日期

2. **Cursor Rules 规范**：
   - Frontmatter 主要支持：`description`, `globs`, `alwaysApply`
   - 可能支持自定义字段（未在官方文档明确说明）
   - 现有规则使用文件末尾的 `Source:` 和 `Adopted:` 格式记录日期

3. **当前实现状态**：
   - `init_skill.py` 模板中没有 `{DATE}` 占位符，需要添加 `metadata.created` 字段
   - `rules-creator` 目前没有创建日期支持

### 最终方案

1. **Skills (init_skill.py)**：
   - ✅ 在 frontmatter 中添加 `metadata.created` 字段（符合 AgentSkills 规范）
   - ✅ 使用 Python `datetime` 模块获取日期（跨平台，可靠）

2. **Rules (rules-creator)**：
   - ✅ 优先方案：在 frontmatter 中添加 `created` 字段（尝试，如果 Cursor 支持）
   - ✅ 备选方案：在文件末尾添加 `Created:` 字段（与现有格式保持一致）
   - ✅ 使用系统命令或 Python 获取日期（AI 执行时调用）
