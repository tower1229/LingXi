# REQ-002 Plan

## 目标回放

创建一个 Node.js 脚本，自动验证 `.workflow/requirements/INDEX.md` 的格式和一致性，包括表头格式、ID 格式、Status/Current Phase 值有效性、文件一致性和目录一致性检查。

## 状态摘要（Status Summary）

- **当前阶段**：work
- **进度**：7/7
- **当前任务**：已完成
- **阻塞项**：无
- **上次更新**：2026-01-29

## 文件变更清单（Files to Change）

| 操作 | 文件路径 | 说明 |
|-----|---------|-----|
| 创建 | `scripts/validate-index.js` | 主验证脚本 |
| 创建 | `scripts/__tests__/validate-index.test.js` | 单元测试文件 |

## 任务清单（Tasks）

### 实现任务

- [x] T1: 创建验证脚本主文件（依赖: 无）
  - 创建: `scripts/validate-index.js`
  - 功能：
    - 读取 `.workflow/requirements/INDEX.md` 文件
    - 解析表头和表格行
    - 实现验证逻辑（表头格式、ID 格式、Status/Current Phase 值、文件一致性、目录一致性）
    - 输出验证结果（成功/失败，错误详情）
    - 支持命令行运行（使用 Node.js 标准库，无需外部依赖）

- [x] T2: 实现表头格式验证（依赖: T1）
  - 验证表头包含 7 个字段：ID | Title | Status | Current Phase | Next Action | Blockers | Links
  - 验证字段顺序正确

- [x] T3: 实现行数据验证（依赖: T1）
  - 验证每行的 ID 格式（REQ-xxx，其中 xxx 为数字）
  - 验证 Status 值有效性（in-progress/planned/in-review/needs-fix/completed）
  - 验证 Current Phase 值有效性（req/plan/audit/work/review/archive）

- [x] T4: 实现文件一致性检查（依赖: T1）
  - 解析 Links 字段，提取文件路径
  - 检查索引中的 REQ 对应的文件是否存在（.md, .plan.md, .review.md）
  - 区分 in-progress/ 和 completed/ 目录

- [x] T5: 实现目录一致性检查（依赖: T1, T4）
  - 检查 Status = completed 时，文件应在 completed/ 目录
  - 检查 Status != completed 时，文件应在 in-progress/ 目录
  - 验证 Links 字段中的路径与 Status 匹配

### 测试任务

- [x] T6: 编写单元测试（依赖: T1, T2, T3, T4, T5）
  - 创建: `scripts/__tests__/validate-index.test.js`
  - 测试用例：
    - 测试表头格式验证（正确表头、缺少字段、字段顺序错误）
    - 测试 ID 格式验证（正确格式、错误格式）
    - 测试 Status 值验证（有效值、无效值）
    - 测试 Current Phase 值验证（有效值、无效值）
    - 测试文件一致性检查（文件存在、文件缺失）
    - 测试目录一致性检查（Status 与目录匹配、不匹配）
    - 测试完整验证流程（使用测试用的 INDEX.md 文件）

- [x] T7: 运行测试并确认通过（依赖: T6）
  - 运行测试：`node scripts/__tests__/validate-index.test.js` 或使用测试框架
  - 确认所有测试用例通过
  - 验证脚本能够正确处理实际项目的 INDEX.md

## 交付物（Deliverables）

- [x] 代码变更：`scripts/validate-index.js` 创建完成
- [x] 单元测试通过：所有测试用例通过（14 passed, 0 failed）
- [x] 功能验证：脚本能够正确验证实际项目的 INDEX.md

## 测试规格（Test Specifications）

### 可测试行为清单

| 行为ID | 行为描述 | 测试类型 |
|-------|---------|---------|
| B1 | 验证表头格式（7 个字段） | 单元测试 |
| B2 | 验证 ID 格式（REQ-xxx） | 单元测试 |
| B3 | 验证 Status 值有效性 | 单元测试 |
| B4 | 验证 Current Phase 值有效性 | 单元测试 |
| B5 | 检查文件一致性 | 单元测试 |
| B6 | 检查目录一致性 | 单元测试 |
| B7 | 输出验证结果 | 单元测试 |

### 单元测试规格

| 行为 | 输入 | 预期输出 | 边界/错误条件 |
|-----|-----|---------|--------------|
| B1: 验证表头格式 | 正确的表头行 | 通过 | 缺少字段、字段顺序错误 |
| B1: 验证表头格式 | 缺少字段的表头 | 失败，错误信息 | - |
| B2: 验证 ID 格式 | "REQ-001" | 通过 | "REQ-1"（数字不足3位）、"REQ-abc"（非数字） |
| B2: 验证 ID 格式 | "REQ-1" | 失败，错误信息 | - |
| B3: 验证 Status 值 | "in-progress" | 通过 | "invalid-status" |
| B3: 验证 Status 值 | "invalid-status" | 失败，错误信息 | - |
| B4: 验证 Current Phase 值 | "req" | 通过 | "invalid-phase" |
| B4: 验证 Current Phase 值 | "invalid-phase" | 失败，错误信息 | - |
| B5: 检查文件一致性 | 文件存在 | 通过 | 文件不存在 |
| B5: 检查文件一致性 | 文件不存在 | 失败，错误信息 | - |
| B6: 检查目录一致性 | Status=completed, 文件在 completed/ | 通过 | Status=completed, 文件在 in-progress/ |
| B6: 检查目录一致性 | Status=in-progress, 文件在 in-progress/ | 通过 | Status=in-progress, 文件在 completed/ |
| B7: 输出验证结果 | 所有验证通过 | 输出成功信息，退出码 0 | - |
| B7: 输出验证结果 | 存在验证失败 | 输出错误详情，退出码 1 | - |

### 手工验证步骤

| 步骤 | 操作 | 预期行为 |
|-----|-----|---------|
| 1 | 运行 `node scripts/validate-index.js` | 脚本读取 `.workflow/requirements/INDEX.md` 并执行验证 |
| 2 | 检查输出 | 输出验证结果（成功/失败）和错误详情（如有） |
| 3 | 验证退出码 | 验证通过时退出码为 0，失败时为 1 |

## 执行记录（Worklog）

- 2026-01-29: Plan 创建完成
- 2026-01-29: 创建验证脚本主文件 `scripts/validate-index.js`
  - 实现了所有验证功能：表头格式、ID 格式、Status/Current Phase 值、文件一致性、目录一致性
  - 支持命令行运行，使用 Node.js 标准库，无外部依赖
  - 输出格式：成功时退出码 0，失败时退出码 1 并输出错误详情
- 2026-01-29: 创建单元测试文件 `scripts/__tests__/validate-index.test.js`
  - 测试覆盖所有 7 个可测试行为（B1-B7）
  - 包含边界条件和错误情况测试
- 2026-01-29: 运行测试
  - 命令: `node scripts/__tests__/validate-index.test.js`
  - 结果: 14 passed, 0 failed
  - 覆盖: B1, B2, B3, B4, B5, B6, B7 行为已验证
- 2026-01-29: 验证脚本功能
  - 命令: `node scripts/validate-index.js`
  - 结果: 验证通过，2 行数据全部正确
  - 确认脚本能够正确处理实际项目的 INDEX.md

## 复利候选（Compounding Candidates）

- （候选）验证脚本可以作为 CI/CD 集成点，在提交前自动检查 INDEX.md 格式
