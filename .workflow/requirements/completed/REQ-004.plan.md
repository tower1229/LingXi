# REQ-004 Plan: 计划实施Phase A（P0）：纪律底盘

## 目标回放（1-3 行）

强化灵犀的"魂控制魄"机制：为每个阶段定义可验证的检查清单、建立沉淀过滤标准（Noise Filter）、落地治理策略、移除冗余的推进判据确认环节，让灵犀可被长期信任。

## 状态摘要（Status Summary）

- **当前阶段**：review
- **进度**：12/12
- **当前任务**：review 已完成
- **阻塞项**：无
- **上次更新**：2026-01-27

## 文件变更清单（Files to Change）

| 操作 | 文件路径 | 说明 |
|-----|---------|-----|
| 修改 | `.cursor/skills/flow-router/SKILL.md` | 移除冗余的推进判据确认环节 |
| 修改 | `.cursor/skills/req/SKILL.md` | 添加可推进判据检查清单 |
| 修改 | `.cursor/skills/plan/SKILL.md` | 添加可推进判据检查清单 |
| 修改 | `.cursor/skills/audit/SKILL.md` | 添加可推进判据检查清单 |
| 修改 | `.cursor/skills/work/SKILL.md` | 添加可推进判据检查清单 |
| 修改 | `.cursor/skills/review/SKILL.md` | 添加可推进判据检查清单 |
| 修改 | `.cursor/skills/archive/SKILL.md` | 添加可推进判据检查清单 |
| 修改 | `.cursor/agents/experience-collector.md` | 增加噪音过滤器逻辑 |
| 修改 | `.cursor/skills/experience-collector/SKILL.md` | 增加噪音过滤器逻辑 |
| 修改 | `.cursor/skills/experience-curator/SKILL.md` | 固化治理逻辑，统一报告格式 |
| 创建 | `docs/02-design/gate-protocol.md` | 闸门协议设计文档（可推进判据检查清单定义） |
| 创建 | `docs/02-design/noise-filter.md` | 沉淀过滤标准（Noise Filter）设计文档 |
| 修改 | `docs/02-design/experience-governance.md` | 明确触发条件与执行流程 |
| 修改 | `.cursor/commands/flow.md` | 更新推进判据确认流程说明 |

## 任务清单（Tasks）

### 子任务 1：强化闸门协议

- [x] T1: 定义各阶段的可推进判据检查清单（依赖: 无）
  - 创建: `docs/02-design/gate-protocol.md`
  - 内容：为 req/plan/audit/work/review/archive 每个阶段定义可验证的检查清单
  - 格式：每个判据包含"检查项"、"验证方式"、"状态（已满足/未满足）"
  - 状态：已完成

- [x] T2: 在 flow-router Skill 中实现判据检查逻辑（依赖: T1）
  - 修改: `.cursor/skills/flow-router/SKILL.md`
  - 内容：添加判据检查函数，检查判据满足情况
  - 状态：已完成（添加了判据检查逻辑和输出格式）

- [x] T3: 统一质量闸门输出格式（依赖: T1, T2）
  - 修改: `.cursor/skills/flow-router/SKILL.md`
  - 内容：定义统一的输出格式，明确展示"已满足/未满足"的判据
  - 状态：已完成（已在 T2 中实现统一的表格格式）

- [x] T4: 在各阶段 Skill 中固化检查清单（依赖: T1，执行顺序：先完成 T1，再逐个更新 Skills）
  - 修改: `.cursor/skills/req/SKILL.md`
  - 修改: `.cursor/skills/plan/SKILL.md`
  - 修改: `.cursor/skills/audit/SKILL.md`
  - 修改: `.cursor/skills/work/SKILL.md`
  - 修改: `.cursor/skills/review/SKILL.md`
  - 修改: `.cursor/skills/archive/SKILL.md`
  - 内容：在每个 Skill 中引用检查清单，确保严格执行
  - 执行顺序：先完成 T1 定义检查清单，再按顺序逐个更新每个 Skill（避免并行修改导致不一致）
  - 状态：已完成（已在 6 个阶段 Skill 中添加可推进判据检查章节）

### 子任务 2：沉淀过滤标准（Noise Filter）

- [x] T5: 定义"明显噪音"的特征（依赖: 无）
  - 创建: `docs/02-design/noise-filter.md`
  - 内容：定义可程序化过滤的噪音特征，使用内容模式而非关键词匹配/长度阈值
  - 判断规则（基于内容模式）：
    - **结构缺失模式**：EXP-CANDIDATE 缺少必要的结构化字段（如：decision、alternatives、signal 缺失）
    - **步骤复现模式**：内容只是"做了什么"的步骤描述，而非"如何判断"的结构（缺少 Decision Shape）
    - **无取舍依据模式**：没有 alternatives rejected，无法体现判断过程
    - **临时调试模式**：内容包含明显的临时调试痕迹（如：console.log、临时变量名、一次性错误信息）
    - **过于具体模式**：内容只适用于单一场景，无法抽象为可复用的判断结构（需结合上下文判断，避免误判）
  - 状态：已完成

- [x] T6: 在 experience-collector 中实现噪音过滤器（依赖: T5）
  - 修改: `.cursor/agents/experience-collector.md`
  - 内容：实现噪音过滤逻辑，自动过滤明显噪音候选
  - 状态：已完成（已在 experience-collector 中添加噪音过滤器逻辑，应用 5 种判断模式）

- [x] T7: 为被过滤的候选提供理由说明（依赖: T6）
  - 修改: `.cursor/agents/experience-collector.md`
  - 内容：被过滤的候选记录过滤理由，支持人工复核
  - 状态：已完成（已在 T6 中实现，每个过滤模式都有明确理由）

### 子任务 3：治理策略落地

- [x] T8: 明确合并/取代/升级的触发条件（依赖: 无）
  - 修改: `docs/02-design/experience-governance.md`
  - 内容：明确定义触发条件（如：经验数量达到阈值、发现明显重复、Strength 达到 enforced 等）
  - 状态：已完成（已明确合并/取代的触发条件：经验文件新增；升级为规则的触发条件：Strength=enforced、问题反复出现、Capsule 可抽象）

- [x] T9: 统一治理报告格式（依赖: 无）
  - 修改: `.cursor/skills/experience-curator/SKILL.md`
  - 内容：定义统一的治理报告格式，包含变更理由、影响范围、回滚方式
  - 格式模板示例：
    ```markdown
    ## 成长循环：治理报告
    
    ### 执行动作
    | 类型 | 新经验 | 旧经验 | 理由 |
    |------|--------|--------|------|
    | 合并 | EXP-003 | EXP-001 | Trigger 关键词重叠 75%，主题高度相似 |
    | 取代 | EXP-004 | EXP-002 | 新经验是旧经验的升级版（更完整/更准确） |
    
    ### 影响范围
    - INDEX 变更行数：2
    - deprecated 经验数：2
    - 涉及文件：EXP-001.md, EXP-002.md（状态变更，内容未删除）
    
    ### 回滚方式
    如需撤销本次治理，执行：
    ```bash
    cp .workflow/context/experience/INDEX.md.bak .workflow/context/experience/INDEX.md
    ```
    ```
  - 状态：已完成（experience-curator Skill 中已包含统一的治理报告格式模板）

- [x] T10: 固化 experience-curator 的治理逻辑（依赖: T8, T9）
  - 修改: `.cursor/skills/experience-curator/SKILL.md`
  - 内容：确保治理逻辑执行稳定，触发条件明确
  - 状态：已完成（已在 experience-curator Skill 中明确触发条件和执行稳定性要求）

### 子任务 4：移除冗余的推进判据确认环节

- [x] T11: 修改 flow-router 的推进逻辑（依赖: T2, T3）
  - 修改: `.cursor/skills/flow-router/SKILL.md`
  - 修改: `.cursor/commands/flow.md`
  - 内容：用户选择 B 后，判据满足则直接进入下一阶段（判据作为告知信息）
  - 状态：已完成（已在 flow-router Skill 和 flow.md 中更新推进逻辑，移除冗余确认环节）

- [x] T12: 实现判据不满足时的处理逻辑（依赖: T11）
  - 修改: `.cursor/skills/flow-router/SKILL.md`
  - 内容：判据不满足时，展示未满足项，提供选项（强制推进 / 回退 / 继续本阶段）
  - 状态：已完成（已在 flow-router Skill 中实现判据不满足时的处理逻辑，提供强制推进/回退/继续本阶段的选项）

## 交付物（Deliverables）

- [x] 设计文档：`docs/02-design/gate-protocol.md`（可推进判据检查清单定义）
- [x] 设计文档：`docs/02-design/noise-filter.md`（沉淀过滤标准定义）
- [x] 更新的 Skills：flow-router、各阶段 Skills、experience-collector、experience-curator
- [x] 更新的文档：experience-governance.md、flow.md
- [x] 所有变更通过手工验证，符合成功标准（部分验证步骤需在后续实际使用中验证）

## 测试规格（Test Specifications）

### 可测试行为清单

| 行为ID | 行为描述 | 测试类型 |
|-------|---------|---------|
| B1 | 阶段切换时输出格式化的检查清单 | 手工验证 |
| B2 | experience-collector 能过滤明显噪音候选 | 手工验证 |
| B3 | experience-curator 输出统一格式的治理报告 | 手工验证 |
| B4 | 用户选择 B 后，判据满足则直接进入下一阶段 | 手工验证 |
| B5 | 判据不满足时，展示未满足项并提供选项 | 手工验证 |

### 手工验证步骤

| 步骤 | 操作 | 预期行为 |
|-----|-----|---------|
| 1 | 执行 `/flow REQ-004`，选择 B 进入 plan 阶段 | 判据满足则直接进入 plan，不再要求再次确认 |
| 2 | 创建一个明显噪音候选（如：临时调试记录） | experience-collector 自动过滤，并提供理由说明 |
| 3 | 触发经验治理（沉淀新经验后） | experience-curator 输出统一格式的治理报告 |
| 4 | 执行阶段切换，检查判据输出 | 输出格式化的检查清单，明确展示已满足/未满足项 |
| 5 | 模拟判据不满足的情况 | 展示未满足项，提供选项（强制推进 / 回退 / 继续本阶段） |

## 执行记录（Worklog）

- 2026-01-27: 创建 plan，拆解为 4 个子任务、12 个具体任务
- 2026-01-27: 根据 audit 反馈修正：明确 T4 执行顺序（先完成 T1，再逐个更新 Skills）、T5 判断规则（基于内容模式）、T9 格式模板（提供示例）
- 2026-01-27: 完成 T1 - 创建 `docs/02-design/gate-protocol.md`，定义各阶段的可推进判据检查清单（5 个阶段切换，每个包含 4-6 个可验证判据）
- 2026-01-27: 完成 T2/T3 - 在 flow-router Skill 中实现判据检查逻辑和统一输出格式（判据满足则直接进入，不满足则提供选项）
- 2026-01-27: 完成 T4 - 在 6 个阶段 Skill（req/plan/audit/work/review/archive）中添加可推进判据检查章节，引用 gate-protocol.md
- 2026-01-27: 完成 T5 - 创建 `docs/02-design/noise-filter.md`，定义 5 种明显噪音模式（结构缺失、步骤复现、无取舍依据、临时调试、过于具体）
- 2026-01-27: 完成 T6/T7 - 在 experience-collector 中实现噪音过滤器，应用 5 种判断模式，被过滤的候选记录明确理由
- 2026-01-27: 完成 T8 - 在 experience-governance.md 中明确合并/取代的触发条件（经验文件新增）和升级为规则的触发条件（Strength=enforced、问题反复出现、Capsule 可抽象）
- 2026-01-27: 完成 T9 - 确认 experience-curator Skill 中已包含统一的治理报告格式模板（执行动作/影响范围/回滚方式）
- 2026-01-27: 完成 T10 - 在 experience-curator Skill 中明确触发条件和执行稳定性要求（严格按照优先级、必须备份、统一格式、人工闸门）
- 2026-01-27: 完成 T11 - 在 flow-router Skill 和 flow.md 中更新推进逻辑，移除冗余确认环节（判据满足则直接进入，判据作为告知信息）
- 2026-01-27: 完成 T12 - 在 flow-router Skill 中实现判据不满足时的处理逻辑（展示未满足项，提供强制推进/回退/继续本阶段的选项）

## 复利候选（Compounding Candidates）

- [ ] （候选）可推进判据检查清单的设计模式可复用到其他需要"门控"的场景
- [ ] （候选）噪音过滤器的设计模式可复用到其他需要"质量过滤"的场景
- [ ] （候选）治理报告的统一格式可作为其他"变更报告"的模板
