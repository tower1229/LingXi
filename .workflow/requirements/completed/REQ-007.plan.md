# REQ-007 Plan

## 目标回放（1-3 行）

增强 `/flow` 命令的稳定性和可用性：支持三种使用模式（新需求/继续需求/空参数自动查找），优化 skill description 提升匹配率，移除"沉淀"和"质量准则"路径，添加 Fail Fast 机制。

## 状态摘要（Status Summary）

- **当前阶段**：review
- **进度**：7/8（T8 手工验证待新对话执行）
- **当前任务**：无
- **阻塞项**：无
- **上次更新**：2026-01-15

## 文件变更清单（Files to Change）

| 操作 | 文件路径 | 说明 |
|-----|---------|-----|
| 修改 | `.cursor/hooks/before-submit-prompt.mjs` | 移除空参数拦截，支持空参数模式 |
| 修改 | `.cursor/skills/flow-router/SKILL.md` | 优化 description、简化路由逻辑、添加 Fail Fast |
| 修改 | `.cursor/commands/flow.md` | 更新文档，只说明三种使用模式 |

## 任务清单（Tasks）

### Hook 层任务

- [x] T1: 修改 before-submit-prompt.mjs，移除空参数拦截（依赖: 无）
  - 修改: `.cursor/hooks/before-submit-prompt.mjs`
  - 移除第 29-35 行的空参数拦截逻辑
  - 保留 REQ-xxx 格式的 Fail Fast 检查（第 36-67 行）
  - 空参数时返回 `{ continue: true }` 让 Agent 处理

### Skill 层任务

- [x] T2: 优化 flow-router skill 的 frontmatter description（依赖: 无）
  - 修改: `.cursor/skills/flow-router/SKILL.md`
  - 优化 description 字段，明确触发条件
  - 强调"当用户输入 /flow 命令时激活"，提升匹配准确率
  - 明确只支持三种用法（新需求/继续需求/空参数自动查找）

- [x] T3: 实现空参数模式的路由逻辑（依赖: T2）
  - 修改: `.cursor/skills/flow-router/SKILL.md`
  - 在"输入解析"部分新增第 3 条路径：空参数自动查找
  - 定义行为：查询 INDEX.md，找出 Status != completed 的任务
  - 处理三种场景：0 个任务、1 个任务、多个任务

- [x] T4: 移除"沉淀"和"质量准则"路径（依赖: T2）
  - 修改: `.cursor/skills/flow-router/SKILL.md`
  - 删除"输入解析"中的第 3、4 条路径（沉淀确认路径、质量准则采纳路径）
  - 更新"关键原则"，反映简化后的命令职责

- [x] T5: 添加 Fail Fast 激活验证机制（依赖: T2, T3, T4）
  - 修改: `.cursor/skills/flow-router/SKILL.md`
  - 在 skill 开头添加"激活验证"部分
  - 定义自检指令：检查是否正确读取了 flow-router skill
  - 当检测到未按预期路由时，输出明确错误提示

- [x] T6: 添加不支持用法的拒绝和引导逻辑（依赖: T4）
  - 修改: `.cursor/skills/flow-router/SKILL.md`
  - 当用户输入 `/flow 沉淀`、`/flow 采纳质量准则` 等不支持的用法时
  - 输出明确提示："此用法已不再支持，请使用 /remember 命令进行经验沉淀"

### Command 层任务

- [x] T7: 更新 flow.md 文档（依赖: T2, T3, T4, T5, T6）
  - 修改: `.cursor/commands/flow.md`
  - 移除"沉淀"和"质量准则"相关使用说明
  - 明确只支持三种使用模式
  - 添加故障排查说明

### 测试任务（必选）

- [ ] T8: 手工验证所有使用模式（依赖: T1, T2, T3, T4, T5, T6, T7）
  - 验证 `/flow <描述>` 创建新需求
  - 验证 `/flow REQ-xxx` 继续已有需求
  - 验证 `/flow` 空参数自动查找
  - 验证 `/flow 沉淀` 被正确拒绝并引导
  - 验证复杂描述不会被误判

## 交付物（Deliverables）

- [x] 代码变更：before-submit-prompt.mjs 移除空参数拦截
- [x] Skill 更新：flow-router skill 优化（description + 路由逻辑 + Fail Fast）
- [x] 文档更新：flow.md 只说明三种使用模式
- [ ] 手工验证通过：所有使用模式符合验收标准

## 测试规格（Test Specifications）

### 可测试行为清单

| 行为ID | 行为描述 | 测试类型 |
|-------|---------|---------|
| B1 | `/flow <描述>` 进入 req 阶段 | 手工验证 |
| B2 | `/flow REQ-xxx` 正确识别状态并继续 | 手工验证 |
| B3 | `/flow` 空参数查找进行中任务 | 手工验证 |
| B4 | `/flow 沉淀` 被拒绝并引导使用 `/remember` | 手工验证 |
| B5 | 复杂描述不被误判为直接执行 | 手工验证 |

### 手工验证步骤

| 步骤 | 操作 | 预期行为 |
|-----|-----|---------|
| 1 | 输入 `/flow 实现用户登录` | 进入 req 阶段，创建 REQ-008 |
| 2 | 输入 `/flow 我想改造 flow command，增加空参数支持` | 进入 req 阶段，创建新 REQ（而非直接执行修改） |
| 3 | 输入 `/flow REQ-007` | 识别当前阶段并继续 |
| 4 | 输入 `/flow REQ-001`（已完成） | 提示"已完结" |
| 5 | 输入 `/flow REQ-999`（不存在） | 给出明确提示（由 Hook 拦截） |
| 6 | 输入 `/flow`（空参数，有 1 个进行中任务） | 自动继续该任务 |
| 7 | 输入 `/flow`（空参数，有多个进行中任务） | 展示列表让用户选择 |
| 8 | 输入 `/flow`（空参数，无进行中任务） | 提示"没有进行中的任务" |
| 9 | 输入 `/flow 沉淀 1,3` | 提示"此用法已不再支持，请使用 /remember" |
| 10 | 输入 `/flow 采纳质量准则 1` | 提示"此用法已不再支持" |

## 复利候选（Compounding Candidates）

- [ ] （候选）Cursor Hooks 的 `beforeSubmitPrompt` 无法修改 prompt 的技术限制（已在 REQ-007.md 中记录）
- [ ] （候选）命令职责简化原则：低频功能（沉淀/质量准则）应独立为专门命令
