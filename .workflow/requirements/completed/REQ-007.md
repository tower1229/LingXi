# REQ-007: 增强 /flow 命令的稳定性和可用性

| 属性     | 值                                   |
| -------- | ------------------------------------ |
| 版本     | 1.0                                  |
| 状态     | 草稿                                 |
| 创建日期 | 2026-01-15                           |
| 需求类型 | 全栈                                 |
| 复杂度   | 中等                                 |

---

## 1. 概述

### 1.1 背景

当前 `/flow` 命令的设计存在以下问题：

1. **触发不稳定**：命令的触发完全依赖 AI 主动判断和 skill description 匹配，当用户输入复杂描述时（如"我想改造 flow command..."），AI 可能误判为"直接执行修改"而非"走 workflow"
2. **缺少空参数模式**：Hook 脚本明确拦截了 `/flow` 空参数，无法支持"自动查找进行中任务"的用户需求
3. **路由机制不强制**：`.cursor/commands/flow.md` 只是说明文档，真正的执行逻辑在 skill 中，但 AI 需要"自己判断"是否读取和遵循 flow-router skill

这导致用户在使用 `/flow` 时体验不一致，有时能正确进入 workflow，有时则被 AI 误判为其他类型的任务。

### 1.2 问题描述

**当前设计的根本缺陷**：
- `/flow` 命令的触发依赖 AI 的语义理解和 skill 自动匹配
- 缺少有效的路由机制（注：Cursor Hooks 的 `beforeSubmitPrompt` 无法修改 prompt，因此无法通过 Hook 注入强制指令）
- 没有明确的"什么情况下必须走 workflow"的判据和 Fail Fast 检查

**具体表现**：
- 用户输入 `/flow <复杂描述>` 时，AI 可能直接执行修改而非进入 req 阶段
- 用户无法使用 `/flow` 空参数来自动继续进行中的任务
- 同样的命令在不同对话中可能有不同的行为

### 1.3 解决方案概述

通过三个层面的改进来增强 `/flow` 命令的稳定性：

1. **Hook 层增强**：
   - 移除空参数拦截，支持空参数模式
   - 实现空参数时自动查询进行中的任务并提供选择
   - 保持 REQ-xxx 格式的 Fail Fast 检查

2. **Skill 层优化**（核心改进）：
   - 优化 flow-router skill 的 description，提升匹配准确率
   - **简化路由逻辑**：明确 `/flow` 命令只支持三种用法（新需求/继续需求/自动查找），移除"沉淀"和"质量准则"路径
   - 在 flow-router skill 中明确三种模式的路由逻辑（新增空参数模式）
   - 添加 Fail Fast 机制，当未按预期路由时给出明确提示和自检指令

3. **Command 层完善**：
   - 更新 flow.md 文档，明确只支持三种使用模式
   - 强化"必须首先读取 flow-router skill"的说明
   - 添加故障排查说明

**设计原则**：
- `/flow` 命令专注于需求工作流（req → plan → audit → work → review → archive）
- 经验沉淀功能已迁移到 `/remember` 命令，模型会在适当时机自动展示候选经验供用户选择
- 质量准则采纳功能通过其他机制实现，不再通过 `/flow` 命令

**技术限制说明**：
- Cursor Hooks 的 `beforeSubmitPrompt` 在当前版本中无法修改 prompt（仅提供信息，不处理输出 JSON）
- 因此采用"优化 Skill Description + Fail Fast 检查"的组合方案，而非 Hook 注入指令

---

## 2. 目标与指标

### 2.1 目标

| 编号 | 目标                                                      | 优先级   |
| ---- | --------------------------------------------------------- | -------- |
| G1   | 支持三种 `/flow` 使用模式（新需求/继续需求/自动查找）    | 必须实现 |
| G2   | 通过优化 skill description 和 Fail Fast 机制，最大化 flow-router skill 的激活率 | 必须实现 |
| G3   | 当 workflow 未按预期触发时，给出明确的错误提示和修复建议 | 必须实现 |
| G4   | 保持向后兼容，不影响现有的 `/flow <描述>` 和 `/flow REQ-xxx` 用法 | 必须实现 |

### 2.2 非目标

> 明确列出"容易被误解为需求范围内，但实际不做"的内容。

- **不修改 workflow 的核心逻辑**（req → plan → audit → work → review → archive）
- **不改变人工闸门机制**（阶段推进仍需用户确认）
- **不自动推进任务**（空参数模式只是帮助用户选择任务，不会自动开始执行）
- **不支持 `/flow 沉淀` 用法**（经验沉淀功能已迁移到 `/remember` 命令，模型会在适当时机自动展示候选经验）
- **不支持 `/flow 采纳质量准则` 用法**（质量准则采纳通过其他机制实现）
- **不扩展 `/flow` 命令的功能范围**（只支持三种用法：新需求/继续需求/自动查找）

### 2.3 成功标准（必须可验证）

| 标准                  | 描述                                                             | 验证方式                                             |
| --------------------- | ---------------------------------------------------------------- | ---------------------------------------------------- |
| S1                    | `/flow <任意描述>` 稳定进入 req 阶段（通过优化 skill description 提升匹配率） | 测试多种描述格式，包括复杂的、长的、技术性的描述，统计激活率 |
| S2                    | `/flow REQ-xxx` 正确识别任务状态并继续                           | 测试已完成、进行中、不存在的 REQ                     |
| S3                    | `/flow` 空参数正确查找并展示进行中的任务                         | 测试 0 个、1 个、多个进行中任务的场景                |
| S4                    | flow-router skill 的 description 优化后，匹配准确率显著提升       | 对比优化前后的激活率，检查 AI 响应中是否包含 flow-router skill 的读取 |
| S5                    | 当 workflow 未按预期触发时，Fail Fast 机制给出明确错误提示和自检指令 | 人工测试并验证错误信息的清晰度和可操作性             |
| S6                    | `/flow 沉淀`、`/flow 采纳质量准则` 等不支持的用法被正确拒绝并引导使用正确命令 | 测试不支持的用法，验证是否给出明确提示并引导使用 `/remember` 等正确命令 |

---

## 3. 用户故事

### US-1: 创建新需求

**作为** 用户  
**我想要** 使用 `/flow <描述>` 创建新需求  
**以便** 无论我的描述多复杂，都能稳定进入 req 阶段而非被误判为其他任务

**验收标准：**

- [ ] `/flow 实现用户登录` 进入 req 阶段
- [ ] `/flow 我想改造 flow command，增加空参数支持` 进入 req 阶段
- [ ] `/flow 优化 skills-creator 和 rules-creator，添加创建日期元数据` 进入 req 阶段
- [ ] 所有情况下都创建序号递增的新需求文档（REQ-007, REQ-008, ...）

### US-2: 继续已有需求

**作为** 用户  
**我想要** 使用 `/flow REQ-xxx` 继续已有需求  
**以便** 系统能正确识别任务状态并从正确的阶段继续

**验收标准：**

- [ ] `/flow REQ-001`（已完成）提示"已完结"并结束对话
- [ ] `/flow REQ-007`（进行中）识别当前阶段并继续
- [ ] `/flow REQ-999`（不存在）给出明确提示

### US-3: 自动查找进行中任务

**作为** 用户  
**我想要** 使用 `/flow` 空参数自动查找进行中的任务  
**以便** 快速继续工作，无需手动记住任务编号

**验收标准：**

- [ ] 没有进行中任务时，提示"没有进行中的任务"并结束对话
- [ ] 只有 1 个进行中任务时，自动继续该任务
- [ ] 有多个进行中任务时，展示列表让用户选择

---

## 4. 功能需求

| 编号 | 需求描述                                                                 | 优先级   |
| ---- | ------------------------------------------------------------------------ | -------- |
| F1   | 修改 `before-submit-prompt.mjs`，移除空参数拦截                         | 必须实现 |
| F2   | 优化 flow-router skill 的 description，提升匹配准确率，明确只支持三种用法 | 必须实现 |
| F3   | 实现空参数模式的逻辑：查询 INDEX.md，找出 Status != completed 的任务    | 必须实现 |
| F4   | 在 flow-router skill 中移除"沉淀"和"质量准则"路径，只保留三种模式的路由逻辑 | 必须实现 |
| F5   | 添加 Fail Fast 机制，当路由失败或使用了不支持的用法时给出明确提示和自检指令 | 必须实现 |
| F6   | 更新 flow.md 文档，明确只支持三种使用模式，移除沉淀和质量准则相关说明 | 必须实现 |

---

## 5. 验收检查清单

- [ ] Hook 脚本支持三种模式（新需求/继续需求/自动查找）
- [ ] flow-router skill 的 description 已优化，明确触发条件和只支持三种用法
- [ ] flow-router skill 已移除"沉淀"和"质量准则"路径
- [ ] flow-router skill 包含 Fail Fast 激活验证机制
- [ ] 空参数模式正确处理 0 个、1 个、多个进行中任务的场景
- [ ] flow-router skill 明确三种模式的路由逻辑（含空参数模式）
- [ ] 当用户输入 `/flow 沉淀` 等不支持的用法时，给出明确提示并引导使用 `/remember`
- [ ] flow.md 文档明确只支持三种使用模式，移除沉淀和质量准则相关说明
- [ ] 所有使用模式都经过测试并符合验收标准
- [ ] 文档更新完整，包含使用说明和故障排查
- [ ] 向后兼容，现有的 `/flow <描述>` 和 `/flow REQ-xxx` 用法不受影响

---

## 6. 附录

### 6.1 当前实现分析

**Hook 脚本**（`before-submit-prompt.mjs`）：
- 第 29-35 行拦截了空参数
- 第 36-67 行处理 REQ-xxx 格式的 Fail Fast 检查
- **技术限制**：Cursor Hooks 的 `beforeSubmitPrompt` 在当前版本中无法修改 prompt（仅提供信息，不处理输出 JSON），因此无法通过 Hook 注入强制指令

**flow-router skill**：
- 当前定义了 4 种路径（新需求/继续需求/沉淀/质量准则）
- **需要移除**"沉淀"和"质量准则"路径，只保留三种核心用法
- 缺少空参数模式的路由逻辑
- description 可能不够精确，导致匹配不稳定
- 缺少 Fail Fast 激活验证机制

**flow.md command**：
- 当前说明了多种用法（包括 `/flow 沉淀`、`/flow 采纳质量准则` 等）
- **需要更新**为只说明三种用法（`/flow <描述>`、`/flow REQ-xxx`、`/flow` 空参数）
- 强调"必须首先读取并遵循 flow-router skill"，但说明不够强化，无 Fail Fast 检查

### 6.2 技术限制说明

**Cursor Hooks 的限制**：

根据 Cursor IDE 的官方文档和实际测试，`beforeSubmitPrompt` hook 在当前版本中存在以下限制：

1. **无法修改 prompt**：
   - `beforeSubmitPrompt` hook 主要是信息性的（informational）
   - Hook 脚本接收 JSON 输入（包含 prompt、conversation_id 等）
   - **但 Cursor 不处理或尊重脚本输出的任何 JSON**
   - 这意味着无法通过 Hook 修改 prompt 或影响 agent 的行为

2. **可用的 Hook 功能**：
   - Hook 可以返回 `continue: false` 来阻止执行
   - Hook 可以返回 `user_message` 来向用户展示消息
   - 但这些都无法直接修改 agent 的上下文或强制激活 skill

3. **影响**：
   - 原方案中"通过 Hook 注入强制指令"的设想在当前版本中不可行
   - 需要采用替代方案：优化 skill description + Fail Fast 机制

**参考来源**：
- Cursor IDE Hooks 文档（https://cursor.com/docs/agent/hooks）
- 社区反馈和实际测试验证

### 6.3 关键决策记录

| 决策点                     | 备选方案                                    | 最终选择             | 理由                                                         |
| -------------------------- | ------------------------------------------- | -------------------- | ------------------------------------------------------------ |
| 如何确保 skill 被激活      | A) 依赖 AI 匹配 / B) Hook 注入强制指令 / C) 优化 skill description + Fail Fast | C                    | B 方案不可行（Cursor Hooks 无法修改 prompt），A 方案不稳定，C 方案通过优化 description 提升匹配率，Fail Fast 提供兜底检查 |
| `/flow` 命令的功能范围      | A) 支持多种用法（包括沉淀/质量准则）/ B) 只支持三种核心用法 | B                    | 简化命令职责，沉淀功能已迁移到 `/remember`，模型会自动展示候选经验，质量准则通过其他机制实现 |
| 空参数如何选择任务         | A) 自动继续唯一任务 / B) 总是展示选择列表  | A（唯一时自动继续）  | 减少用户操作步骤，提升体验                                   |
| 多个进行中任务如何展示     | A) 按编号排序 / B) 按最后修改时间排序      | B                    | 用户更可能想继续最近操作的任务                               |
| 如何提升 skill 匹配率      | A) 优化 description / B) 强化 command 文档 / C) 添加 Fail Fast | A+B+C（组合方案）    | 多管齐下，description 优化是核心，command 文档强化提示，Fail Fast 提供兜底 |
| 是否兼容现有 `/flow` 用法  | A) 完全重构 / B) 增量增强                   | B                    | 保持向后兼容，现有的 `/flow <描述>` 和 `/flow REQ-xxx` 用法不受影响，但移除 `/flow 沉淀` 等用法 |

<!-- EXP-CANDIDATE {
  "stage": "req",
  "trigger": "当设计命令增强方案时，发现技术限制并明确命令职责边界",
  "decision": "采用优化 skill description + Fail Fast 机制，并简化 /flow 命令只支持三种核心用法",
  "alternatives": [
    "依赖 skill description 匹配（基础方案，但不够稳定）",
    "Hook 注入强制指令（不可行，Cursor Hooks 的 beforeSubmitPrompt 无法修改 prompt）",
    "保持 /flow 支持多种用法（包括沉淀/质量准则）"
  ],
  "signal": "用户报告 /flow 命令触发不稳定，复杂描述时 AI 误判。调研发现：1) Cursor Hooks 的 beforeSubmitPrompt 在当前版本中无法修改 prompt；2) /flow 命令职责过宽，沉淀功能应迁移到 /remember，模型会自动展示候选经验",
  "solution": "1) 优化 flow-router skill 的 description，明确触发条件和只支持三种用法；2) 移除 flow-router skill 中的'沉淀'和'质量准则'路径；3) 强化 flow.md command 文档，明确只支持三种用法；4) 在 flow-router skill 中添加 Fail Fast 激活验证机制",
  "verify": "测试多种描述格式，对比优化前后的激活率，验证 Fail Fast 机制的有效性，确认 /flow 沉淀 等用法被正确拒绝并引导使用 /remember",
  "pointers": [".cursor/skills/flow-router/SKILL.md", ".cursor/commands/flow.md", ".cursor/commands/remember.md"],
  "notes": "这是一个从'依赖 AI 自主判断'到'通过优化 skill description 和 Fail Fast 机制提升稳定性'的设计转变，同时简化命令职责边界。受限于 Cursor Hooks 的技术限制，无法实现 100% 强制激活，但可以通过多管齐下的方式最大化激活率。命令职责的简化有助于提升可维护性和用户体验的一致性。"
} -->
