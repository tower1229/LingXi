# REQ-005 Plan: Phase B（P0）：价值取向捕获（可行性与实施方案）

## 目标回放（1-3 行）

实现 Phase B（P0）价值取向捕获：定义 Trade-off Record 与 Semantics Capsule 结构，在阶段输出中引导捕获取舍依据与业务语义，并在阶段开始前全量回放上一阶段候选，提升价值判断的即时性。保持与 Phase A 机制兼容，不破坏确认式沉淀闸门。

## 状态摘要（Status Summary）

- **当前阶段**：work
- **进度**：13/13 + 重构完成
- **当前任务**：所有任务已完成，已重构为符合 Agent Skills 规范（自包含、one level deep）
- **阻塞项**：无
- **上次更新**：2026-01-14

## 文件变更清单（Files to Change）

| 操作 | 文件路径 | 说明 |
|-----|---------|-----|
| 创建 | `.cursor/skills/flow-router/references/trade-off-record.md` | Trade-off Record 结构定义文档 |
| 创建 | `.cursor/skills/flow-router/references/gate-protocol.md` | 闸门协议（可推进判据检查清单） |
| 创建 | `.cursor/skills/flow-router/references/semantics-capsule.md` | Semantics Capsule 结构定义文档 |
| 创建 | `.cursor/skills/*/references/trade-off-record.md` | Trade-off Record（复制到 req/plan/audit/work/review） |
| 创建 | `.cursor/skills/*/references/gate-protocol.md` | Gate Protocol（复制到 req/plan/audit/work/review/archive） |
| 创建 | `.cursor/agents/references/noise-filter.md` | 沉淀过滤标准（Noise Filter） |
| 修改 | `.cursor/skills/req/SKILL.md` | 添加 Trade-off Record 输出要求 |
| 修改 | `.cursor/skills/plan/SKILL.md` | 添加 Trade-off Record 输出要求 |
| 修改 | `.cursor/skills/audit/SKILL.md` | 添加 Trade-off Record 输出要求 |
| 修改 | `.cursor/skills/work/SKILL.md` | 添加 Trade-off Record 输出要求 |
| 修改 | `.cursor/skills/review/SKILL.md` | 添加 Trade-off Record 输出要求 |
| 修改 | `.cursor/skills/flow-router/SKILL.md` | 添加阶段开始前候选全量回放逻辑、req→plan 时 REQ 文档候选提取逻辑 |
| 修改 | `.cursor/agents/experience-collector.md` | 明确候选暂存时标记来源阶段，支持按阶段过滤 |
| 修改 | `.cursor/commands/flow.md` | 更新阶段开始前候选回放流程说明 |
| 创建 | `.cursor/skills/*/references/trade-off-record.md` | Trade-off Record（复制到 flow-router/req/plan/audit/work/review） |
| 创建 | `.cursor/skills/*/references/gate-protocol.md` | Gate Protocol（复制到 flow-router/req/plan/audit/work/review/archive） |
| 创建 | `.cursor/skills/flow-router/references/semantics-capsule.md` | Semantics Capsule |
| 创建 | `.cursor/agents/references/noise-filter.md` | Noise Filter |

## 任务清单（Tasks）

### 子任务 1：定义 Trade-off Record 结构

- [x] T1: 创建 Trade-off Record 结构定义文档（依赖: 无）
  - 创建: `.cursor/skills/flow-router/references/trade-off-record.md`（并复制到 req/plan/audit/work/review）
  - 内容：
    - 最小字段定义：决策点、备选方案（含 rejected）、拒绝理由、接受的风险、影响范围、回滚线索
    - 与 EXP-CANDIDATE 的映射关系（如何转写为 Decision Shape / Judgment Capsule）
    - 输出时机：何时应输出 Trade-off Record（关键取舍、风险接受、拒绝方案）
    - 精简原则：指针优先，详细内容以指针承载
    - **候选全量展示格式模板**：定义阶段开始前回放候选时的展示格式（表格/列表），确保一致性，至少包含 trigger/decision/signal/solution/verify/pointers 等摘要字段
  - 状态：已完成

### 子任务 2：定义 Semantics Capsule 结构

- [x] T2: 创建 Semantics Capsule 结构定义文档（依赖: 无）
  - 创建: `.cursor/skills/flow-router/references/semantics-capsule.md`
  - 内容：
    - 最小字段定义：条目类型（边界/规则/术语）、条目内容、关联指针、适用范围
    - 与经验（判断资产）的区分：语义资产 vs 判断资产的生命周期与治理方式
    - 写入位置：长期上下文（`.workflow/context/business/`）vs 经验库（`.workflow/context/experience/`）
    - 抽取时机：req/plan 阶段从需求中识别业务语义
    - **SEM-CANDIDATE JSON 格式定义**：用于从 REQ 文档提取语义候选时的结构化格式，字段包括：`type`（边界/规则/术语）、`content`、`pointers`、`scope`、`source`（来源 REQ id）
  - 状态：已完成

### 子任务 3：在阶段指引中加入 Trade-off Record 输出要求

- [x] T3: 在 req Skill 中添加 Trade-off Record 输出要求（依赖: T1）
  - 修改: `.cursor/skills/req/SKILL.md`
  - 内容：在"经验候选捕获"章节后添加"Trade-off Record 输出"章节，说明何时应输出 Trade-off Record
  - 状态：已完成

- [x] T4: 在 plan Skill 中添加 Trade-off Record 输出要求（依赖: T1）
  - 修改: `.cursor/skills/plan/SKILL.md`
  - 内容：在任务拆解或关键决策点处，引导输出 Trade-off Record
  - 状态：已完成

- [x] T5: 在 audit Skill 中添加 Trade-off Record 输出要求（依赖: T1）
  - 修改: `.cursor/skills/audit/SKILL.md`
  - 内容：在技术风险评估或方案取舍处，引导输出 Trade-off Record
  - 状态：已完成

- [x] T6: 在 work Skill 中添加 Trade-off Record 输出要求（依赖: T1）
  - 修改: `.cursor/skills/work/SKILL.md`
  - 内容：在实现过程中的关键取舍处，引导输出 Trade-off Record
  - 状态：已完成

- [x] T7: 在 review Skill 中添加 Trade-off Record 输出要求（依赖: T1）
  - 修改: `.cursor/skills/review/SKILL.md`
  - 内容：在审查结论或取舍判断处，引导输出 Trade-off Record
  - 状态：已完成

### 子任务 4：实现 REQ 文档候选提取

- [x] T8: 在 req→plan 推进时添加 REQ 文档候选提取逻辑（依赖: T1, T2）
  - 修改: `.cursor/skills/flow-router/SKILL.md`（**明确在 flow-router 中实现，而非 req Skill**）
  - 内容：
    - **触发位置**：在 flow-router 的 `req→plan` 判据检查后、进入 plan 前执行（判据满足时）
    - 读取 `.workflow/requirements/in-progress/REQ-xxx.md`
    - 提取高信号片段：非目标、关键决策记录、风险与对策、验收口径背后的判断、业务边界/规则/术语
    - 生成 EXP-CANDIDATE（经验候选，使用 T1 定义的格式）和 SEM-CANDIDATE（语义候选，使用 T2 定义的 JSON 格式），交给 experience-collector 暂存
    - 静默处理，不打断推进（符合静默成功原则）
  - 状态：已完成

### 子任务 5：实现阶段开始前候选全量回放

- [x] T9: 在 flow-router 中添加阶段开始前候选回放逻辑（依赖: T1）
  - 修改: `.cursor/skills/flow-router/SKILL.md`
  - 内容：
    - 在进入任一阶段前（如 plan/audit/work/review/archive），检查 `session/pending-compounding-candidates.json`
    - 筛选 `sourceStage`=上一阶段的候选（已通过噪音过滤 + 成长过滤器）
    - **全量展示格式**：使用 `references/trade-off-record.md` 定义的展示格式模板，每条候选至少包含 trigger/decision/signal/solution/verify/pointers 等摘要字段（按时间倒序排列，最新优先）
    - **去重策略**：若同一阶段产生多条相似候选（trigger/decision 高度相似），仅展示最新一条
    - 提供选项：A) 现在沉淀（进入 `/flow 沉淀` 流程） / B) 稍后再说（继续进入当前阶段） / C) 忽略这批（标记忽略）
    - 展示不等于写入，写入仍必须走 `/flow 沉淀` 确认式闸门
  - 状态：已完成

- [x] T10: 在 experience-collector 中标记候选来源阶段（依赖: 无）
  - 修改: `.cursor/agents/experience-collector.md`
  - 内容：
    - **字段统一**：确保暂存候选时记录 `sourceStage` 字段（统一使用 `sourceStage`，不再使用 `stage` 作为来源标识）
    - 保留 `stage` 字段用于标识候选本身的阶段（如 work/plan），`sourceStage` 用于标识候选来源阶段（用于阶段回放过滤）
    - 支持按 `sourceStage` 过滤，用于阶段开始前的候选回放
    - **噪音过滤器引用**：使用 `references/noise-filter.md`（符合 Agent Skills 规范，自包含）
  - 状态：已完成

- [x] T11: 更新 flow.md 说明候选回放流程（依赖: T9）
  - 修改: `.cursor/commands/flow.md`
  - 内容：在"阶段路由"章节说明阶段开始前的候选回放机制
  - 状态：已完成

### 子任务 6：验证与兼容性检查

- [x] T12: 定义验证清单（依赖: T1-T11）
  - 创建/更新: `REQ-005.plan.md` 的"测试规格"章节
  - 内容：覆盖 S1-S5 的手工验证步骤（已在 plan 中定义）
  - 状态：已完成

- [x] T13: 兼容性检查：确保不破坏 Phase A 机制（依赖: T1-T11）
  - 检查项：
    - 单入口 `/flow` 保持不变 ✅
    - 人工闸门（阶段推进需用户确认）保持不变 ✅
    - 静默成功原则（成功时不输出冗余信息）保持不变 ✅
    - 确认式沉淀（`/flow 沉淀` 才写入 experience）保持不变 ✅
    - 噪音过滤与成长过滤器继续生效 ✅
    - 治理策略（experience-curator）继续生效 ✅
  - 状态：已完成（所有检查项均满足）

## 交付物（Deliverables）

- [x] 设计文档：`.cursor/skills/flow-router/references/trade-off-record.md`（Trade-off Record 结构定义，并复制到 req/plan/audit/work/review）
- [x] 设计文档：`.cursor/skills/flow-router/references/gate-protocol.md`（闸门协议，并复制到 req/plan/audit/work/review/archive）
- [x] 设计文档：`.cursor/skills/flow-router/references/semantics-capsule.md`（Semantics Capsule 结构定义）
- [x] 设计文档：`.cursor/agents/references/noise-filter.md`（噪音过滤器）
- [x] 重构完成：删除 workflow-core Skill，所有引用改为相对路径（符合 Agent Skills 规范）
- [x] 更新的 Skills：req、plan、audit、work、review（添加 Trade-off Record 输出要求）
- [x] 更新的 flow-router Skill（添加阶段开始前候选全量回放）
- [x] 更新的 experience-collector Agent（标记来源阶段）
- [x] 更新的文档：flow.md（候选回放流程说明）
- [ ] 所有变更通过手工验证，符合成功标准 S1-S5（需在后续实际使用中验证）

## 测试规格（Test Specifications）

### 可测试行为清单

| 行为ID | 行为描述 | 测试类型 |
|-------|---------|---------|
| B1 | 在 plan/audit/work 阶段出现关键取舍时，输出 Trade-off Record | 手工验证 |
| B2 | 在 req 阶段抽取至少 3 条业务语义条目（边界/规则/术语） | 手工验证 |
| B3 | req→plan 时从 REQ 文档提取候选并暂存（不打断推进） | 手工验证 |
| B4 | 进入任一阶段前，全量回放上一阶段通过过滤的候选 | 手工验证 |
| B5 | 候选全量展示后，不自动写入 experience（仍需 `/flow 沉淀`） | 手工验证 |
| B6 | 经验沉淀仍遵循确认式：未明确 `/flow 沉淀` 不写入 experience | 手工验证 |

### 手工验证步骤

| 步骤 | 操作 | 预期行为 |
|-----|-----|---------|
| 1 | 在 plan 阶段制造一个关键取舍（如方案 A vs B），检查是否输出 Trade-off Record | 输出结构化的 Trade-off Record，包含决策点、备选方案、拒绝理由 |
| 2 | 在 req 阶段创建一个包含业务边界/规则/术语的需求，检查是否抽取语义条目 | 至少抽取 3 条语义条目，形成 Semantics Capsule 形态 |
| 3 | 完成 req 阶段，选择 B 进入 plan，检查是否从 REQ 文档提取候选 | 静默提取候选并暂存，不打断推进，候选可通过 experience-collector 过滤 |
| 4 | 在 req 阶段产生 2 条候选（通过过滤），选择 B 进入 plan，检查是否全量回放 | 进入 plan 前全量展示 2 条候选（至少包含 trigger/decision/signal/solution/verify/pointers），提供选项 |
| 5 | 在候选全量展示后，选择 B（稍后再说），检查是否自动写入 experience | 不写入 experience，继续进入 plan 阶段 |
| 6 | 在候选全量展示后，选择 A（现在沉淀），检查是否进入 `/flow 沉淀` 流程 | 进入沉淀确认流程，用户可选择沉淀哪些候选 |
| 7 | 观察整个流程，检查是否破坏 Phase A 机制（单入口/人工闸门/静默成功/确认式沉淀） | 所有 Phase A 机制保持不变 |

## 执行记录（Worklog）

- 2026-01-14: 创建 plan，拆解为 6 个子任务、13 个具体任务
- 2026-01-14: 根据 audit 建议修正 4 项：T8 触发位置明确（flow-router）、T9 展示格式定义（依赖 T1）、T10 字段统一（sourceStage）、T2 补充 SEM-CANDIDATE JSON 格式
- 2026-01-14: 完成 T1-T2（定义 Trade-off Record 和 Semantics Capsule 结构）
- 2026-01-14: 完成 T3-T7（在 req/plan/audit/work/review Skill 中添加 Trade-off Record 输出要求）
- 2026-01-14: 完成 T8（在 flow-router 中实现 REQ 文档候选提取）
- 2026-01-14: 完成 T9-T11（实现阶段开始前候选全量回放）
- 2026-01-14: 完成 T12-T13（验证清单和兼容性检查）
- 2026-01-14: 重构完成：将所有设计文档从 `docs/02-design/` 迁移到各 Skills 的 `references/` 目录，删除 workflow-core Skill，更新所有引用路径为相对路径（`references/xxx.md`），符合 Agent Skills 规范（自包含、one level deep、不跨 Skill 引用）

## 复利候选（Compounding Candidates）

- [ ] （候选）Trade-off Record 的设计模式可复用到其他需要"显式捕获取舍依据"的场景
- [ ] （候选）Semantics Capsule 的设计模式可复用到其他需要"业务语义抽象"的场景
- [ ] （候选）阶段开始前候选回放的机制可复用到其他需要"即时价值判断"的场景
- [ ] （候选）从 REQ 文档提取候选的机制可复用到其他需要"从结构化文档提取知识"的场景
