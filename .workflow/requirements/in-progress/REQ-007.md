# REQ-007: 增强 /flow 命令的稳定性和可用性

| 属性     | 值                                   |
| -------- | ------------------------------------ |
| 版本     | 1.0                                  |
| 状态     | 草稿                                 |
| 创建日期 | 2026-01-15                           |
| 需求类型 | 全栈                                 |
| 复杂度   | 中等                                 |

---

## 1. 概述

### 1.1 背景

当前 `/flow` 命令的设计存在以下问题：

1. **触发不稳定**：命令的触发完全依赖 AI 主动判断和 skill description 匹配，当用户输入复杂描述时（如"我想改造 flow command..."），AI 可能误判为"直接执行修改"而非"走 workflow"
2. **缺少空参数模式**：Hook 脚本明确拦截了 `/flow` 空参数，无法支持"自动查找进行中任务"的用户需求
3. **路由机制不强制**：`.cursor/commands/flow.md` 只是说明文档，真正的执行逻辑在 skill 中，但 AI 需要"自己判断"是否读取和遵循 flow-router skill

这导致用户在使用 `/flow` 时体验不一致，有时能正确进入 workflow，有时则被 AI 误判为其他类型的任务。

### 1.2 问题描述

**当前设计的根本缺陷**：
- `/flow` 命令的触发依赖 AI 的语义理解和 skill 自动匹配
- 缺少强制性的路由机制（如 Hook 注入指令）
- 没有明确的"什么情况下必须走 workflow"的判据

**具体表现**：
- 用户输入 `/flow <复杂描述>` 时，AI 可能直接执行修改而非进入 req 阶段
- 用户无法使用 `/flow` 空参数来自动继续进行中的任务
- 同样的命令在不同对话中可能有不同的行为

### 1.3 解决方案概述

通过三个层面的改进来增强 `/flow` 命令的稳定性：

1. **Hook 层增强**：
   - 支持三种使用模式（新需求/继续需求/自动查找）
   - 在检测到 `/flow` 时注入强制指令，确保 flow-router skill 被激活
   - 空参数时自动查询进行中的任务并提供选择

2. **Skill 层优化**：
   - 在 flow-router skill 中明确三种模式的路由逻辑
   - 添加 Fail Fast 机制，当未按预期路由时给出明确提示

3. **Command 层完善**：
   - 更新 flow.md 文档，说明三种使用模式
   - 添加故障排查说明

---

## 2. 目标与指标

### 2.1 目标

| 编号 | 目标                                                      | 优先级   |
| ---- | --------------------------------------------------------- | -------- |
| G1   | 支持三种 `/flow` 使用模式（新需求/继续需求/自动查找）    | 必须实现 |
| G2   | 确保 `/flow` 命令 100% 触发 flow-router skill             | 必须实现 |
| G3   | 当 workflow 未按预期触发时，给出明确的错误提示和修复建议 | 必须实现 |
| G4   | 保持向后兼容，不影响现有的 `/flow <描述>` 和 `/flow REQ-xxx` 用法 | 必须实现 |

### 2.2 非目标

> 明确列出"容易被误解为需求范围内，但实际不做"的内容。

- **不修改 workflow 的核心逻辑**（req → plan → audit → work → review → archive）
- **不改变人工闸门机制**（阶段推进仍需用户确认）
- **不自动推进任务**（空参数模式只是帮助用户选择任务，不会自动开始执行）
- **不修改经验沉淀机制**（仍需用户通过 `/flow 沉淀` 确认）

### 2.3 成功标准（必须可验证）

| 标准                  | 描述                                                             | 验证方式                                             |
| --------------------- | ---------------------------------------------------------------- | ---------------------------------------------------- |
| S1                    | `/flow <任意描述>` 100% 进入 req 阶段                            | 测试多种描述格式，包括复杂的、长的、技术性的描述    |
| S2                    | `/flow REQ-xxx` 正确识别任务状态并继续                           | 测试已完成、进行中、不存在的 REQ                     |
| S3                    | `/flow` 空参数正确查找并展示进行中的任务                         | 测试 0 个、1 个、多个进行中任务的场景                |
| S4                    | Hook 注入的强制指令确保 flow-router skill 被激活                 | 检查 AI 的响应中是否包含 flow-router skill 的读取    |
| S5                    | 当 workflow 未按预期触发时，给出明确错误提示                     | 人工测试并验证错误信息的清晰度                       |

---

## 3. 用户故事

### US-1: 创建新需求

**作为** 用户  
**我想要** 使用 `/flow <描述>` 创建新需求  
**以便** 无论我的描述多复杂，都能稳定进入 req 阶段而非被误判为其他任务

**验收标准：**

- [ ] `/flow 实现用户登录` 进入 req 阶段
- [ ] `/flow 我想改造 flow command，增加空参数支持` 进入 req 阶段
- [ ] `/flow 优化 skills-creator 和 rules-creator，添加创建日期元数据` 进入 req 阶段
- [ ] 所有情况下都创建序号递增的新需求文档（REQ-007, REQ-008, ...）

### US-2: 继续已有需求

**作为** 用户  
**我想要** 使用 `/flow REQ-xxx` 继续已有需求  
**以便** 系统能正确识别任务状态并从正确的阶段继续

**验收标准：**

- [ ] `/flow REQ-001`（已完成）提示"已完结"并结束对话
- [ ] `/flow REQ-007`（进行中）识别当前阶段并继续
- [ ] `/flow REQ-999`（不存在）给出明确提示

### US-3: 自动查找进行中任务

**作为** 用户  
**我想要** 使用 `/flow` 空参数自动查找进行中的任务  
**以便** 快速继续工作，无需手动记住任务编号

**验收标准：**

- [ ] 没有进行中任务时，提示"没有进行中的任务"并结束对话
- [ ] 只有 1 个进行中任务时，自动继续该任务
- [ ] 有多个进行中任务时，展示列表让用户选择

---

## 4. 功能需求

| 编号 | 需求描述                                                                 | 优先级   |
| ---- | ------------------------------------------------------------------------ | -------- |
| F1   | 修改 `before-submit-prompt.mjs`，移除空参数拦截                         | 必须实现 |
| F2   | 在 Hook 中注入强制指令，确保 flow-router skill 被激活                    | 必须实现 |
| F3   | 实现空参数模式的逻辑：查询 INDEX.md，找出 Status != completed 的任务    | 必须实现 |
| F4   | 优化 flow-router skill，明确三种模式的路由逻辑                           | 必须实现 |
| F5   | 添加 Fail Fast 机制，当路由失败时给出明确提示                            | 必须实现 |
| F6   | 更新 flow.md 文档，说明三种使用模式和故障排查                            | 必须实现 |

---

## 5. 验收检查清单

- [ ] Hook 脚本支持三种模式（新需求/继续需求/自动查找）
- [ ] Hook 注入的强制指令确保 flow-router skill 被激活
- [ ] 空参数模式正确处理 0 个、1 个、多个进行中任务的场景
- [ ] flow-router skill 明确三种模式的路由逻辑
- [ ] 所有使用模式都经过测试并符合验收标准
- [ ] 文档更新完整，包含使用说明和故障排查
- [ ] 向后兼容，现有用法不受影响

---

## 6. 附录

### 6.1 当前实现分析

**Hook 脚本**（`before-submit-prompt.mjs`）：
- 第 29-35 行拦截了空参数
- 第 36-67 行处理 REQ-xxx 格式的 Fail Fast 检查
- 未注入任何强制指令到 prompt

**flow-router skill**：
- 定义了 4 种路径（新需求/继续需求/沉淀/质量准则）
- 缺少空参数模式的路由逻辑
- 依赖 AI 自动匹配激活，无强制性

**flow.md command**：
- 只说明了两种用法（`/flow <描述>` 和 `/flow REQ-xxx`）
- 强调"必须首先读取并遵循 flow-router skill"，但无强制机制

### 6.2 关键决策记录

| 决策点                     | 备选方案                                    | 最终选择             | 理由                                                         |
| -------------------------- | ------------------------------------------- | -------------------- | ------------------------------------------------------------ |
| 如何确保 skill 被激活      | A) 依赖 AI 匹配 / B) Hook 注入强制指令      | B                    | Hook 注入可以 100% 确保，A 方案已被证明不稳定                |
| 空参数如何选择任务         | A) 自动继续唯一任务 / B) 总是展示选择列表  | A（唯一时自动继续）  | 减少用户操作步骤，提升体验                                   |
| 多个进行中任务如何展示     | A) 按编号排序 / B) 按最后修改时间排序      | B                    | 用户更可能想继续最近操作的任务                               |
| Hook 注入指令的位置        | A) 追加到用户 prompt / B) 通过系统消息注入 | A                    | Cursor Hook 机制支持修改 prompt，系统消息需要模型支持        |
| 是否兼容现有 `/flow` 用法  | A) 完全重构 / B) 增量增强                   | B                    | 保持向后兼容，降低风险，避免影响已有用户                     |

<!-- EXP-CANDIDATE {
  "stage": "req",
  "trigger": "当设计命令增强方案时",
  "decision": "通过 Hook 注入强制指令而非依赖 AI 匹配",
  "alternatives": ["依赖 skill description 匹配（放弃，因为已被证明不稳定）"],
  "signal": "用户报告 /flow 命令触发不稳定，复杂描述时 AI 误判",
  "solution": "在 Hook 脚本中检测到 /flow 时注入强制指令，确保 flow-router skill 被激活",
  "verify": "测试多种描述格式，验证 100% 进入 workflow",
  "pointers": [".cursor/hooks/before-submit-prompt.mjs", ".cursor/skills/flow-router/SKILL.md"],
  "notes": "这是一个从'依赖 AI 自主判断'到'通过工程手段强制路由'的设计转变"
} -->
