# REQ-001 Plan: 经验成长机制

## 状态摘要（Status Summary）

| 属性     | 值         |
| -------- | ---------- |
| 版本     | 1.0        |
| 状态     | planned    |
| 创建日期 | 2026-01-12 |
| 关联需求 | REQ-001    |

---

## 设计决策（Design Decisions）

### D1: 经验索引字段扩展

**现状**：`Tag | Title | Trigger | Status | File`

**扩展方案**（新增字段放表尾，保持向后兼容）：

```markdown
| Tag | Title | Trigger | Status | Scope | Strength | Replaces | ReplacedBy | File |
```

| 字段         | 类型                                    | 说明                                                                       |
| ------------ | --------------------------------------- | -------------------------------------------------------------------------- |
| `Scope`      | `narrow` / `medium` / `broad`           | 经验适用范围：narrow=单一场景，medium=同类问题，broad=跨场景通用           |
| `Strength`   | `hypothesis` / `validated` / `enforced` | 经验强度：hypothesis=首次总结，validated=多次验证，enforced=已转为自动拦截 |
| `Replaces`   | 逗号分隔的 Tag 列表                     | 本经验取代了哪些旧经验（谱系链：新 → 旧）                                  |
| `ReplacedBy` | Tag                                     | 本经验被哪条新经验取代（谱系链：旧 → 新）                                  |

**兼容性**：

- 现有解析只读前 5 列的代码仍可正常工作
- 新字段为可选，空值不影响检索

---

### D2: 合并/取代判断规则

**判断优先级**（从高到低）：

1. **精确匹配**：Tag 相同 → 必定是同一主题，检查是否应合并/取代
2. **Trigger 关键词重叠 ≥ 60%**：高度相似，建议合并
3. **语义相似**（备用）：当关键词匹配不足时，用语义相似度辅助（暂不实现，先走规则）

**合并规则**：

- 两条经验 Trigger/解决方案高度重复 → 合并为 1 条，Scope 取更 broad，旧经验 Status = `deprecated`，新经验 `Replaces` 写入旧 Tag

**取代规则**：

- 新经验是旧经验的"升级版"（更普适/更准确/更完整）→ 旧经验 Status = `deprecated`，`ReplacedBy` 指向新 Tag；新经验 `Replaces` 指向旧 Tag

---

### D3: 审美建议采纳入口

**交互格式**（扩展 `/flow`）：

```text
/flow 采纳审美 <序号列表>   # 例如 /flow 采纳审美 1,3
/flow 忽略审美             # 全部不采纳
```

**落盘目标**（按建议类型）：

- 风险偏好/红线 → `.cursor/rules/` 新增或追加
- 流程/检查清单 → `.cursor/skills/` 新增或追加
- 质量标准 → `.workflow/context/tech/quality-bar.md`（新建）

**人工闸门**：采纳动作需用户显式执行 `/flow 采纳审美`，否则不落盘。

---

### D4: 回滚机制

**最小可行方案**：

1. 每次自动执行治理前，把当前 `experience/INDEX.md` 复制到 `experience/INDEX.md.bak`
2. 变更报告输出"回滚命令"：`cp .workflow/context/experience/INDEX.md.bak .workflow/context/experience/INDEX.md`
3. 如有文件合并/删除，输出涉及文件列表 + git 恢复提示（`git checkout -- <file>`）

**约束**：不自动删除经验文件，只做 Status = `deprecated` 标记。

---

### D5: 成长循环触发流程

**触发点**：`/flow 沉淀 ...` 成功写入至少 1 条新经验后，自动执行以下步骤：

```
1. 读取 experience/INDEX.md 全部 active 经验
2. 对新经验与现有经验做"合并/取代判断"（D2 规则）
3. 自动执行治理动作：
   - 合并：更新 INDEX（Replaces/ReplacedBy/Status），输出变更报告
   - 取代：更新 INDEX，输出变更报告
4. 生成"技术审美/直觉建议"（1-3 条），等待用户 /flow 采纳审美
```

---

## 任务拆解（Tasks）

| #   | 任务                                                                       | 优先级 | 依赖 | 状态 |
| --- | -------------------------------------------------------------------------- | ------ | ---- | ---- |
| T1  | 扩展 `experience/INDEX.md` 表头（新增 Scope/Strength/Replaces/ReplacedBy） | P0     | -    | [x]  |
| T2  | 更新 `experience-index` Skill：解析新字段、过滤 deprecated                 | P0     | T1   | [x]  |
| T3  | 新建 `experience-curator` Skill：实现合并/取代判断 + 自动执行 + 变更报告   | P0     | T1   | [x]  |
| T4  | 更新 `experience-depositor` Skill：沉淀后自动调用 `experience-curator`     | P0     | T3   | [x]  |
| T5  | 扩展 `/flow` 命令：支持 `采纳审美 / 忽略审美`                              | P1     | T3   | [x]  |
| T6  | 新建 `.workflow/context/tech/quality-bar.md`（技术审美落盘目标）           | P1     | T5   | [x]  |
| T7  | 更新 README：说明成长机制与命令格式                                        | P2     | T5   | [x]  |

---

## 验证清单（Validation）

| #   | 验证项                            | 预期结果                                          | 验证方式                    |
| --- | --------------------------------- | ------------------------------------------------- | --------------------------- |
| V1  | 沉淀 1 条新经验后触发成长循环     | 输出治理报告 + 审美建议                           | 手工执行 `/flow 沉淀 1`     |
| V2  | 新经验与旧经验 Tag 相同时自动合并 | INDEX 更新 Replaces/ReplacedBy，旧经验 deprecated | 手工构造重复经验            |
| V3  | 审美建议可采纳/拒绝               | 采纳后落盘到 rules/skills/quality-bar；拒绝不落盘 | 手工执行 `/flow 采纳审美 1` |
| V4  | 回滚可执行                        | 执行 cp 命令后 INDEX 恢复                         | 手工执行回滚命令            |

---

## 工作日志（Worklog）

| 时间       | 事件                                          |
| ---------- | --------------------------------------------- |
| 2026-01-12 | 创建 plan，完成设计决策 D1-D5、任务拆解 T1-T7 |
| 2026-01-12 | T1-T7 全部完成，进入 review                   |
| 2026-01-12 | Review 通过（V1-V4 全部 Pass），进入 compound |
| 2026-01-12 | Compound 完成，需求关闭                       |

---

## 复利候选（Compounding Candidates）

- （候选）INDEX 字段扩展模式（Scope/Strength/Replaces/ReplacedBy）可作为"通用索引扩展范式"沉淀
- （候选）合并/取代判断规则（关键词重叠 ≥ 60%）可作为"经验治理规则"沉淀
