---
description: "Skill: Experience Depositor (ai/context/experience/* + index)"
globs:
  - "ai/context/experience/**"
  - "ai/context/tech/services/**"
alwaysApply: true
---

# Skill：Experience Depositor（复利沉淀）

## 目标

把"过程中的坑/隐性约束/排查结论"沉淀为下次可复用资产，并维护索引。

## 经验沉淀模板（必须包含）

每条经验文件：`ai/context/experience/<tag>-<title>.md`

```markdown
# <Title>

## 触发条件（When to load）
- ...

## 问题现象（Symptom）
- ...

## 根因（Root cause）
- ...

## 解决方案（Fix）
- ...

## 校验方式（How to verify）
- ...

## 关联指针（Pointers）
- `path/to/file`：说明看什么

## 替代关系（Replaced by / Replaces）（可选）
- **被替代**：此经验已被 `ai/context/experience/<tag>-<new-title>.md` 替代
- **替代**：此经验替代了 `ai/context/experience/<tag>-<old-title>.md`
```

并更新 `ai/context/experience/INDEX.md`：

| Tag | Title | Trigger (when to load) | Status | File |
|---|---|---|---|---|
| tag | Title | Trigger | active/deprecated | `ai/context/experience/<tag>-<title>.md` |

**Status 字段说明：**
- `active`：当前有效经验（默认）
- `deprecated`：已被替代的旧经验（保留用于历史追溯，但检索时会被过滤）

## 经验冲突处理机制（必须执行）

### 1) 冲突检测（沉淀新经验时）

在沉淀新经验前，必须：

1. **读取所有现有经验**：读取 `ai/context/experience/INDEX.md` 中的所有 active 经验
2. **冲突检测**：检查新经验的"触发条件"和"解决方案"是否与现有经验冲突
   - **触发条件相同/相似**：两个经验的触发条件指向同一场景
   - **解决方案矛盾**：两个经验对同一问题的解决方案相反或矛盾
3. **识别冲突经验**：如果检测到冲突，识别所有相关的旧经验

### 2) 自动剔除矛盾旧经验（必须执行）

如果检测到冲突：

1. **标记旧经验为 deprecated**：
   - 在旧经验文件中添加"替代关系"字段：
     ```markdown
     ## 替代关系（Replaced by / Replaces）
     - **被替代**：此经验已被 `ai/context/experience/<new-tag>-<new-title>.md` 替代
     - **替代原因**：新经验提供了更准确/更新的解决方案
     ```
   - 更新 `ai/context/experience/INDEX.md` 中对应行的 Status 为 `deprecated`
2. **在新经验中记录替代关系**：
   - 在新经验文件中添加"替代关系"字段：
     ```markdown
     ## 替代关系（Replaced by / Replaces）
     - **替代**：此经验替代了 `ai/context/experience/<old-tag>-<old-title>.md`
     - **替代原因**：旧经验的解决方案已过时/不正确
     ```
3. **在对话中提醒**：
   - 明确告知用户："检测到与新经验冲突的旧经验 X，已标记为 deprecated"

### 3) 经验合并/去重机制（可选）

如果检测到重复或高度相似的经验（而非冲突）：

1. **识别重复经验**：
   - 触发条件相同/相似
   - 解决方案相同/相似
2. **提供合并选项**：
   - 在对话中询问："检测到与现有经验 X 重复/高度相似，是否合并？"
   - 如果合并：
     - 保留更完整的经验文件（内容更详细、校验方式更完整）
     - 更新经验文件的"替代关系"字段
     - 标记另一个经验为 `deprecated`
     - 更新索引

## 冲突检测规则

**判断标准**（依靠大模型的语义理解能力）：
- **触发条件匹配**：新经验的触发条件与旧经验的触发条件指向同一场景
- **解决方案矛盾**：两个经验对同一问题的解决方案相反、矛盾或相互排斥
- **时间优先**：新经验优先（新经验替代旧经验）

**注意**：
- 只标记明显的冲突（解决方案矛盾），不要过度敏感
- 如果两个经验只是相似但不矛盾，按"合并/去重"处理，而非冲突

## 服务/模块上下文（仅概要 + 指针）

如果本次涉及某个服务/模块但缺少“高信号概要”，补：

- `ai/context/tech/services/<service-or-module>.md`

允许包含：

- 服务/模块做什么、不做什么（边界）
- 关键流程/概念（少量稳定术语）
- 常见坑（引用 experience）
- 代码指针（入口文件/关键函数/配置入口）

禁止包含：

- 复制代码、接口定义、字段表、实现细节复述

