---
name: 记忆系统重构执行规划
overview: 将灵犀的记忆系统从分散的 context/ 目录重构为统一的 memory/ 目录，实现完全统一的索引和匹配策略，包括目录迁移、组件重构、脚本更新和文档同步。
todos:
  - id: migrate-data
    content: 创建并执行数据迁移脚本：备份、创建新目录、迁移文件、合并索引、清理旧目录
    status: completed
  - id: rename-skills
    content: 重命名 Skills：experience-index → memory-index，experience-curator → memory-curator
    status: completed
  - id: update-memory-index
    content: 重构 memory-index Skill：支持统一索引读取和跨维度匹配
    status: completed
  - id: update-memory-curator
    content: 重构 memory-curator Skill：支持所有记忆类型的统一治理
    status: completed
  - id: update-experience-skills
    content: 更新 experience-capture、experience-depositor：路径和索引更新
    status: completed
  - id: update-service-skills
    content: 更新 service-loader、style-fusion：路径更新
    status: completed
  - id: update-commands
    content: 更新 init 和 remember 命令：所有路径引用更新
    status: completed
  - id: update-hooks
    content: 更新 stop.mjs Hook：路径更新
    status: completed
  - id: refactor-validate-script
    content: 重构验证脚本：validate-experience-index.js → validate-memory-index.js，支持统一索引
    status: completed
  - id: update-install-scripts
    content: 更新安装脚本：install-manifest.json、bash.sh、powershell.ps1 的目录和路径
    status: completed
  - id: update-architecture-docs
    content: 更新架构文档：architecture.md、experience-system.md → memory-system.md
    status: completed
  - id: update-reference-docs
    content: 更新参考文档：design-principles.md、core-values.md、about-lingxi/SKILL.md
    status: completed
  - id: update-gitignore
    content: 更新 .gitignore：路径更新
    status: completed
  - id: test-functionality
    content: 功能测试：索引读取、跨维度匹配、经验沉淀、记忆治理、服务上下文、初始化
    status: completed
  - id: verify-paths
    content: 路径验证：使用 grep 验证所有路径已更新，无遗留引用
    status: completed
isProject: false
---

# 灵犀记忆系统重构执行规划

## 目标

将 `.cursor/.lingxi/context/` 下的分散记忆系统重构为统一的 `.cursor/.lingxi/memory/` 目录，实现：

- 完全统一的索引（`memory/INDEX.md`）
- 统一的匹配策略和治理机制
- 清晰的目录结构（memory/experience、memory/tech、memory/business）
- 简化的工作空间（workspace/ 取代 context/session/）

## 目录结构变更

### 变更映射

| 原路径 | 新路径 | 说明 |

|--------|--------|------|

| `.cursor/.lingxi/context/experience/` | `.cursor/.lingxi/memory/experience/` | 经验记忆 |

| `.cursor/.lingxi/context/experience/team/INDEX.md` | `.cursor/.lingxi/memory/INDEX.md` | 统一索引（合并） |

| `.cursor/.lingxi/context/experience/project/INDEX.md` | `.cursor/.lingxi/memory/INDEX.md` | 统一索引（合并） |

| `.cursor/.lingxi/context/tech/` | `.cursor/.lingxi/memory/tech/` | 技术记忆 |

| `.cursor/.lingxi/context/business/` | `.cursor/.lingxi/memory/business/` | 业务记忆 |

| `.cursor/.lingxi/context/session/` | `.cursor/.lingxi/workspace/` | 工作空间 |

| `.cursor/.lingxi/context/style-fusion/` | `.cursor/.lingxi/style-fusion/` | 风格融合数据 |

## 执行阶段

### 阶段 1：数据迁移和目录重构

#### 1.1 创建迁移脚本

创建 `scripts/migrate-to-memory-system.sh`（或 `.ps1` 版本）：

- 备份现有数据：`cp -r .cursor/.lingxi/context .cursor/.lingxi/context.backup`
- 创建新目录结构：
  ```bash
  mkdir -p .cursor/.lingxi/memory/{experience/{team/{standards,knowledge},project},tech/services,business/references}
  mkdir -p .cursor/.lingxi/style-fusion
  mkdir -p .cursor/.lingxi/workspace
  ```

- 迁移文件：
  - `context/experience/*` → `memory/experience/`
  - `context/tech/*` → `memory/tech/`
  - `context/business/*` → `memory/business/`
  - `context/style-fusion/*` → `style-fusion/`
  - `context/session/pending-compounding-candidates.json` → `workspace/`（如存在）
- 合并索引：
  - 读取 `memory/experience/team/INDEX.md` 和 `memory/experience/project/INDEX.md`
  - 合并为 `memory/INDEX.md`，按类型分类（Experience/Tech/Business）
  - 为 tech 和 business 创建索引条目（如已有文件）
- 清理：删除 `context/` 目录

#### 1.2 统一索引格式设计

创建 `memory/INDEX.md` 模板：

```markdown
# Memory Index

> 灵犀统一记忆系统索引（SSoT）

## Experience（经验记忆）

| Tag | Type | Title | Trigger | Surface signal | Hidden risk | Status | Scope | Strength | Level | Replaces | ReplacedBy | File |
|---|---|---|---|---|---|---|---|---|---|---|---|---|

## Tech（技术记忆）

| Tag | Title | Service | Trigger | Status | File |
|---|---|---|---|---|---|

## Business（业务记忆）

| Tag | Title | Topic | Trigger | Status | File |
|---|---|---|---|---|---|
```

### 阶段 2：Skills 重构

#### 2.1 重命名 Skills

- `skills/experience-index/` → `skills/memory-index/`
  - 更新 `SKILL.md`：支持读取统一索引 `memory/INDEX.md`
  - 支持跨维度匹配（Experience/Tech/Business）
  - 匹配策略统一：基于 Trigger 进行语义匹配

- `skills/experience-curator/` → `skills/memory-curator/`
  - 更新 `SKILL.md`：支持治理所有记忆类型
  - 索引路径：`memory/INDEX.md`
  - 治理策略：所有类型使用相同的合并/取代逻辑

#### 2.2 更新现有 Skills

**experience-capture** ([`.cursor/skills/experience-capture/SKILL.md`](.cursor/skills/experience-capture/SKILL.md))：

- 路径更新：`context/session/` → `workspace/`
- 第 186 行：`pending-compounding-candidates.json` 路径

**experience-depositor** ([`.cursor/skills/experience-depositor/SKILL.md`](.cursor/skills/experience-depositor/SKILL.md))：

- 路径更新：
  - `context/session/` → `workspace/`
  - `context/experience/` → `memory/experience/`
- 索引更新：统一更新 `memory/INDEX.md`（不再区分 team/project INDEX）
- 第 10、210、217、224、280、285、290 行：所有路径引用
- 索引更新命令：从 `validate-experience-index.js --update --level team` 改为 `validate-memory-index.js --update`

**service-loader** ([`.cursor/skills/service-loader/SKILL.md`](.cursor/skills/service-loader/SKILL.md))：

- 路径更新：`context/tech/services/` → `memory/tech/services/`
- 第 10、42 行：输出路径
- 索引更新：写入经验时更新 `memory/INDEX.md`

**style-fusion** ([`.cursor/skills/style-fusion/SKILL.md`](.cursor/skills/style-fusion/SKILL.md))：

- 路径更新：`context/style-fusion/` → `style-fusion/`
- 所有 `profile.json` 和 `stats.json` 路径引用

### 阶段 3：Commands 更新

**init** ([`.cursor/commands/init.md`](.cursor/commands/init.md))：

- 路径更新：
  - `context/business/` → `memory/business/`
  - `context/tech/` → `memory/tech/`
  - `context/session/` → `workspace/`
  - `context/experience/` → `memory/experience/`
- 第 18、41、42、43、44、45 行：所有路径引用

**remember** ([`.cursor/commands/remember.md`](.cursor/commands/remember.md))：

- 路径更新：
  - `context/session/` → `workspace/`
  - `context/experience/` → `memory/experience/`
- 所有路径引用

### 阶段 4：Hooks 更新

**stop.mjs** ([`.cursor/hooks/stop.mjs`](.cursor/hooks/stop.mjs))：

- 路径更新：`context/session/` → `workspace/`
- 第 13 行：`pending-compounding-candidates.json` 路径

### 阶段 5：脚本重构

#### 5.1 验证脚本重构

**validate-experience-index.js** → **validate-memory-index.js**：

- 重命名文件
- 支持统一索引格式（Experience/Tech/Business 三个表）
- 路径更新：`context/experience/` → `memory/`
- 索引路径：`memory/INDEX.md`
- 更新命令参数：`--level team/project` 改为 `--type experience/tech/business`（可选）
- 更新所有引用此脚本的地方（experience-depositor 中 3 处）

#### 5.2 安装脚本更新

**install-manifest.json** ([`install/install-manifest.json`](install/install-manifest.json))：

- `workflowDirectories`：所有 `context/` 路径更新为 `memory/`
- `workflowTemplateFiles`：路径更新
- `workflowIndexFiles`：统一为 `["memory/INDEX.md"]`
- `gitignoreEntries`：`context/session/` → `workspace/`

**bash.sh** ([`install/bash.sh`](install/bash.sh))：

- 目录创建：`memory/` 及其子目录
- 所有 `context/` 相关路径更新
- 第 444、507、510 行：路径引用

**powershell.ps1** ([`install/powershell.ps1`](install/powershell.ps1))：

- 目录创建：`memory/` 及其子目录
- 所有 `context/` 相关路径更新
- 第 284、287 行：路径引用

### 阶段 6：文档同步

#### 6.1 架构文档更新

**architecture.md** ([`.cursor/skills/about-lingxi/references/architecture.md`](.cursor/skills/about-lingxi/references/architecture.md))：

- 目录结构说明（第 111-128 行）
- 经验沉淀机制说明（路径更新）
- 工作流生命周期说明

**experience-system.md** → **memory-system.md**：

- 重命名文件
- 扩展为记忆系统说明（包含 Experience/Tech/Business）
- 统一索引说明
- 统一匹配策略说明
- 统一治理机制说明
- 更新所有路径引用

**design-principles.md** ([`.cursor/skills/about-lingxi/references/design-principles.md`](.cursor/skills/about-lingxi/references/design-principles.md))：

- 上下文组织原则：路径更新
- 第 124-125、129-130 行：路径引用

**core-values.md** ([`.cursor/skills/about-lingxi/references/core-values.md`](.cursor/skills/about-lingxi/references/core-values.md))：

- 第 109 行：路径引用

**about-lingxi/SKILL.md** ([`.cursor/skills/about-lingxi/SKILL.md`](.cursor/skills/about-lingxi/SKILL.md))：

- 所有 `experience-system.md` 引用改为 `memory-system.md`
- 所有路径引用更新

**docs/design/architecture.md** ([`docs/design/architecture.md`](docs/design/architecture.md))：

- 目录结构说明
- 经验沉淀机制说明（路径更新）

#### 6.2 其他文档

**.gitignore** ([`.gitignore`](.gitignore))：

- 第 5 行：`context/session/` → `workspace/`（保留 workspace/ 的忽略规则）

### 阶段 7：测试验证

#### 7.1 功能测试

- 索引读取：验证 `memory-index` 能正确读取统一索引
- 跨维度匹配：验证能同时匹配 Experience/Tech/Business
- 经验沉淀：验证 `experience-depositor` 能正确写入新路径并更新索引
- 记忆治理：验证 `memory-curator` 能正确更新统一索引
- 服务上下文：验证 `service-loader` 能正确写入新路径
- 初始化：验证 `/init` 命令能正确创建新目录结构

#### 7.2 路径验证

使用 grep 验证所有路径已更新：

```bash
grep -r "context/experience" .cursor/
grep -r "context/tech" .cursor/
grep -r "context/business" .cursor/
grep -r "context/session" .cursor/
grep -r "context/style-fusion" .cursor/
```

#### 7.3 索引验证

- 运行 `validate-memory-index.js` 验证统一索引格式
- 验证索引包含所有记忆类型（Experience/Tech/Business）
- 验证索引字段完整性

## 关键文件修改清单

### Skills（8 个文件）

1. `skills/experience-index/SKILL.md` → 重命名为 `skills/memory-index/SKILL.md` 并更新
2. `skills/experience-capture/SKILL.md` - 路径更新
3. `skills/experience-depositor/SKILL.md` - 路径和索引更新
4. `skills/experience-curator/SKILL.md` → 重命名为 `skills/memory-curator/SKILL.md` 并更新
5. `skills/service-loader/SKILL.md` - 路径更新
6. `skills/style-fusion/SKILL.md` - 路径更新
7. `skills/candidate-evaluator/SKILL.md` - 可能需要更新（如涉及路径）

### Commands（2 个文件）

1. `commands/init.md` - 路径更新
2. `commands/remember.md` - 路径更新

### Hooks（1 个文件）

1. `hooks/stop.mjs` - 路径更新

### 脚本（3 个文件）

1. `scripts/validate-experience-index.js` → 重命名为 `scripts/validate-memory-index.js` 并重构
2. `install/install-manifest.json` - 目录和路径更新
3. `install/bash.sh` 和 `install/powershell.ps1` - 目录创建和路径更新

### 文档（7+ 个文件）

1. `skills/about-lingxi/references/architecture.md` - 目录结构说明
2. `skills/about-lingxi/references/experience-system.md` → 重命名为 `memory-system.md` 并扩展
3. `skills/about-lingxi/references/design-principles.md` - 路径引用
4. `skills/about-lingxi/references/core-values.md` - 路径引用
5. `skills/about-lingxi/SKILL.md` - 引用更新
6. `docs/design/architecture.md` - 目录结构说明
7. `.gitignore` - 路径更新

## 执行顺序

1. **阶段 1**：数据迁移（创建迁移脚本并执行）
2. **阶段 2**：Skills 重构（重命名和更新）
3. **阶段 3**：Commands 更新
4. **阶段 4**：Hooks 更新
5. **阶段 5**：脚本重构
6. **阶段 6**：文档同步
7. **阶段 7**：测试验证

## 注意事项

1. **备份优先**：执行迁移前必须备份现有数据
2. **索引合并**：合并 team/INDEX.md 和 project/INDEX.md 时，保留所有 active 条目
3. **向后兼容**：考虑是否需要支持旧路径的自动重定向（可选）
4. **测试覆盖**：每个阶段完成后进行验证，确保功能正常
5. **文档同步**：确保所有文档反映新的目录结构