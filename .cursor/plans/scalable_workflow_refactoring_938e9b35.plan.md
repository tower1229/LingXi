<!-- 历史计划：此文档记录 LingXi 1.0 到 2.0 演进过程中的计划，包含已废弃的 flow 相关引用，保留作为历史记录 -->

---
name: Scalable Workflow Refactoring
overview: 将工作流改造为可伸缩模式。核心是升级 req 阶段的"提纯+放大"能力，强化 plan 的"深度澄清+代码库分析"能力，用户选择跳过 plan 时自动生成轻量 plan。
todos:
  - id: req-purify
    content: req Skill 增加提纯能力：5W1H 结构化澄清、隐含意图挖掘、用户意图确认
    status: completed
  - id: req-amplify
    content: req Skill 增加放大能力：主动外部调研、方案对比、最佳实践融入
    status: completed
  - id: req-template
    content: req Skill 更新模板：功能需求表格增加"实现方案"列，强化验收标准
    status: completed
  - id: req-menu
    content: req Skill 更新菜单：增加选项C/D（跳过 plan 进入 audit/work）
    status: completed
  - id: plan-clarify
    content: plan Skill 增加澄清性问题能力：在任务拆解前分析 req 并提出澄清问题
    status: pending
  - id: plan-codebase
    content: plan Skill 强化代码库分析：复杂需求必选分析代码库上下文
    status: pending
  - id: plan-position
    content: plan Skill 更新定位描述：明确是复杂任务规划层，与 req 区分
    status: completed
  - id: flow-router
    content: flow-router Skill 增加跳转路径，自动生成轻量 plan
    status: completed
isProject: false
---

# 可伸缩工作流改造方案（方案 B：轻量 plan）

## 改造目标

- **完整路径**: req - plan - audit - work - review - archive
- **简化路径**: req - (auto plan) - work - archive（用户感知跳过 plan）
- **核心改造**: req 提纯+放大 + 自动生成轻量 plan

---

## 方案选择理由

### 方案对比

| 维度 | 方案 A（全面改造） | 方案 B（轻量 plan，采用） |

|-----|------------------|-------------------------|

| 改动文件数 | 9 | 2 |

| 下游 Skill 影响 | 全部需要适配 | 无影响 |

| 复杂度风险 | 高（双来源逻辑） | 低（单来源） |

| 维护成本 | 高 | 低 |

| 用户感知 | 真正跳过 plan | 感知跳过，实际自动生成 |

### 选择方案 B 的原因

1. **收益几乎相同**：用户感知是"跳过了 plan"，效率提升
2. **复杂度大幅降低**：只改 2 个文件，下游不受影响
3. **稳定性更高**：不引入"有 plan vs 无 plan"的分支逻辑
4. **维护成本低**：所有下游 Skill 仍然读取 plan.md，逻辑不变

---

## 1. req Skill 改造（核心）

### 1.1 提纯能力增强

当前 req 主要做"需求记录"，需升级为"需求提纯"：

- **结构化澄清**：对于模糊需求，使用 5W1H 框架引导用户表达

  - What: 具体要做什么功能/改动
  - Why: 为什么需要这个功能（业务驱动）
  - Who: 目标用户是谁
  - Where: 影响范围在哪里
  - When: 有无时间/顺序约束
  - How: 用户期望的交互/体验

- **隐含意图挖掘**：从用户描述中提取未明说的期望

  - 示例："添加按钮" → 可能隐含"要有点击反馈、要有禁用状态"

- **用户真实意图确认**：总结理解后确认，避免偏差

### 1.2 放大能力增强

当前 req 只在"触发条件满足时"做外部调研，需升级为"主动放大"：

- **主动外部调研**：对每个需求都尝试找到最佳实践

  - 使用 WebSearch 搜索 "best practice for X 2025/2026"
  - 使用 MCP context7 获取框架/库的官方文档

- **方案对比**：对于有多种可行方案的需求，列出对比并推荐最优

- **最佳实践融入**：将调研到的最佳实践直接融入解决方案概述

### 1.3 扩展功能需求表格

**扩展后的功能需求表格模板**：

```markdown
## 4. 功能需求

| 编号 | 需求描述 | 实现方案            | 验收标准     | 优先级   |
| ---- | -------- | ------------------- | ------------ | -------- |
| F1   | 功能描述 | 关键文件 + 实现模式 | 可验证的标准 | 必须实现 |
| F2   | ...      | ...                 | ...          | ...      |
```

**实现方案列内容要求**：

- 关键文件：需要修改/创建的文件路径
- 实现模式：推荐的代码组织方式或参考指针
- 简洁原则：指针优先，详细内容留给 work 阶段

### 1.4 更新菜单

```
需求文档已创建，您可以：

A) 继续修改/补充 需求
B) 进入 plan（复杂任务推荐）
C) 跳过 plan 进入 audit
D) 跳过 plan 直接 work
E) 回退
F) 退出
```

---

## 2. flow-router 改造

### 2.1 自动生成轻量 plan

当用户选择 C（跳过 plan 进入 audit）或 D（跳过 plan 直接 work）时：

1. 读取 req 的功能需求表格
2. 自动生成轻量 plan.md
3. 静默写入（符合静默成功原则）
4. 继续进入 audit 或 work

### 2.2 轻量 plan 模板

```markdown
# REQ-xxx Plan (Auto-generated)

## 目标回放

{从 req 的概述章节提取}

## 状态摘要（Status Summary）

- **当前阶段**：work
- **进度**：0/{功能数}
- **当前任务**：无
- **阻塞项**：无
- **上次更新**：{DATE}
- **自动生成**：是（从 req 功能需求映射）

## 任务清单（Tasks）

{从 req 功能需求表格逐行映射}

- [ ] F1: {需求描述}
  - 实现方案: {实现方案}
  - 验收标准: {验收标准}
- [ ] F2: ...

## 交付物（Deliverables）

- [ ] 代码变更完成
- [ ] 验收检查清单全部通过

## 测试规格（Test Specifications）

### 手工验证步骤

{从 req 验收检查清单映射}

| 步骤 | 操作       | 预期行为 |
| ---- | ---------- | -------- |
| 1    | {验收项 1} | 通过     |
| ...  | ...        | ...      |

## 复利候选（Compounding Candidates）

- [ ] （待补充）
```

### 2.3 映射规则

| req 章节 | plan 章节 | 映射方式 |

|---------|----------|---------|

| 概述 | 目标回放 | 直接引用 |

| 功能需求表格 | 任务清单 | 逐行映射为任务 |

| 验收检查清单 | 交付物 + 手工验证步骤 | 直接引用 |

### 2.4 INDEX 状态更新

| 跳转路径 | Status | Phase | 说明 |

|---------|--------|-------|-----|

| req → plan | planned | plan | 正常流程 |

| req → audit（自动生成 plan） | in-progress | audit | 用户感知跳过 plan |

| req → work（自动生成 plan） | in-progress | work | 用户感知跳过 plan |

---

## 3. plan Skill 改造

### 3.1 当前问题

对比用户原始需求，当前 plan skill 缺失：

| 用户需求 | 当前状态 | 差距 |

|---------|---------|-----|

| 提出澄清性问题，以明确需求 | 缺失 | 直接开始任务拆解 |

| 分析代码库以获取相关上下文 | 有 service-loader，但是"推荐" | 应该强化 |

| 明确 plan 适用场景 | 缺失 | description 没有体现与 req 的区分 |

### 3.2 改造内容

**3.2.1 更新 description**

```markdown
description: 此 Skill 是复杂任务规划层。当需求涉及多种可行方案、多文件/多系统、需求不清晰需探索、或需要审查架构决策时，通过深度澄清、代码库分析、完整任务拆解，生成可执行计划。
```

**3.2.2 新增"适用场景"章节**

在 Instructions 开头新增：

```markdown
### 0) Plan 适用场景

Plan 最适合以下场景（req 阶段无法完全覆盖）：

- 具有多种可行方案的复杂功能
- 涉及许多文件或多个系统的任务
- 需求不清晰、需要先探索再厘清范围的工作
- 希望先审查整体方案的架构决策

如果需求简单明确，用户可选择跳过 plan 直接进入 work。
```

**3.2.3 新增"澄清性问题"章节**

在任务拆解前新增：

```markdown
### 1.5) 澄清性问题（复杂需求必选）

在开始任务拆解前，分析 req 是否存在以下不清晰点：

| 检查维度 | 检查内容              | 示例问题                                   |
| -------- | --------------------- | ------------------------------------------ |
| 边界不清 | 功能边界、影响范围    | "这个功能是否需要支持移动端？"             |
| 方案未定 | 存在多个可行方案      | "用 A 方案还是 B 方案？各有什么优劣？"     |
| 依赖不明 | 与其他模块/系统的依赖 | "这个功能需要调用哪些现有服务？"           |
| 约束缺失 | 性能/安全/兼容性约束  | "对响应时间有要求吗？需要支持哪些浏览器？" |
| 验收模糊 | 成功标准不明确        | "什么样的结果算成功？"                     |

**输出格式**：

如有澄清性问题，先输出问题列表，等待用户回答后再继续任务拆解。

**静默跳过**：如果 req 已经足够清晰（简单需求），则静默跳过此步骤。
```

**3.2.4 强化代码库分析**

将 service-loader 从"推荐"改为"复杂需求必选"：

```markdown
### 1.1) 代码库分析（复杂需求必选）

在任务拆解前，分析代码库获取相关上下文：

**触发条件**（满足任一）：

- 需求涉及存量系统/多服务协作
- 需要修改多个模块
- 涉及与现有代码的集成

**分析内容**：

- 使用 `service-loader` 补齐服务上下文
- 使用 SemanticSearch/Grep 定位相关代码
- 识别需要修改的现有文件和模块

**输出要求**：

- 将分析结果融入"文件变更清单"
- 在任务描述中引用具体文件路径
```

### 3.3 req 与 plan 能力对比

| 能力 | req（提纯+放大） | plan（深度规划） |

|-----|-----------------|-----------------|

| 澄清性问题 | 基础澄清（5W1H） | 深度澄清（边界/方案/依赖/约束） |

| 代码库分析 | 简单定位（关键文件） | 完整分析（依赖关系、影响范围） |

| 方案规划 | 解决方案概述 | 完整实现计划（任务拆解、依赖、测试） |

| 外部调研 | 广度调研（主流方案） | 深度调研（具体实现、API 用法） |

---

## 5. 下游 Skill 不需要改动

**关键优势**：由于自动生成了 plan.md，所有下游 Skill 仍然可以：

- work：读取 plan 的 Status Summary 和 Tasks
- audit：审查 plan 的任务拆解
- review：回写 Blockers/High 到 plan
- archive：归档完整的三件套

**无需适配的 Skill**：

- work/SKILL.md（状态恢复仍读 plan）
- review/SKILL.md（回写仍到 plan）
- audit/SKILL.md（审查仍读 plan）
- archive/SKILL.md（归档仍是三件套）
- plan-manager/SKILL.md（管理仍是 plan）
- index-manager/SKILL.md（文件数量不变）

---

## 4. 涉及文件变更

| 操作 | 文件路径 | 说明 |

|-----|---------|-----|

| 修改 | `.cursor/skills/req/SKILL.md` | 增加提纯/放大能力，扩展功能需求表格，更新菜单 |

| 修改 | `.cursor/skills/req/SKILL.md` | 增加提纯/放大能力，扩展功能需求表格，更新菜单 |

| 修改 | `.cursor/skills/plan/SKILL.md` | 新增澄清性问题、强化代码库分析、更新定位描述 |

| 修改 | `.cursor/skills/flow-router/SKILL.md` | 增加跳转路径，实现自动生成轻量 plan |

---

## 7. 预期效果

**典型路径**：

1. **最短路径**：req → (auto plan) → work → archive
2. **审查路径**：req → (auto plan) → audit → work → archive
3. **完整路径**：req → plan（深度规划）→ audit → work → review → archive

**核心改进**：

- req 具备"提纯 + 放大"能力，产出高质量需求
- plan 具备"深度澄清 + 代码库分析"能力，适合复杂任务
- 功能需求表格包含实现方案，可自动映射为任务
- 用户选择跳过 plan 时，系统自动生成轻量 plan
- 下游 Skill 完全不受影响，维护成本低
- 稳定性高，不引入复杂的分支逻辑
