<!-- 历史计划：此文档记录 LingXi 1.0 到 2.0 演进过程中的计划，包含已废弃的 flow 相关引用，保留作为历史记录 -->

---
name: 灵犀2.0重构计划
overview: 基于 PRD 文档，完成灵犀 workflow 从 1.0 到 2.0 的完整重构，包括流程架构重构（多入口命令体系、流程解耦）和质量资产化机制优化（经验管理优化）。
todos:
  - id: create-req-command
    content: 创建 /req 命令（.cursor/commands/req.md），实现需求文档创建逻辑，包括任务编号生成、标题生成、需求提纯、需求放大、模板选择
    status: completed
  - id: create-req-review-command
    content: 创建 /req-review 命令（.cursor/commands/req-review.md），实现 req 文档审查功能
    status: completed
  - id: create-plan-command
    content: 创建 /plan 命令（.cursor/commands/plan.md），实现任务规划功能，包括任务拆解、测试框架检测、测试用例文档生成
    status: completed
  - id: create-build-command
    content: 创建 /build 命令（.cursor/commands/build.md），实现双模式构建（Plan-driven/Agent-driven），包括测试脚本编写和执行、文档同步
    status: completed
  - id: create-review-command
    content: 创建 /review 命令（.cursor/commands/review.md），实现多维度审查功能，包括测试执行、分级输出
    status: completed
  - id: update-experience-index
    content: 更新 experience-index Skill，支持多入口命令自动激活，实现上下文获取逻辑
    status: completed
  - id: create-experience-capture
    content: 创建 experience-capture Skill，实现统一经验捕获逻辑，包括阶段检测、触发场景文件
    status: completed
  - id: adapt-init-remember
    content: 适配 init.md 和 remember.md 命令，检查路径引用（特别是 session 目录相关路径），确认依赖 Skills
    status: pending
  - id: update-auxiliary-skills
    content: 检查并更新其他辅助 Skills（index-manager 等），适配新文件命名和目录结构
    status: pending
  - id: cleanup-directories
    content: 删除旧目录结构（in-progress, completed），删除 INDEX.md，清理 session 目录
    status: completed
  - id: delete-old-files
    content: 删除 1.0 旧文件（flow-router, req/plan/work/review Skills, plan-manager, flow.md 命令）
    status: completed
isProject: false
---

# 灵犀 2.0 重构计划

## 概述

本计划基于 `docs/prd/lingxi-2.0-refactor.md` PRD，实现从 1.0 到 2.0 的完整重构。核心包括：

1. **流程架构重构**：废弃单入口 `/flow`，改为多入口命令体系（`/req`, `/plan`, `/build`, `/review`）
2. **流程解耦**：所有环节可跳过，无生命周期管理，手动指定任务编号
3. **经验管理优化**：统一经验捕获机制，优化经验注入和匹配策略
4. **目录结构简化**：统一目录，简化文件命名

## 一、新命令体系创建

### 1.1 创建 `/req` 命令

**文件**：`.cursor/commands/req.md`

**功能**：创建需求文档（产出：`001.req.<标题>.md`）

**要点**：

- 自动生成任务编号（扫描 `.cursor/.lingxi/requirements/`，取最大编号+1）
- 自动生成标题（10字以内，特殊字符替换）
- 实现需求提纯（5W1H、隐含意图挖掘、用户确认）
- 实现需求放大（外部调研、方案对比、最佳实践融入）
- 根据类型和复杂度选择模板（简单功能/纯前端/纯后端/全栈）
- 在文档中包含 `PLAN-EXTRACT:*` 标记

**迁移来源**：`.cursor/skills/req/SKILL.md`

### 1.2 创建 `/req-review` 命令

**文件**：`.cursor/commands/req-review.md`

**功能**：审查 req 文档（可选，可多次执行）

**要点**：

- 读取 `001.req.*.md` 文件
- 多维度审查（需求完整性、技术可行性、可测试性、可实现性）
- 不产出文件，仅输出审查结果和建议

### 1.3 创建 `/plan` 命令

**文件**：`.cursor/commands/plan.md`

**功能**：生成任务规划（产出：`001.plan.<标题>.md` + `001.testcase.<标题>.md`）

**要点**：

- 读取 `001.req.*.md` 文件（使用 `PLAN-EXTRACT:*` 标记提取内容）
- 任务拆解（依赖关系、执行顺序）
- 测试框架检测与安装（vitest 优先）
- 测试用例文档生成（独立文件）
- 文档同步清单检测

**迁移来源**：`.cursor/skills/plan/SKILL.md`

### 1.4 创建 `/build` 命令

**文件**：`.cursor/commands/build.md`

**功能**：执行构建（双模式：Plan-driven 或 Agent-driven）

**要点**：

- 自动检测执行模式（存在 `001.plan.*.md` → Plan-driven，否则 → Agent-driven）
- Plan-driven 模式：按 plan 和 testcase 执行
- Agent-driven 模式：基于 req 自行决策
- 编写测试脚本并执行（循环修复直到全部通过）
- 文档同步（自动更新相关文档）

**迁移来源**：`.cursor/skills/work/SKILL.md`（work 阶段改名为 build）

### 1.5 创建 `/review` 命令

**文件**：`.cursor/commands/review.md`

**功能**：审查交付（产出：`001.review.<标题>.md`，不存档）

**要点**：

- 测试用例文档审查
- 测试脚本质量检查
- 测试执行（单元测试、集成测试）
- 多维度审查（功能/测试覆盖/安全/性能/架构/可维护性/回归风险/文档一致性）
- 分级输出（Blockers/High/Medium/Low）

**迁移来源**：`.cursor/skills/review/SKILL.md`

### 1.6 命令文件规范

所有命令文件包含 YAML frontmatter：

```yaml
---
name: req
description: 创建需求文档（产出：001.req.<标题>.md）
args:
  - name: description
    required: true
    description: 需求描述
---
```

## 二、经验管理优化

### 2.1 调整 experience-index

**文件**：`.cursor/skills/experience-index/SKILL.md`

**修改点**：

- 更新 description：支持 `/req`、`/plan 001`、`/build 001`、`/review 001` 等多入口命令自动激活
- 实现上下文获取逻辑（从命令参数推断任务编号和阶段，读取对应 req 文件）
- 优化输出规则（无匹配时静默，有匹配时仅输出关键信息）

### 2.2 创建 experience-capture Skill

**新建目录**：`.cursor/skills/experience-capture/`

**文件**：

- `SKILL.md`：统一经验捕获逻辑
- `references/req-triggers.md`：req 阶段触发场景
- `references/plan-triggers.md`：plan 阶段触发场景
- `references/build-triggers.md`：build 阶段触发场景
- `references/review-triggers.md`：review 阶段触发场景

**要点**：

- 统一检测策略：对话历史优先 + 文件验证补充
- 自动检测当前阶段和任务编号（L1: 对话历史，L2: 文件存在性，L3: 用户确认）
- 统一的 EXP-CANDIDATE 捕获逻辑（包含 taskId、stage、reqFile 字段）

### 2.3 优化经验匹配算法

**修改点**：

- 实现多维度匹配（任务编号+阶段+req内容+Trigger）
- 实现关键词提取 + Jaccard 相似度 + 阶段加权算法
- 优化匹配优先级（高：任务编号+阶段+Trigger 完全匹配 > 中：阶段+Trigger 匹配 > 低：仅 Trigger 关键词匹配）

## 三、目录结构简化

### 3.1 删除旧目录结构

**删除目录**：

- `.cursor/.lingxi/requirements/in-progress/`
- `.cursor/.lingxi/requirements/completed/`

**删除文件**：

- `.cursor/.lingxi/requirements/INDEX.md`
- `.cursor/.lingxi/context/session/*.json`（1.0 会话状态文件，但保留 `pending-compounding-candidates.json` 的目录结构）

**保留但简化**：

- `.cursor/.lingxi/context/session/`（2.0 简化，仅保留 `pending-compounding-candidates.json` 用于经验候选暂存）

### 3.2 创建新目录结构

**统一目录**：`.cursor/.lingxi/requirements/`（无子目录）

**文件命名规范**：

- Req：`001.req.<标题>.md`
- Plan：`001.plan.<标题>.md`
- Testcase：`001.testcase.<标题>.md`
- Review：`001.review.<标题>.md`（不存档）

## 四、删除 1.0 旧文件

### 4.1 删除旧 Skill 文件

**删除目录**：

- `.cursor/skills/flow-router/`（1.0 统一入口路由）
- `.cursor/skills/req-stage/`（如存在，逻辑迁移至 Command）
- `.cursor/skills/plan-stage/`（如存在，逻辑迁移至 Command）
- `.cursor/skills/work-stage/`（如存在，2.0 改名为 build）
- `.cursor/skills/review-stage/`（如存在，逻辑迁移至 Command）
- `.cursor/skills/archive-stage/`（2.0 废弃）

**删除**（逻辑已迁移至对应 commands）：

- `.cursor/skills/req/`（逻辑已迁移至 `/req` 命令）
- `.cursor/skills/plan/`（逻辑已迁移至 `/plan` 命令）
- `.cursor/skills/work/`（逻辑已迁移至 `/build` 命令，2.0 改名为 build）
- `.cursor/skills/review/`（逻辑已迁移至 `/review` 命令）
- `.cursor/skills/plan-manager/`（2.0 废弃，不再需要维护 plan 作为执行账本）

**保留**：

- `.cursor/skills/experience-*/`（保留并优化）
- 其他辅助 Skills（index-manager, service-loader, candidate-evaluator, experience-curator, experience-depositor 等）

### 4.2 更新/删除旧命令

**删除**：

- `.cursor/commands/flow.md`（1.0 单入口命令）

**保留并适配**：

- `.cursor/commands/init.md`（需要适配 2.0，检查路径引用，特别是 `.cursor/.lingxi/context/session/` 相关路径）
- `.cursor/commands/remember.md`（需要适配 2.0，检查路径引用，特别是 `.cursor/.lingxi/context/session/pending-compounding-candidates.json`）

## 五、命令适配与辅助 Skills 调整

### 5.1 适配 init.md 命令

**文件**：`.cursor/commands/init.md`

**适配点**：

- 确认 `.cursor/.lingxi/context/session/pending-compounding-candidates.json` 路径仍然有效（2.0 中 session 目录简化但保留此文件）
- 检查依赖的 Skills 是否仍然存在（service-loader, experience-depositor, rules-creator, context-engineering）
- 更新产物路径说明（如适用，特别是 session 目录相关的说明）

### 5.2 适配 remember.md 命令

**文件**：`.cursor/commands/remember.md`

**适配点**：

- 确认 `.cursor/.lingxi/context/session/pending-compounding-candidates.json` 路径仍然有效（2.0 中 session 目录简化但保留此文件）
- 检查依赖的 Skills 是否仍然存在（experience-depositor, context-engineering）
- 确认经验捕获机制与新的 experience-capture Skill 的集成方式（experience-capture 统一捕获，remember 负责沉淀）

### 5.3 index-manager

**评估**：2.0 废弃 INDEX.md，此 Skill 可能需要：

- 删除或重构为其他用途
- 或保留用于未来需求

### 5.3 其他辅助 Skills

**检查并更新**：

- `service-loader`：检查是否需要调整路径引用
- `candidate-evaluator`：检查是否需要适配新格式
- `experience-curator`：检查是否需要适配新格式
- `experience-depositor`：检查是否需要适配新格式

## 六、实施步骤

### 阶段 1：创建新命令体系（优先级最高）

1. 创建 `.cursor/commands/req.md`
2. 创建 `.cursor/commands/req-review.md`
3. 创建 `.cursor/commands/plan.md`
4. 创建 `.cursor/commands/build.md`
5. 创建 `.cursor/commands/review.md`

### 阶段 2：经验管理优化

1. 更新 `.cursor/skills/experience-index/SKILL.md`
2. 创建 `.cursor/skills/experience-capture/` 目录及文件
3. 创建各阶段触发场景文件（references）

### 阶段 3：命令适配与辅助 Skills 调整

1. 适配 `.cursor/commands/init.md`（检查路径引用，更新依赖说明）
2. 适配 `.cursor/commands/remember.md`（检查路径引用，确认经验捕获集成）
3. 检查并更新 `index-manager` 等辅助 Skills（如需要）
4. 更新其他依赖旧结构的 Skills

### 阶段 4：目录结构重构

1. 删除 `.cursor/.lingxi/requirements/in-progress/` 目录及内容
2. 删除 `.cursor/.lingxi/requirements/completed/` 目录及内容
3. 删除 `.cursor/.lingxi/requirements/INDEX.md`
4. 清理 `.cursor/.lingxi/context/session/` 目录（删除旧的会话状态文件，但保留目录结构用于 `pending-compounding-candidates.json`）

### 阶段 5：删除旧文件

1. 删除 `.cursor/skills/flow-router/` 目录
2. 删除 `.cursor/skills/req/` 目录（逻辑已迁移至 `/req` 命令）
3. 删除 `.cursor/skills/plan/` 目录（逻辑已迁移至 `/plan` 命令）
4. 删除 `.cursor/skills/work/` 目录（逻辑已迁移至 `/build` 命令）
5. 删除 `.cursor/skills/review/` 目录（逻辑已迁移至 `/review` 命令）
6. 删除 `.cursor/skills/plan-manager/` 目录（2.0 废弃）
7. 删除 `.cursor/commands/flow.md`（1.0 单入口命令）

### 阶段 6：验证与测试

1. 验证新命令可正常执行
2. 验证文件命名规范正确
3. 验证经验注入和捕获正常工作
4. 验证无残留旧文件

## 七、关键决策点

### 7.1 文件命名

- **格式**：`001.req.<标题>.md`（三位数编号 + 类型 + 标题）
- **标题限制**：10 个中文字符或 20 个英文字符
- **特殊字符处理**：自动替换为下划线

### 7.2 任务编号生成

- **规则**：扫描 `.cursor/.lingxi/requirements/` 目录，提取所有 `*.req.*.md` 文件的编号，取最大编号+1
- **起始值**：001
- **上限**：999

### 7.3 状态管理

- **废弃**：INDEX.md 状态管理
- **新机制**：对话历史优先 + 文件存在性验证
- **不强制状态**：允许任务停留在任意阶段

### 7.4 目录结构

- **统一目录**：所有任务文档统一存放在 `.cursor/.lingxi/requirements/`
- **无子目录**：不再区分 in-progress 和 completed

## 八、风险与应对

### 8.1 状态管理缺失

**风险**：删除 flow-router 后，如何判断任务当前状态？

**应对**：对话历史作为判断当前阶段的唯一权威来源，文件存在性仅用于验证任务状态和显示进度。

### 8.2 经验注入遗漏

**风险**：多入口可能导致某些命令未激活经验注入。

**应对**：调整 experience-index 激活条件，支持所有命令自动激活。

### 8.3 经验捕获准确性

**风险**：阶段和任务编号检测可能不准确。

**应对**：统一检测策略（对话历史优先 + 文件验证补充），对话历史缺失时提示用户明确指定。

## 九、验收标准

### 9.1 新命令功能

- [ ] `/req <描述>` 可独立执行，正确生成编号和文件
- [ ] `/req-review 001` 可独立执行，正确审查 req 文件
- [ ] `/plan 001` 可独立执行，正确生成 plan 和 testcase 文件
- [ ] `/build 001` 可独立执行，正确检测执行模式
- [ ] `/review 001` 可独立执行，正确执行多维度审查

### 9.2 文件命名规范

- [ ] 任务编号自动生成逻辑正确
- [ ] 标题生成逻辑正确（长度限制、特殊字符处理）
- [ ] 文件命名格式符合规范（`001.req.<标题>.md`）

### 9.3 目录结构

- [ ] 旧目录已删除（in-progress, completed）
- [ ] 新文件统一存放在 `.cursor/.lingxi/requirements/`
- [ ] 无残留旧文件

### 9.4 经验管理

- [ ] experience-index 在多入口命令下正确激活
- [ ] experience-capture 正确捕获经验候选
- [ ] 经验匹配算法正常工作

### 9.5 清理验证

- [ ] flow-router 已删除
- [ ] 旧阶段 Skills 已删除（req, plan, work, review）
- [ ] plan-manager 已删除
- [ ] flow.md 命令已删除
- [ ] INDEX.md 已删除
- [ ] init.md 和 remember.md 已适配 2.0
- [ ] 无 deprecated 代码残留