---
name: 灵犀2.1架构重构执行规划
overview: 基于架构重构方案A，实现Commands与Skills的职责分离，创建4个executor Skills，简化Commands文件，统一经验捕获机制，符合Cursor官方定义和工程实践准则。
todos:
  - id: prepare-backup
    content: 准备阶段：创建备份目录，备份当前 Commands 文件（req.md, plan.md, build.md, review.md）到 .cursor/commands-backup/
    status: completed
  - id: create-req-executor
    content: 创建 req-executor Skill：从 req.md 提取执行逻辑（第 45-509 行），创建 .cursor/skills/req-executor/SKILL.md，包含需求分析、提纯、放大和文档生成逻辑
    status: completed
  - id: create-plan-executor
    content: 创建 plan-executor Skill：从 plan.md 提取执行逻辑（第 54-467 行），创建 .cursor/skills/plan-executor/SKILL.md，包含任务规划、测试设计和文档生成逻辑
    status: completed
  - id: create-build-executor
    content: 创建 build-executor Skill：从 build.md 提取执行逻辑（第 44-191 行），创建 .cursor/skills/build-executor/SKILL.md，包含代码实现、测试编写和执行逻辑
    status: completed
  - id: create-review-executor
    content: 创建 review-executor Skill：从 review.md 提取执行逻辑（第 49-378 行），创建 .cursor/skills/review-executor/SKILL.md，包含多维度审查和交付质量保证逻辑
    status: completed
  - id: simplify-req-command
    content: 简化 req.md：移除执行逻辑（第 45-509 行）和经验捕获逻辑（第 195-230 行），添加依赖 Skills 说明和执行逻辑委托说明，目标 < 100 行
    status: completed
  - id: simplify-plan-command
    content: 简化 plan.md：移除执行逻辑（第 54-467 行）和经验捕获逻辑（第 240-275 行），添加依赖 Skills 说明和执行逻辑委托说明，目标 < 100 行
    status: completed
  - id: simplify-build-command
    content: 简化 build.md：移除执行逻辑（第 44-191 行）和经验捕获逻辑（第 225-260 行），添加依赖 Skills 说明和执行逻辑委托说明，目标 < 100 行
    status: completed
  - id: simplify-review-command
    content: 简化 review.md：移除执行逻辑（第 49-378 行）和经验捕获逻辑（第 196-237 行），添加依赖 Skills 说明和执行逻辑委托说明，目标 < 100 行
    status: completed
  - id: update-experience-capture
    content: 更新 experience-capture Skill：确认 description 包含所有命令（/req, /plan, /build, /review），验证自动激活机制正常
    status: completed
  - id: test-commands
    content: 功能测试：测试所有命令（/req, /plan, /build, /review）可正常执行，Skills 自动激活正常，产物正常生成
    status: completed
  - id: test-experience-capture
    content: 经验捕获测试：测试所有阶段的经验捕获场景，验证 experience-capture Skill 正常工作
    status: completed
  - id: verify-architecture
    content: 架构验证：检查 Commands 行数 < 100，不包含执行逻辑细节，Skills 包含完整执行逻辑，无重复逻辑（DRY）
    status: completed
  - id: verify-backward-compatibility
    content: 向后兼容测试：验证命令接口不变，文件命名和目录结构不变，产物格式不变，用户使用方式不变
    status: completed
isProject: false
---

# 灵犀 2.1 架构重构执行规划

## 概述

本规划基于《架构重构方案A_职责分离计划》，实现 Commands 与 Skills 的职责分离，符合 Cursor 官方定义和工程实践准则。

**核心目标**：

- Commands：纯入口，< 100行，只负责参数解析和调用说明
- Skills：执行逻辑，承载详细工作流指导
- 统一经验捕获机制，移除 Commands 中的重复逻辑

**重构范围**：

- 4 个 Commands：req.md, plan.md, build.md, review.md
- 新建 4 个 executor Skills：req-executor, plan-executor, build-executor, review-executor
- 更新 experience-capture Skill

---

## 一、准备阶段

### 1.1 创建目录结构

创建新的 executor Skills 目录：

```
.cursor/skills/
├── req-executor/
│   ├── SKILL.md
│   └── references/（可选）
├── plan-executor/
│   ├── SKILL.md
│   └── references/（可选）
├── build-executor/
│   ├── SKILL.md
│   └── references/（可选）
└── review-executor/
    ├── SKILL.md
    └── references/（可选）
```

### 1.2 备份当前 Commands

备份当前 Commands 文件到 `.cursor/commands-backup/` 目录，用于后续对比和回滚。

**文件清单**：

- `.cursor/commands/req.md` → `.cursor/commands-backup/req.md`
- `.cursor/commands/plan.md` → `.cursor/commands-backup/plan.md`
- `.cursor/commands/build.md` → `.cursor/commands-backup/build.md`
- `.cursor/commands/review.md` → `.cursor/commands-backup/review.md`

---

## 二、创建 executor Skills

### 2.1 创建 req-executor Skill

**文件路径**：`.cursor/skills/req-executor/SKILL.md`

**从 req.md 提取的内容范围**：

- 第 45-190 行：执行流程（项目上下文分析、任务编号生成、需求提纯、类型识别、需求放大）
- 第 238-509 行：模板选择与文档模板

**Frontmatter**：

```yaml
---
name: req-executor
description: 当执行 /req 命令时自动激活，负责需求分析、提纯、放大和造物计划文档生成。
---
```

**主要内容**：

1. Instructions 部分：详细的工作流指导
2. 项目上下文分析
3. 任务编号和标题生成规则
4. 需求提纯（5W1H、隐含意图挖掘、用户确认）
5. 类型识别与复杂度评估
6. 需求放大（外部调研、方案对比、最佳实践融入）
7. 经验融入（通过 experience-index）
8. 模板选择矩阵
9. 文档生成（包含 PLAN-EXTRACT 标记）
10. Fail Fast 原则
11. 信息汇总

**注意事项**：

- 不包含经验捕获逻辑（由 experience-capture 统一处理）
- 保持与原 req.md 执行逻辑一致
- 组织为清晰的 Instructions 格式

### 2.2 创建 plan-executor Skill

**文件路径**：`.cursor/skills/plan-executor/SKILL.md`

**从 plan.md 提取的内容范围**：

- 第 54-467 行：所有执行流程

**Frontmatter**：

```yaml
---
name: plan-executor
description: 当执行 /plan 001 命令时自动激活，负责任务规划、测试设计和文档生成。
---
```

**主要内容**：

1. 从 req 提取内容（PLAN-EXTRACT 标记）
2. 代码库分析（复杂需求）
3. 服务上下文补齐
4. 澄清性问题
5. 外部知识放大
6. 任务拆解
7. 测试设计（行为提取、测试规格、测试类型选择）
8. 测试框架检测与安装
9. 文档生成（plan + testcase）
10. Plan 质量自检
11. 文档同步清单检测

### 2.3 创建 build-executor Skill

**文件路径**：`.cursor/skills/build-executor/SKILL.md`

**从 build.md 提取的内容范围**：

- 第 44-191 行：所有执行逻辑

**Frontmatter**：

```yaml
---
name: build-executor
description: 当执行 /build 001 命令时自动激活，负责代码实现、测试编写和执行。
---
```

**主要内容**：

1. 模式检测（Plan-driven / Agent-driven）
2. Plan-driven 模式执行逻辑
3. Agent-driven 模式执行逻辑
4. 代码实现
5. 测试脚本编写
6. 测试执行（循环修复直到全部通过）
7. 文档同步
8. 降级方案
9. 测试执行规范

### 2.4 创建 review-executor Skill

**文件路径**：`.cursor/skills/review-executor/SKILL.md`

**从 review.md 提取的内容范围**：

- 第 49-378 行：所有执行逻辑

**Frontmatter**：

```yaml
---
name: review-executor
description: 当执行 /review 001 命令时自动激活，负责多维度审查和交付质量保证。
---
```

**主要内容**：

1. 读取输入（req、plan、testcase 文件）
2. 测试用例文档审查
3. 测试脚本质量检查
4. 测试执行
5. 多维度审查（8 个维度：功能、测试覆盖、安全、性能、架构、可维护性、回归风险、文档一致性）
6. Review 文档生成
7. 审查结果处理

---

## 三、简化 Commands

### 3.1 简化 req.md

**目标行数**：~80 行

**保留内容**：

- Frontmatter（name, description, args）
- 命令用途说明（1-2 段）
- 前置要求
- 使用方式
- 依赖的 Agent Skills（新增 req-executor）
- 产物说明
- 执行逻辑（简要说明委托给 req-executor）
- 经验捕获（说明由 experience-capture 统一处理）

**移除内容**：

- 详细的执行流程（第 45-509 行）
- 经验捕获逻辑（第 195-230 行）

**新增内容**：

- "依赖的 Agent Skills"部分，明确列出 req-executor
- "执行逻辑"部分，说明委托给 req-executor

### 3.2 简化 plan.md

**目标行数**：~70 行

**保留内容**：

- Frontmatter
- 命令用途说明
- 前置要求
- 使用方式
- 依赖的 Agent Skills（新增 plan-executor）
- 产物说明
- 执行逻辑（简要说明委托给 plan-executor）
- 经验捕获（说明由 experience-capture 统一处理）

**移除内容**：

- 详细的执行流程（第 54-467 行）
- 经验捕获逻辑（第 240-275 行）

### 3.3 简化 build.md

**目标行数**：~60 行

**保留内容**：

- Frontmatter
- 命令用途说明
- 前置要求
- 使用方式
- 依赖的 Agent Skills（新增 build-executor）
- 产物说明
- 执行逻辑（简要说明委托给 build-executor）
- 经验捕获（说明由 experience-capture 统一处理）

**移除内容**：

- 详细的执行流程（第 44-191 行）
- 经验捕获逻辑（第 225-260 行）

### 3.4 简化 review.md

**目标行数**：~70 行

**保留内容**：

- Frontmatter
- 命令用途说明
- 前置要求
- 使用方式
- 依赖的 Agent Skills（新增 review-executor）
- 产物说明
- 执行逻辑（简要说明委托给 review-executor）
- 经验捕获（说明由 experience-capture 统一处理）

**移除内容**：

- 详细的执行流程（第 49-378 行）
- 经验捕获逻辑（第 196-237 行）

---

## 四、统一经验捕获机制

### 4.1 更新 experience-capture Skill

**文件路径**：`.cursor/skills/experience-capture/SKILL.md`

**确认 description 字段**：

```yaml
description: 此 Skill 在执行 /req、/plan 001、/build 001、/review 001 等命令时自动激活，自动检测当前阶段和任务编号，提供统一的 EXP-CANDIDATE 捕获逻辑。
```

**验证内容**：

- description 包含所有命令（/req, /plan, /build, /review）
- 自动激活机制正常
- 触发场景文件完整（req-triggers.md, plan-triggers.md, build-triggers.md, review-triggers.md）

### 4.2 移除 Commands 中的经验捕获逻辑

**移除位置**：

- `req.md` 第 195-230 行：经验候选捕获逻辑
- `plan.md` 第 240-275 行：经验候选捕获逻辑
- `build.md` 第 225-260 行：经验候选捕获逻辑
- `review.md` 第 196-237 行：经验候选捕获逻辑

**替换为**：

在 Commands 中添加"经验捕获"部分，说明由 experience-capture Skill 统一处理。

---

## 五、测试与验证

### 5.1 功能测试

**测试用例**：

1. `/req <描述>` 命令可正常执行，自动激活 req-executor
2. `/plan 001` 命令可正常执行，自动激活 plan-executor
3. `/build 001` 命令可正常执行，自动激活 build-executor
4. `/review 001` 命令可正常执行，自动激活 review-executor
5. 经验捕获在所有阶段正常工作
6. 所有产物正常生成（req、plan、testcase、review 文档）

### 5.2 架构验证

**检查项**：

1. Commands 文件行数 < 100
2. Commands 不包含执行逻辑细节
3. Skills 包含完整的执行逻辑
4. 经验捕获统一由 experience-capture 处理
5. 无重复逻辑（DRY 原则）

### 5.3 向后兼容测试

**检查项**：

1. 现有任务可正常继续执行
2. 文件命名和目录结构不变
3. 用户使用方式不变（命令接口不变）
4. 产物格式不变

---

## 六、验收标准

### 6.1 架构验收

- [ ] Commands 文件行数 < 100
- [ ] Commands 不包含执行逻辑细节
- [ ] Skills 包含完整的执行逻辑
- [ ] 经验捕获统一由 experience-capture 处理
- [ ] 无重复逻辑（DRY 原则）

### 6.2 功能验收

- [ ] 所有命令可正常执行
- [ ] Skills 自动激活正常
- [ ] 所有产物正常生成
- [ ] 经验捕获在所有阶段正常工作

### 6.3 工程实践验收

- [ ] 符合 SRP（单一职责原则）
- [ ] 符合 SoC（关注点分离）
- [ ] 符合 DRY（不要重复）
- [ ] 符合 KISS（保持简单）

### 6.4 向后兼容验收

- [ ] 命令接口不变
- [ ] 文件命名和目录结构不变
- [ ] 产物格式不变
- [ ] 用户使用方式不变

---

## 七、关键文件清单

### 新建文件

1. `.cursor/skills/req-executor/SKILL.md`
2. `.cursor/skills/plan-executor/SKILL.md`
3. `.cursor/skills/build-executor/SKILL.md`
4. `.cursor/skills/review-executor/SKILL.md`

### 修改文件

1. `.cursor/commands/req.md`（简化）
2. `.cursor/commands/plan.md`（简化）
3. `.cursor/commands/build.md`（简化）
4. `.cursor/commands/review.md`（简化）
5. `.cursor/skills/experience-capture/SKILL.md`（确认 description）

### 备份文件

1. `.cursor/commands-backup/req.md`
2. `.cursor/commands-backup/plan.md`
3. `.cursor/commands-backup/build.md`
4. `.cursor/commands-backup/review.md`

---

## 八、风险与应对

### 8.1 主要风险

1. **Skills 自动激活失败**：确保 description 字段明确，包含命令名称
2. **执行逻辑迁移遗漏**：逐行对比原 Commands 和执行后的 Skills
3. **经验捕获失效**：测试所有阶段的经验捕获场景
4. **向后兼容性问题**：保持 Commands 接口和产物格式不变

### 8.2 应对措施

1. 在每个阶段测试 Skills 是否正确激活
2. 使用备份文件对比，确保所有逻辑已迁移
3. 在每个阶段触发经验捕获场景进行测试
4. 保持文件命名和目录结构不变

---

## 九、参考文档

- **架构重构方案A**：`.cursor/plans/架构重构方案A_职责分离计划.md`
- **示例文件**：`.cursor/plans/架构重构方案A_示例文件.md`
- **Commands 技术指南**：`.cursor/skills/workflow-optimizer/references/commands-guide.md`
- **Skills 技术指南**：`.cursor/skills/workflow-optimizer/references/skills-guide.md`
- **工程实践准则**：`.cursor/skills/workflow-optimizer/references/engineering-practices.md`