# /review - Review 阶段：分级审查并产出 TODO

## 命令用途

对 `<REQ-xxx>` 的实现进行结构化审查（功能、边界、可维护性、安全、性能、回归风险），输出分级 TODO，并落盘。

## 依赖的技能型 rules（Skill）

- `.cursor/rules/skill-index-manager.mdc`（状态更新）
- `.cursor/rules/skill-context-engineering.mdc`
- `.cursor/rules/skill-experience-index.mdc`（自动检索与加载历史经验）

## 使用方式

```
/review <REQ-xxx>
```

---

## 产物（必须落盘）

- `ai/requirements/in-progress/<REQ-xxx>.review.md`
- `ai/requirements/in-progress/<REQ-xxx>.plan.md`（必须回写 Blockers/High）
- `ai/requirements/INDEX.md`

## 执行要点（入口 + 路由）

- **输入**：Requirement + Plan + 本次改动核心文件 + 已做的验证记录

### 第一步：经验检索（强制执行）

**⚠️ 必须执行：** 在命令执行的第一步就必须执行经验检索，不可跳过。

调用 `skill-experience-index.mdc`，根据本次改动和审查场景自动检索匹配的历史问题与风险，并主动提醒。

**执行步骤：**
1. 读取 `ai/context/experience/INDEX.md`
2. 匹配所有 Status = `active` 的经验
3. 根据本次改动和审查维度（功能/安全/性能/架构/可维护性/回归风险）进行语义匹配
4. 在对话中输出匹配结果（历史问题、高风险警告、相关服务、代码模式）

### 第二步：多维度并行审查（模拟多代理）

从以下维度**依次**进行结构化审查，每个维度作为独立的审查阶段：
  1. **功能审查**：功能完整性、边界情况、错误处理
  2. **安全审查**：安全漏洞、权限检查、数据保护、输入验证
  3. **性能审查**：性能瓶颈、资源使用、缓存策略、数据库查询优化
  4. **架构审查**：架构设计、模块划分、依赖关系、可扩展性
  5. **可维护性审查**：代码质量、命名规范、类型安全、测试覆盖
  6. **回归风险审查**：对现有功能的影响、破坏性变更、兼容性
- **审查输出结构**：创建/更新 `ai/requirements/in-progress/<REQ-xxx>.review.md`，使用以下结构：

```markdown
# <REQ-xxx> Review

## 总结（3-6 行）

## 多维度审查结果

### 1. 功能审查

- **Blockers**：
  - [ ] ...
- **High**：
  - [ ] ...
- **Medium**：
  - [ ] ...
- **Low**：
  - [ ] ...

### 2. 安全审查

- **Blockers**：
  - [ ] ...
- **High**：
  - [ ] ...
- **Medium**：
  - [ ] ...
- **Low**：
  - [ ] ...

### 3. 性能审查

- **Blockers**：
  - [ ] ...
- **High**：
  - [ ] ...
- **Medium**：
  - [ ] ...
- **Low**：
  - [ ] ...

### 4. 架构审查

- **Blockers**：
  - [ ] ...
- **High**：
  - [ ] ...
- **Medium**：
  - [ ] ...
- **Low**：
  - [ ] ...

### 5. 可维护性审查

- **Blockers**：
  - [ ] ...
- **High**：
  - [ ] ...
- **Medium**：
  - [ ] ...
- **Low**：
  - [ ] ...

### 6. 回归风险审查

- **Blockers**：
  - [ ] ...
- **High**：
  - [ ] ...
- **Medium**：
  - [ ] ...
- **Low**：
  - [ ] ...

## 汇总：分级 TODO

### Blockers（必须修复）

- [ ] [功能] ...
- [ ] [安全] ...
- [ ] [性能] ...
- [ ] [架构] ...
- [ ] [可维护性] ...
- [ ] [回归] ...

### High（高优先级）

- [ ] [功能] ...
- [ ] [安全] ...
- [ ] [性能] ...
- [ ] [架构] ...
- [ ] [可维护性] ...
- [ ] [回归] ...

### Medium

- [ ] [功能] ...
- [ ] [安全] ...
- [ ] [性能] ...
- [ ] [架构] ...
- [ ] [可维护性] ...
- [ ] [回归] ...

### Low / Nice-to-have

- [ ] [功能] ...
- [ ] [安全] ...
- [ ] [性能] ...
- [ ] [架构] ...
- [ ] [可维护性] ...
- [ ] [回归] ...

## 回归检查清单

- [ ] ...
```

- **审查执行方式**：
  - 每个维度作为独立的审查阶段，依次执行
  - 每个维度都要输出该维度下的分级 TODO（Blockers/High/Medium/Low）
  - 最后汇总所有维度的结果，生成统一的分级 TODO 列表
  - 在汇总时，标注每个 TODO 的来源维度（如 `[安全]`、`[性能]`）
- **回写规则（必须）**：把汇总后的 Blockers/High 同步回 `ai/requirements/in-progress/<REQ-xxx>.plan.md` 的 Tasks（避免"两份 TODO 漂移"）
- **索引更新**：以 `skill-index-manager.mdc` 为准（Status = `in-review` 或 `needs-fix`）

## 多维度审查要点

### 功能审查

- 功能完整性：所有需求是否已实现
- 边界情况：异常处理、错误处理、边界值处理
- 用户故事：是否符合用户故事和验收标准

### 安全审查

- 安全漏洞：SQL 注入、XSS、CSRF、权限绕过
- 权限检查：用户权限、角色权限、资源权限
- 数据保护：敏感数据加密、数据脱敏、日志安全
- 输入验证：参数校验、类型检查、长度限制

### 性能审查

- 性能瓶颈：慢查询、N+1 问题、内存泄漏
- 资源使用：CPU、内存、网络、存储
- 缓存策略：缓存命中率、缓存失效、缓存穿透
- 数据库查询：索引使用、查询优化、连接池

### 架构审查

- 架构设计：模块划分、职责分离、依赖关系
- 可扩展性：水平扩展、垂直扩展、微服务拆分
- 设计模式：是否使用合适的设计模式
- 技术选型：技术栈选择是否合理

### 可维护性审查

- 代码质量：代码规范、命名规范、注释完整性
- 类型安全：TypeScript 类型定义、避免 `any`
- 测试覆盖：单元测试、集成测试、测试覆盖率
- 文档完整性：代码文档、API 文档、README

### 回归风险审查

- 对现有功能的影响：是否破坏现有功能
- 破坏性变更：API 变更、数据库变更、配置变更
- 兼容性：向后兼容、向前兼容、版本兼容
- 数据迁移：数据迁移脚本、回滚方案

---

## 输出要求

- 必须实际写入/更新文件
- 最后用 3-6 行说明：是否有 Blockers、下一步建议（通常是 `/work <REQ-xxx>` 修复后再 `/compound`）
