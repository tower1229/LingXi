---
name: review
description: 审查交付（产出：001.review.<标题>.md，不存档）
args:
  - name: taskId
    required: true
    description: 任务编号（如 001）
---

# /review - 审查交付

## 命令用途

Review 实际上是除了 req 之外第二重要的环节，因为工作流的最终目的就是交付，而 review 就是判定产出是否达到交付标准的环节。

**定位**：这是工作流的关键质量保证环节，通过多维度审查确保交付物符合要求。

## 前置要求

- **Cursor Nightly**：本工作流依赖 Agent Skills（仅 Nightly 渠道可用）
- req 文档已存在：`.workflow/requirements/<taskId>.req.*.md`
- build 阶段已完成：代码实现和测试已完成

## 使用方式

```
/review <taskId>
```

**示例**：

```
/review 001
```

## 依赖的 Agent Skills

- `experience-index`：自动匹配历史经验提醒

## 产物（必须写入）

- `.workflow/requirements/<taskId>.review.<标题>.md`（审查总结报告，**不存档**）

**输出规则（静默成功原则）**：

- 文件写入成功：静默，不输出确认信息（如"已写入 001.review.xxx.md"）
- 文件写入失败：输出错误信息

## 执行流程

### 1. 读取输入

- 扫描 `.workflow/requirements/` 目录
- 查找相关文件：
  - `<taskId>.req.*.md`（需求文档）
  - `<taskId>.plan.*.md`（如果存在，规划文档）
  - `<taskId>.testcase.*.md`（如果存在，测试用例文档）
- 定位 build 阶段编写的测试脚本文件

### 2. 测试用例文档审查

如果存在 `testcase` 文档：

- 读取 `<taskId>.testcase.*.md`
- 基于 req 审查测试用例文档
- 检查覆盖完整性、准确性
- 如不完整或不合格，补充或修改测试用例文档

### 3. 测试脚本质量检查（执行测试前）

- 读取 build 阶段编写的测试脚本文件
- 检查测试脚本的实现质量：

  - **覆盖完整性**：是否覆盖了 req 中的所有功能需求和验收标准
  - **断言准确性**：断言是否正确验证了预期行为，是否验证了关键结果
  - **测试隔离性**：测试之间是否相互独立，是否有外部依赖泄漏
  - **边界条件测试**：是否测试了边界情况、错误处理、异常场景
  - **测试可维护性**：测试代码是否清晰、可读，是否遵循测试最佳实践
  - **测试结构**：是否遵循"一行为一测试"原则，测试命名是否清晰

- **如果发现问题**：
  - 补充缺失的测试场景
  - 修正不准确的断言
  - 修复测试隔离问题
  - 补充边界条件测试
  - 优化测试代码结构

- **只有测试脚本质量合格后，才执行测试**

### 4. 测试执行

- 执行单元测试（基于 build 编写的测试脚本，已通过质量检查）
- 执行集成测试
- 记录测试执行结果（通过/失败/跳过）

**测试执行逻辑**：

- 使用项目中检测到的测试框架
- 执行命令：`yarn test` 或 `npm test`（由项目配置决定）
- 解析测试输出：提取通过/失败/跳过的测试数量
- 失败处理：列出失败用例，提供修复建议

**降级方案**：

如果测试框架无法执行（环境问题、依赖问题等）：
- 输出手动测试清单（基于 plan 的测试用例文档或 req 的验收标准）
- 提供测试步骤和预期结果
- 标记需要手动验证

### 5. 多维度审查（依次执行）

按以下维度依次审查，每个维度发现问题按优先级分级（Blockers/High/Medium/Low）：

#### 5.1 功能审查

检查内容：

- 是否符合 req 要求
- 功能是否完整实现
- 是否存在功能缺陷或需求偏差
- 是否存在回归风险

#### 5.2 测试覆盖审查

检查内容：

- **覆盖完整性**：
  - plan/testcase 中定义的所有可测试行为是否都有对应测试
  - 单元测试是否覆盖正常流程、边界条件、错误处理
  - 集成测试是否覆盖关键交互场景
- **测试质量**（已在步骤 3 检查，此处复核）：
  - 测试是否隔离（无外部依赖泄漏）
  - 测试是否遵循一行为一测试原则
  - 测试断言是否明确、有意义
  - 测试是否可重复执行
- **测试结果**：
  - 所有测试是否通过
  - 是否有被跳过（skip）的测试需要处理
  - 测试运行时间是否合理

**测试覆盖不足视为 High 级别问题**

#### 5.3 安全审查

检查内容：

- 是否存在安全漏洞或风险
- 是否存在注入风险
- 是否存在敏感信息暴露
- 权限控制是否合理

#### 5.4 性能审查

检查内容：

- 是否存在性能瓶颈或风险
- 是否存在内存泄漏风险
- 响应时间是否满足要求
- 资源使用是否合理

#### 5.5 架构审查

检查内容：

- 架构设计是否合理
- 模块耦合是否过紧
- 职责划分是否清晰
- 是否符合 req 中的架构思路

#### 5.6 可维护性审查

检查内容：

- 代码可维护性：代码结构是否清晰
- 代码可读性：命名是否清晰、注释是否充分
- 代码可扩展性：是否易于扩展
- 代码规范性：是否遵循项目代码规范

#### 5.7 回归风险审查

检查内容：

- 是否存在破坏现有功能的风险
- 是否影响其他模块
- 是否需要更新相关文档
- 是否需要通知相关团队

#### 5.8 文档一致性审查

检查内容：

- 代码与文档是否一致（检查 build 阶段同步的文档）
- 接口文档是否与实现一致
- 架构文档是否与代码结构一致

### 6. 经验候选捕获（即时捕获）

审查过程中，如发生以下情况，立即输出经验候选（HTML 注释包裹，不干扰对话）：

| 触发场景     | 描述                               | 典型信号                           |
| ------------ | ---------------------------------- | ---------------------------------- |
| **缺陷发现** | 发现功能缺陷/回归风险/需求偏差     | "这里有 bug"、"这不符合需求"       |
| **覆盖缺口** | 发现测试覆盖不足                   | "这个场景没测"、"边界条件没覆盖"   |
| **质量问题** | 发现测试质量/代码质量问题          | "测试不隔离"、"代码不可维护"       |
| **安全风险** | 发现安全漏洞或风险                 | "有注入风险"、"敏感信息暴露"       |
| **性能风险** | 发现性能瓶颈或风险                 | "这里会很慢"、"可能 OOM"           |
| **架构问题** | 发现架构/设计问题                  | "耦合太紧"、"职责不清"             |
| **问题处置** | 用户确认问题处置方式（修复/接受/拒绝） | "这个要修"、"这个风险接受"     |
| **优先级调整** | 用户调整问题优先级                 | "这个不是 blocker"、"这个要提高优先级" |
| **结论确认** | 用户确认/调整审查结论              | "通过"、"还要改"、"不通过"         |
| **指针确认** | 确认重要决策或文件指针             | "记住这个位置"、"这是关键文件"     |

**输出格式**：

```html
<!-- EXP-CANDIDATE
{
  "taskId": "001",
  "stage": "review",
  "trigger": "当发现测试覆盖缺口 B3 缺失",
  "decision": "修正/补充的建议与优先级",
  "alternatives": ["保持现状（放弃，因为风险...）"],
  "signal": "判断依据/风险信号/证据",
  "solution": "建议的修复/补测/调整",
  "verify": "验证或重测方式",
  "pointers": ["path/to/test 或代码指针"],
  "reqFile": ".workflow/requirements/001.req.<标题>.md",
  "notes": "可选补充"
}
-->
```

**关键字段**：

- `taskId`：任务编号（001, 002, ...）
- `stage`：当前阶段（review）
- `reqFile`：关联的 req 文件路径（用于后续匹配和追溯）

### 7. Review 文档写入

#### Review 文档模板

```markdown
# 001.review.<标题>

## 总结（3-6 行）

[简要总结审查结果：是否通过、主要问题、改进建议]

## 测试覆盖报告

### 测试执行结果

| 类型 | 通过 | 失败 | 跳过 |
|-----|-----|-----|-----|
| 单元测试 | X | 0 | 0 |
| 集成测试 | X | 0 | 0 |

### 行为覆盖情况

| 行为ID | 行为描述 | 测试状态 |
|-------|---------|---------|
| B1 | ... | ✅ 已覆盖 |
| B2 | ... | ✅ 已覆盖 |
| B3 | ... | ⚠️ 部分覆盖（缺少边界条件） |

### 测试质量评估

- 隔离性：✅ / ⚠️ / ❌
- 可维护性：✅ / ⚠️ / ❌
- 断言质量：✅ / ⚠️ / ❌

## 多维度审查结果

### 1. 功能审查

- Blockers:
- High:
- Medium:
- Low:

### 2. 测试覆盖审查

- Blockers:
- High:
- Medium:
- Low:

### 3. 安全审查

- Blockers:
- High:
- Medium:
- Low:

### 4. 性能审查

- Blockers:
- High:
- Medium:
- Low:

### 5. 架构审查

- Blockers:
- High:
- Medium:
- Low:

### 6. 可维护性审查

- Blockers:
- High:
- Medium:
- Low:

### 7. 回归风险审查

- Blockers:
- High:
- Medium:
- Low:

### 8. 文档一致性审查

- Blockers:
- High:
- Medium:
- Low:

## 汇总：分级 TODO

### Blockers

[列出必须修复的问题]

### High

[列出高优先级问题]

### Medium

[列出中优先级问题]

### Low

[列出低优先级问题]
```

#### 文档命名约定

- Review 文档：`001.review.<标题>.md`（标题 10 字以内，从 req 文档标题提取）
- **不存档**：review 文档不存档，每次执行会覆盖之前的文档

### 8. 审查结果处理

**优先级分级**：

- 每个维度发现问题按优先级分级（Blockers/High/Medium/Low）
- **测试覆盖不足视为 High 级别问题**
- Blockers 必须修复，High 可修复或明确接受风险
- 审查结论必须明确（通过/需修复/拒绝）

**审查结论**：

- **通过**：所有 Blockers 和 High 已处理，可以交付
- **需修复**：存在 Blockers 或 High 需要处理
- **拒绝**：存在严重问题，需要重大修改

---

## 与 1.0 的主要区别

1. **文件命名**：从 `REQ-xxx.review.md` 改为 `001.review.<标题>.md`
2. **文件位置**：从 `.workflow/requirements/in-progress/` 改为 `.workflow/requirements/`
3. **索引管理**：不再更新 INDEX.md（2.0 废弃）
4. **状态管理**：不再回写 plan.md（2.0 废弃 plan-manager）
5. **不存档**：review 文档不存档，每次执行会覆盖
6. **新增环节**：新增测试用例文档审查和测试脚本质量检查
