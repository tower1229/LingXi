# Workflow 优化方案：静默成功原则

## 设计原则

遵循 **Linux 命令行设计哲学**：**没有消息就是好消息**。节省用户时间，节省大模型 token。

## 核心原则

1. **用户决策权不可侵犯**：所有需要用户判断的输出必须完整保留
2. **静默成功**：成功、无问题、无匹配时静默，不输出
3. **精简非决策输出**：减少非关键信息的冗余输出

## 优化点（已审核）

### ✅ 1. 经验索引静默（experience-index）

**当前行为**：即使无匹配也可能输出"无相关经验"

**优化后**：
- 无匹配时：**完全静默**，不输出任何内容
- 有匹配时：仅输出关键信息（风险级别 + 指针），省略冗长的结构化格式

**输出示例**（有匹配时）：
```
⚠️ 高风险：XXX（参考 EXP-001.md）
```

**理由**：经验匹配是背景信息，无匹配时无需告知用户。

---

### ✅ 2. 推进判据检查静默（gate-protocol）

**当前行为**：判据满足时可能说明"判据已满足"

**优化后**：
- 判据满足时：**静默进入下一阶段**，不输出检查清单
- 判据不满足时：输出完整检查清单（已实现）

**理由**：判据满足是正常流程，无需告知。不满足时才需要用户关注。

---

### ✅ 3. 文件写入静默

**当前行为**：每次写入都说明"已写入 XXX.md"

**优化后**：
- 写入成功：**静默**，不输出确认信息
- 写入失败：输出错误信息

**理由**：文件写入是预期行为，成功时无需确认。失败时才需要用户关注。

---

### ✅ 4. 阶段完成输出精简

**当前行为**：每阶段结束都输出 3-6 行状态说明 + 菜单

**优化后**：
- 正常完成：仅输出一行状态 + 菜单
  ```
  ✅ req 完成 → plan | A)继续 B)下一阶段 C)回退 D)退出
  ```
- 有阻塞项：输出详细说明（保留）

**理由**：正常完成是预期行为，精简输出。有阻塞项时需要详细说明。

---

### ✅ 5. 经验治理报告精简（experience-curator）

**当前行为**：每次治理都输出完整报告

**优化后**：
- 无变更：**静默**，不输出
- 有变更：仅输出变更摘要
  ```
  治理：合并 EXP-001→EXP-003，deprecated 1 条（回滚：cp INDEX.md.bak INDEX.md）
  ```

**理由**：无变更时无需告知。有变更时仅需摘要，详细信息在文件中。

---

### ✅ 6. 质量准则建议静默（experience-curator）

**当前行为**：每次沉淀都输出建议列表（可能为空）

**优化后**：
- 无建议：**静默**，不输出
- 有建议：输出建议摘要（保留完整表格），等待用户通过 `/remember` 命令沉淀质量资产

**理由**：无建议时无需告知。有建议时需要完整信息供用户判断。

---

### ✅ 7. 测试状态静默（work）

**当前行为**：可能每次测试都输出结果

**优化后**：
- 全部通过：**静默**（仅在 Status Summary 中更新）
- 有失败：输出失败详情

**理由**：测试通过是预期行为，无需告知。失败时需要详细输出。

---

## 明确保留的输出（用户决策权）

### ❌ 审查报告（audit）- **必须完整输出**

**保留原因**：用户需要根据完整报告自行判断是否进入 work 阶段。只有用户拥有真正的决定权。

**输出要求**：
- 无论评分如何，必须输出完整审查报告
- 包含所有审查维度（技术风险、任务完整性、测试规格、验证可靠性、规范符合度）
- 包含可执行性评分和判断依据

---

### ❌ 固定 4 选项菜单 - **必须保留**

**保留原因**：用户需要完整的判断选项，包括回退选项。

**菜单格式**（保持不变）：
```
你要怎么做？
A) 继续本阶段（例如再 audit 一次 / 继续 work 下一个 task）
B) 进入下一阶段（我会检查推进判据，满足则直接进入）
C) 回退到上一阶段（说明原因与影响）
D) 退出
```

---

### ❌ 候选展示 - **必须完整展示**

**保留原因**：用户需要了解足够的候选信息才能做出判断。

**展示要求**：
- 必须展示所有候选的完整信息
- 包含候选摘要、落点选择、理由、预期收益
- 支持用户全选/部分选择

---

## 状态摘要去重优化

**当前问题**：状态摘要在 plan、checkpoint、INDEX 等多处重复

**优化方案**：
- 以 INDEX 为 SSoT（单一事实来源）
- plan 的 Status Summary 仅显示当前阶段的关键信息（进度、当前任务、阻塞项）
- checkpoint 引用 INDEX 或 plan，不重复完整状态

**理由**：减少重复信息，但保留必要的阶段内状态。

---

## 实施优先级

### 高优先级（高频场景）
1. ✅ 经验索引静默（每次阶段切换）
2. ✅ 推进判据检查静默（每次阶段切换）
3. ✅ 文件写入静默（每次文件操作）

### 中优先级（中频场景）
4. ✅ 阶段完成输出精简（每阶段结束）
5. ✅ 测试状态静默（work 阶段）

### 低优先级（低频场景）
6. ✅ 经验治理报告精简（沉淀时）
7. ✅ 质量准则建议静默（沉淀时）

---

## 预期收益

| 优化点 | 节省 token/次 | 频率 | 总节省 |
|--------|--------------|------|--------|
| 经验索引静默 | ~20 | 每次阶段切换 | 高频 |
| 推进判据静默 | ~50 | 每次阶段切换 | 高频 |
| 文件写入静默 | ~30 | 每次文件操作 | 高频 |
| 阶段完成精简 | ~100 | 每阶段结束 | 中频 |
| 测试状态静默 | ~50 | work 阶段 | 中频 |
| 治理报告精简 | ~200 | 沉淀时 | 低频 |
| 质量准则静默 | ~100 | 沉淀时 | 低频 |

**预计总节省**：30-40% 的 token 消耗（高频场景优化为主）

---

## 参考

- [Linux 命令行设计哲学](https://en.wikipedia.org/wiki/Unix_philosophy#Do_one_thing_and_do_it_well)
- [gate-protocol.md](./gate-protocol.md) - 推进判据检查
- [workflow-lifecycle.md](./workflow-lifecycle.md) - 工作流生命周期
