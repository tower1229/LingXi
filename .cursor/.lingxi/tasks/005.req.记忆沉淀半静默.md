# 005.req.记忆沉淀半静默

| 属性     | 值       |
| -------- | -------- |
| 版本     | 1.0      |
| 创建日期 | 2025-02-23 |
| 需求类型 | 简单功能 |
| 复杂度   | 简单     |

---

## 1. 概述

### 1.1 背景

- 灵犀记忆库当前约定：lingxi-memory 子代理在 **merge/replace** 时必须在对话内展示「治理方案（待确认）」并等用户 A/B/C/D 确认后执行；**new（新建）** 为治理判定后直接写入，无显式门控。
- 在混合检索改进（004）提升「记对了能召回」之后，适当提高对 agent 的信任、减少打断，可提升「称心如意」体验；用户仍可通过查看 `memory/notes/` 与审计日志了解「灵犀记住了什么」，并对错误记忆手动修改或删除。

### 1.2 问题描述

- 当前所有可沉淀条目前提是主 Agent 显式调用 lingxi-memory；子代理侧对 **new** 虽无门控 UI，但未区分「高可靠性静默写」与「低可靠性需用户介入」。
- 希望引入**半静默**：当从对话中提取到的可记忆条目**可靠性较高**时静默写入；**可靠性较低**时才显性让用户介入判断，在体验与可控之间取得平衡。

### 1.3 解决方案概述

- **范围限定**：半静默**仅适用于治理决策为 new（新建）**的写入。**Merge / Replace 保持现状**：仍须在本对话内展示「治理方案（待确认）」与 A/B/C/D，仅在用户确认后执行（与「用户门控不可侵犯」一致）。
- **可靠性分流**：对 **new** 路径，子代理在产候选与治理完成后，先评估该条候选的**可靠性**；若判定为高可靠性则**静默写入**（不展示确认、不向主对话输出过程）；若判定为低可靠性则**显性门控**（在本对话内展示候选与选项，等用户确认后再执行写入）。
- **可观测与事后纠正**：继续依赖现有审计（每次写入追加 `memory_note_created` 等）、INDEX 与 notes 文件可读可改，用户可随时查看与修正。

---

## 2. 目标

| 编号 | 目标 | 优先级   |
| ---- | ---- | -------- |
| G1   | 对 new 写入引入「高可靠性静默写、低可靠性显性门控」的半静默策略 | 必须实现 |
| G2   | Merge/Replace 保持显性门控，不纳入半静默 | 必须实现 |
| G3   | 在约定中明确高/低可靠性的判定指引，避免模糊自评 | 必须实现 |

---

## 3. 功能需求

| 编号 | 需求描述 | 实现方案 | 验收标准 | 优先级   |
| ---- | -------- | -------- | -------- | -------- |
| F1   | lingxi-memory 对 **new** 路径在写入前做可靠性评估；高可靠性时静默写入并仅向主对话返回一句或静默；低可靠性时在本对话内展示候选与确认选项，用户确认后再执行写入 | 更新 `.cursor/agents/lingxi-memory.md`：在职责中增加「new 路径可靠性分流」；在新增小节中定义高/低可靠性判定指引（如：用户原话近乎一字不差且无歧义、无冲突信号等为高；否则为低或存疑则为低） | 文档中明确 new 的双分支与判定指引；merge/replace 仍仅描述为「门控（待确认）」 | 必须实现 |
| F2   | Merge/Replace 行为不变：仍须展示治理方案与 A/B/C/D，仅在用户确认后执行 | 保持 lingxi-memory 中「用户门控格式」「仅在用户确认后执行」的现有描述；不在 merge/replace 上增加「高可靠性可静默」 | 文档中未出现「merge/replace 可静默」 | 必须实现 |
| F3   | memory-system 与核心原则中体现「半静默仅限新建；删除与替换仍须确认」 | 更新 `.cursor/.lingxi/memory/` 或 about-lingxi 下的 `references/memory-system.md`（及必要时 core-values/architecture）：在门控相关表述中注明半静默适用范围与保留门控范围 | 读者能明确半静默仅 new、merge/replace 仍须确认 | 必须实现 |
| F4   | 审计与可观测性不变：每次写入（含静默 new）仍追加记忆审计行；Source 等字段可区分 auto/用户确认 | 不修改 append-memory-audit 或审计字段约定；lingxi-memory 约定中注明静默 new 写入后同样追加审计 | 静默 new 写入后 audit 中仍有对应 memory_note_created 行 | 必须实现 |

---

## 4. 非目标

- 不实现 merge/replace 的静默执行。
- 不新增自动化测试或脚本；验收以文档一致性与人工在对话中验证为主。
- 不改变 share/ 或跨项目复用的写入策略（若未来有写入 share 的约定，仍建议显性确认）。

---

## 5. 验收检查清单

- [ ] `lingxi-memory.md` 中 new 路径有明确的「高可靠性静默写 / 低可靠性显性门控」双分支描述。
- [ ] `lingxi-memory.md` 中有高/低可靠性判定指引（示例或规则），且明确仅适用于 new。
- [ ] `lingxi-memory.md` 中 merge/replace 仍为「必须门控、仅在用户确认后执行」，无静默例外。
- [ ] `memory-system.md`（及必要时其他引用文档）中门控原则注明「半静默仅限新建；删除与替换须确认」。
- [ ] 静默 new 写入后审计约定未放宽（仍追加 memory_note_created 等）。
