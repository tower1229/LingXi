# 002.req.工作流下一步建议

| 属性     | 值         |
| -------- | ---------- |
| 版本     | 1.0        |
| 状态     | 草稿       |
| 创建日期 | 2025-02-04 |
| 需求类型 | 简单功能   |
| 复杂度   | 简单       |

---

## 1. 概述

### 1.1 背景

- 灵犀工作流各命令（/req、/review-req、/plan、/build、/review、/remember、/init）执行结束后，当前仅遵循「静默成功」输出规则，不主动提示用户下一步可执行的操作。
- 用户反馈：步骤完成后缺少「下一步建议」，且若建议与任务情况脱节则意义不大；希望结合**当前输出质量**给出推荐，并通过 A/B/C/D 选项快速选择。

### 1.2 问题描述

- 各步骤结束时没有结合**当前输出质量**（LLM 对产出的信心、是否满足关键维度等）的下一步建议，用户难以快速决策。
- 若采用固定文案或仅按「简单/复杂」分支则机械化；真正应驱动推荐的是**对当前产出是否足以支撑下一步的评估**，而非任务属性本身。

### 1.3 解决方案概述（不含技术实现细节）

- **形式**：在 req、review-req、plan、build、review 五个步骤中，当该步骤本次已有正文输出时，在回复末尾输出「下一步可尝试（选一项）」的 **A/B/C/D 四项选项**，其中 **A 永远为推荐选项**，其余为满足各种可能性的备选。
- **推荐依据**：采用 **质量自检 + 约束集合**——每个步骤约定「质量自检维度」（见附录 6.5），Agent 在给出下一步建议**前**先基于该维度对当前输出做简短自评；根据自评结果（是否满足关键维度、是否存在明显缺口）在允许动作集合内挑选 4 项并决定谁为 A。**禁止在选项中出现集合外的命令**。推荐逻辑见附录 6.2（自检通过→推进，自检不通过→先改进）。
- **用户回复 A/B/C/D**：当用户仅回复 A、B、C 或 D 时，Agent 应解析为对应选项并执行或引导执行对应命令（见 F8）。
- **remember 与 init**：**无需修改**，保持现有行为（如 remember 后一句「继续当前任务即可，下次对话会自动参考新记忆」；init 后一句「用 /req、/build 等开始任务」），不采用 A/B/C/D 选项形式。
- **输出时机**：仅当该步骤本次已有正文输出时在末尾追加；纯静默成功时不追加，不破坏静默成功原则。

---

## 2. 目标与指标

### 2.1 目标

| 编号 | 目标                                                                 | 优先级   |
| ---- | -------------------------------------------------------------------- | -------- |
| G1   | req、review-req、plan、build、review 五步在「有输出时」末尾输出 A/B/C/D 四项下一步建议，A 为推荐 | 必须实现 |
| G2   | 选项内容基于对当前输出质量的自我评估（见附录质量自检维度与推荐逻辑）由 Agent 在允许动作集合内生成，不机械化 | 必须实现 |
| G3   | 各步骤的允许动作集合在文档中明确定义，选项中的命令仅限该集合，便于约束与校验                   | 必须实现 |
| G4   | remember、init 保持现状，不增加 A/B/C/D 选项                                                      | 必须实现 |
| G5   | 有输出时末尾追加，纯静默成功时不追加，与静默成功原则兼容                                         | 必须实现 |

### 2.2 非目标

- 不改变各命令的静默成功规则本身。
- 不增加新命令或新 Skill。
- 不在选项中出现允许集合外的命令（如禁止编造 `/foo`）。

### 2.3 成功标准（必须可验证）

| 标准 | 描述                                                                 | 验证方式                               |
| ---- | -------------------------------------------------------------------- | -------------------------------------- |
| S1   | req/review-req/plan/build/review 在有输出时末尾出现 A/B/C/D 四项，A 标注推荐 | 执行各步并观察输出格式                 |
| S2   | 自检认为当前产出可支撑后续步骤时 A 为 build/plan 类，自检存在明显缺口时 A 为 review-req/补充修改类（与附录 6.2 一致） | 按质量自检维度抽查 req 输出与 A 的对应关系 |
| S3   | 选项中出现的命令均在附录「允许动作集合」内                           | 人工或脚本抽查选项文案                 |
| S4   | remember、init 的下一步提示未改为 A/B/C/D，仍为一句式                | 执行 remember/init 观察               |
| S5   | 纯静默成功（如 req 仅写文件成功）时未强制多出一段建议                | 执行 req 成功且无其他输出时观察        |
| S6   | 用户仅回复 A/B/C/D 时，Agent 解析为对应选项并执行或引导执行对应命令   | 输出建议后回复 A 或 B，观察 Agent 行为  |

---

## 3. 用户故事（至少 1 条）

### US-1: 步骤结束后按输出质量选下一步

**作为** 灵犀使用者  
**我想要** 在 req/plan/build/review 等步骤有输出时，看到基于当前输出质量自评的 A/B/C/D 下一步选项，且 A 是推荐项；并可通过回复 A/B/C/D 快速触发对应动作  
**以便** 不用回忆流程也能选到最合适的下一步，或通过其他选项覆盖例外情况。

**验收标准：**

- [ ] 有输出时回复末尾有「下一步可尝试（选一项）：A) …（推荐） B) … C) … D) …」。
- [ ] 自检认为产出可支撑后续步骤时 A 为 build/plan 类，自检存在明显缺口时 A 为 review-req/补充修改类（与附录 6.2 一致）。
- [ ] 用户仅回复 A/B/C/D 时，Agent 解析为对应选项并执行或引导执行对应命令。

---

## 4. 功能需求

| 编号 | 需求描述                                                                 | 实现方案                                                                 | 验收标准                                           | 优先级   |
| ---- | ------------------------------------------------------------------------ | ------------------------------------------------------------------------ | -------------------------------------------------- | -------- |
| F1   | req 步骤：有输出时末尾输出 A/B/C/D；先按附录 6.5 质量自检维度自评，自检通过则 A=build/plan，不通过则 A=review-req/补充修改；选项仅来自允许集合 | `.cursor/skills/req-executor/SKILL.md` 或 `.cursor/commands/req.md` 中约定：输出格式、允许集合、自检维度与推荐逻辑（见本 req 附录） | 自检通过时 A 为 build/plan，自检不通过时 A 为 review-req；选项命令在集合内 | 必须实现 |
| F2   | review-req 步骤：有输出时末尾 A/B/C/D；按质量自检（是否发现 Blockers/High）决定 A；选项仅来自允许集合 | **在 `.cursor/commands/review-req.md` 的「执行逻辑」或「输出格式」中约定**：审查结果输出后，由本对话 Agent 在末尾追加 A/B/C/D，格式与允许集合见本 req 附录 6.1、6.2、6.5 | 审查无 Blockers 时 A 为推进，有 Blockers 时 A 为改 req | 必须实现 |
| F3   | plan 步骤：有输出时末尾 A/B/C/D；先按附录 6.5 自评，通常 A=build；选项仅来自允许集合 | `.cursor/skills/plan-executor/SKILL.md` 或 `.cursor/commands/plan.md` 中约定格式、允许集合与自检维度 | 末尾出现四项，A 为 build 或与 6.2 一致               | 必须实现 |
| F4   | build 步骤：有输出时末尾 A/B/C/D；先按附录 6.5 自评，通常 A=review；选项仅来自允许集合 | `.cursor/skills/build-executor/SKILL.md` 或 `.cursor/commands/build.md` 中约定格式、允许集合与自检维度 | 末尾出现四项，A 为 review                           | 必须实现 |
| F5   | review 步骤：有输出时末尾 A/B/C/D；按审查结论（通过/有 Blockers）决定 A；选项仅来自允许集合 | `.cursor/skills/review-executor/SKILL.md` 或 `.cursor/commands/review.md` 中约定格式、允许集合与推荐逻辑 | 有 Blockers 时 A 为修复，通过时 A 为本任务已交付/无后续           | 必须实现 |
| F6   | remember、init 的下一步提示不改为 A/B/C/D，保持现有一句式提示            | 不修改 `.cursor/commands/remember.md`、`init.md` 及相关执行逻辑中的下一步表述                 | remember/init 后仍为一句建议，无 A/B/C/D           | 必须实现 |
| F7   | 各步「下一步建议」仅在该步本次已有正文输出时追加；纯静默成功时不追加      | 各 Command/Skill 的「输出规则」中明确「有输出时末尾追加」                | 静默成功场景无建议块；有输出时有 A/B/C/D           | 必须实现 |
| F8   | 用户仅回复 A/B/C/D 时，Agent 解析为对应选项并执行或引导执行对应命令（如执行对应 / 命令或提示用户输入命令） | 在各 Command 说明或对应 Skill 的「输出规则」中约定：当用户下一轮仅输入 A、B、C 或 D 时，视为选择该选项，Agent 应执行或引导执行该选项对应的动作（含具体命令示例时可直接引导用户执行该命令） | 输出建议后用户回复 A 或 B，Agent 能解析并执行/引导 | 必须实现 |

---

## 5. 文档同步清单

实现本需求时，需在以下文件中补充或更新「下一步建议」相关约定（输出格式、允许集合、质量自检维度、推荐逻辑、用户回复 A/B/C/D 的解析与引导）。具体变更说明见各功能需求 F1～F8 的实现方案列。

| 文档路径 | 变更类型 | 变更说明 |
| -------- | -------- | -------- |
| `.cursor/commands/req.md` | 更新 | 输出规则中增加：有输出时末尾追加 A/B/C/D；用户回复 A/B/C/D 时的解析与引导 |
| `.cursor/commands/review-req.md` | 更新 | 执行逻辑或输出格式中增加：审查结果输出后追加 A/B/C/D；格式与允许集合见 002.req 附录；用户回复 A/B/C/D 时的解析与引导 |
| `.cursor/commands/plan.md` | 更新 | 输出规则中增加：有输出时末尾追加 A/B/C/D；用户回复 A/B/C/D 时的解析与引导 |
| `.cursor/commands/build.md` | 更新 | 输出规则中增加：有输出时末尾追加 A/B/C/D；用户回复 A/B/C/D 时的解析与引导 |
| `.cursor/commands/review.md` | 更新 | 输出规则中增加：有输出时末尾追加 A/B/C/D；用户回复 A/B/C/D 时的解析与引导 |
| `.cursor/skills/req-executor/SKILL.md` | 更新 | 输出规则中增加：质量自检维度、推荐逻辑、下一步建议格式与允许集合、用户回复 A/B/C/D 的解析与引导 |
| `.cursor/skills/plan-executor/SKILL.md` | 更新 | 同上（plan 步骤） |
| `.cursor/skills/build-executor/SKILL.md` | 更新 | 同上（build 步骤） |
| `.cursor/skills/review-executor/SKILL.md` | 更新 | 同上（review 步骤） |

remember、init 无需修改。

---

## 6. 验收检查清单

- [ ] req、review-req、plan、build、review 五步的允许动作集合已写入附录，且实现/文档中引用。
- [ ] 五步的「质量自检维度」已写入附录 6.5，且实现/文档中引用。
- [ ] 五步在有输出时末尾均出现 A/B/C/D 四项，A 标注为推荐。
- [ ] req 在自检通过/不通过两种情况下 A 的推荐与附录 6.2 一致。
- [ ] review-req、review 在「有问题/无问题」「通过/未通过」下 A 的推荐与 6.2 一致。
- [ ] remember、init 未改为 A/B/C/D，仍为一句式。
- [ ] 选项中出现的命令均在附录允许集合内。
- [ ] 用户仅回复 A/B/C/D 时，Agent 能解析并执行或引导执行对应命令。

---

## 7. 附录

### 6.1 各步骤允许动作集合（选项仅限此集合）

| 步骤       | 允许动作（选项内容仅限下列之一或组合描述）                                                                 |
| ---------- | ---------------------------------------------------------------------------------------------------------- |
| **req**    | `/review-req <taskId>`、`/plan <taskId>`、`/build <taskId>`、补充/修改 req、其他/跳过                       |
| **review-req** | 再次 `/review-req <taskId>`、修改 req 后再说、`/plan <taskId>`、`/build <taskId>`、其他/跳过            |
| **plan**   | `/build <taskId>`、调整 plan、回头看 req、其他/跳过                                                         |
| **build**  | `/review <taskId>`、`/remember …` 沉淀、先改代码再 review、其他/跳过                                       |
| **review** | 修复后再 `/review <taskId>`、本任务已交付/无后续、`/remember …`、暂不修/其他                                  |

### 6.2 推荐逻辑（基于质量自检，供 Agent 参考）

推荐项 A 由**对当前输出质量的自我评估**决定：在给出下一步建议前，Agent 先基于该步骤的「质量自检维度」（见 6.5）做简短自评；自评通过（满足关键维度、无明显缺口）则推荐推进，不通过则推荐先改进。

- **req**  
  - 自检通过（目标/非目标清晰、有可验证验收标准、实现方案含关键文件、边界清晰）：A = `/build` 或 `/plan`（推荐），B = `/review-req` 查漏补缺，C = `/plan` 或 `/build`，D = 补充修改 req。  
  - 自检不通过（存在明显缺失或模糊）：A = `/review-req` 查漏补缺或补充修改（推荐），B = `/plan`，C = 补充修改 req，D = `/build` 立即 build。
- **review-req**  
  - 无 Blockers/High（或仅 Low）：A = `/plan` 或 `/build`（推荐），B = 修改后再 review，C = 再次 `/review-req`，D = 其他。  
  - 有 Blockers/High：A = 按建议改 req（推荐），B = 改完再 `/review-req`，C = `/plan` 暂不改，D = 其他。
- **plan**  
  - 自检通过（任务已拆解、依赖清晰、覆盖 req 主要需求、测试策略可执行）：A = `/build` 按计划实现（推荐），B = 调整 plan，C = 回头看 req，D = 其他。  
  - 自检不通过：A = 调整 plan 或回头看 req（推荐），B = `/build`，C/D = 其他。
- **build**  
  - 自检通过（已按 req/plan 实现、约定测试通过、无未完成项）：A = `/review` 做交付审查（推荐），B = `/remember` 沉淀，C = 先改代码再 review，D = 其他。  
  - 自检不通过：A = 先改代码再 review（推荐），B = `/review`，C/D = 其他。
- **review**  
  - 审查通过：A = 本任务已交付/无后续（推荐），B = `/remember` 沉淀，C = 再跑一遍 review，D = 其他。  
  - 有 Blockers/High：A = 修复后 `/review`（推荐），B = `/remember` 记问题，C = 暂不修，D = 其他。

### 6.3 remember 与 init（无需修改）

- **remember**：保持一句式，例如「下一步可尝试：继续当前任务即可，下次对话会自动参考新记忆。」
- **init**：保持一句式，例如「下一步可尝试：在本项目里用 /req、/build 等开始任务；有想单独记的可用 /remember …。」

### 6.4 输出格式约定

- 标题行：**下一步可尝试（选一项）**
- 四项格式：**A) 简短描述（推荐）**、**B) 简短描述**、**C) 简短描述**、**D) 简短描述**
- 描述中可含具体命令示例（如 `/build 001`），命令必须来自该步允许动作集合。

### 6.5 各步骤质量自检维度（供 Agent 自评当前输出质量）

在给出下一步建议前，Agent 可基于以下维度对**当前步骤的产出**做简短自评（可仅在推理中完成）；自评结果驱动推荐项 A 的选取（见 6.2）。

| 步骤       | 质量自检维度（自问：当前产出是否满足以下条件）                                                                 |
| ---------- | -------------------------------------------------------------------------------------------------------------- |
| **req**    | 是否有清晰目标与非目标？是否有可验证的验收标准？实现方案是否含关键文件或可执行指引？边界是否清晰？               |
| **review-req** | 本次审查是否发现 Blockers/High？若发现，是否已给出可操作的改进建议？                                        |
| **plan**   | 任务是否已拆解且依赖清晰？是否覆盖 req 的主要需求？测试策略是否可执行？                                       |
| **build**  | 是否已按 req/plan 实现？约定测试是否通过？是否有明显未完成项？                                                 |
| **review** | 审查结论是否为「通过」？是否仍有 Blockers/High 未关闭？                                                        |

若关键维度不满足或存在明显缺口，推荐 A 为先改进（review-req/补充修改/调整 plan/先改代码/修复后再 review）；若满足，推荐 A 为推进下一步（build/plan/review 或 本任务已交付/无后续）。
