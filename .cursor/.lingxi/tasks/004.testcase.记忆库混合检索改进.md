# 004.testcase.记忆库混合检索改进

| 属性     | 值                                |
| -------- | --------------------------------- |
| 关联需求 | 004.req.记忆库混合检索改进.md     |
| 关联规划 | 004.plan.记忆库混合检索改进.md     |
| 创建日期 | 2026-02-23                        |

---

## 1. 测试范围

### 1.1 覆盖的功能需求

| 需求编号 | 需求描述 | 测试用例编号 |
| -------- | -------- | ------------- |
| F1       | 增加关键词路径与语义路径并行 | TC-001, TC-003 |
| F2       | 并集 + 加权合并与取 top 0–3 | TC-001 |
| F3       | 语义不可用时降级为仅关键词，仍无匹配则静默 | TC-001, TC-004 |
| F4       | 候选放大再裁剪（每路 N 条、合并后 0–3） | TC-001 |
| F5       | 记忆系统文档与检索机制描述一致 | TC-002 |

### 1.2 不覆盖的范围

- 自建索引、分块、QMD、权重配置的自动化测试（本需求不实现）
- 语义搜索或 Grep 的引擎级单元测试（依赖 Cursor 能力，仅通过文档约定与手工验证）

---

## 2. 文档检查用例（可执行步骤）

### TC-001: memory-retrieve SKILL 检索策略与降级完整性

**前置条件**：

- 已完成 T1（SKILL.md 已按 req 更新）

**检查步骤**：

1. 打开 `.cursor/skills/memory-retrieve/SKILL.md`。
2. 确认「本 Skill 会用到的能力」或等价小节中，除语义检索外，包含对 **关键词** 或 **Grep** 或 **Search** 的表述，且范围包含 `.cursor/.lingxi/memory/notes/`（及可选 INDEX）。
3. 确认「检索策略」中包含：**双路径**（语义 + 关键词）、**并集**（或「不做交集」）、**加权**（含 0.7 / 0.3 或等价说明）、**取 top 0–3**、**候选放大**（每路取 N 条，如 8–10，合并后再取 0–3）。
4. 确认「失败降级」小节为：**优先语义** → 语义不可用或失败则**仅执行关键词路径** → 仍无匹配则**静默**，不输出「检索失败」。

**预期结果**：

- 上述 2–4 项均能在文档中找到对应表述，无矛盾。

**边界**：

- 权重数值可为 0.7/0.3 或「约 70%/30%」等等价描述；候选数可为 8–10 或固定值（如 10）。

---

### TC-002: memory-system 检索机制描述与 SKILL 一致

**前置条件**：

- 已完成 T2（memory-system.md 已更新）

**检查步骤**：

1. 打开 `.cursor/skills/about-lingxi/references/memory-system.md`。
2. 在「提取/注入」或「检索」相关段落中，确认存在对 **双路径**（语义 + 关键词）、**并集加权** 或 **召回优先**、**降级**（语义不可用 → 仅关键词 → 静默）的简述。
3. 若 `architecture.md` 中有记忆检索一句描述，确认已改为与上述策略一致。

**预期结果**：

- memory-system（及必要时 architecture）中检索机制描述与 SKILL 无矛盾，且包含双路径与降级要点。

---

## 3. 手工验证用例

### TC-003: 技术词/错误码命中与注入（端到端）

**场景描述**：验证在 notes 中存在包含某技术词或错误码的笔记时，用该词触发 memory-retrieve，该记忆能参与注入或出现在优先候选中。

**前置条件**：

- T1、T2 已完成；`.cursor/.lingxi/memory/notes/` 可写。
- 准备一条测试笔记：在 `memory/notes/` 下新建或选用一条笔记，内容中明确包含一技术词或错误码（例如 `E4012`、`sqlite-vec`、某配置项名），且 One-liner 或 When to load 便于识别。

**测试步骤**：

1. 在 Cursor 中开启新对话或确保 sessionStart 已注入「每轮先执行 /memory-retrieve <当前用户消息>」的约定。
2. 发送一条**以该技术词/错误码为核心**的用户消息（例如：「遇到 E4012 该怎么处理？」或「项目里 sqlite-vec 的约定是什么？」）。
3. 观察 Agent 是否执行 memory-retrieve，并在后续回答或内部决策中体现与这条笔记相关的内容（或至少将该笔记纳入候选并优先排序）。

**验证点**：

- 该笔记被检索到（可通过回复中自然引用、或 Agent 说明依据的记忆判断）。
- 无匹配时或语义失败降级时，不向用户输出「检索失败」等报错信息。

**预期结果**：

- 含技术词/错误码的笔记在以该词触发的 memory-retrieve 中被命中并参与注入或优先排序；降级时仍静默。

---

### TC-004: 降级行为（可选，条件允许时执行）

**场景描述**：在语义搜索不可用或模拟失败时，验证降级为仅关键词路径，且仍无匹配时静默。

**前置条件**：

- 具备可模拟「语义不可用」的环境或约定（例如在 Skill 中约定某条件下仅走关键词路径）；或依赖实际 Cursor 行为观察。

**测试步骤**：

1. 若可模拟：在仅执行关键词路径的条件下，对 notes 执行一次 memory-retrieve（用户消息含某技术词，且 notes 中存在包含该词的笔记），确认仍能命中并注入。
2. 在「仍无匹配」的条件下（如用户消息与 notes 内容无任何关键词重叠），确认 Agent 不输出「检索失败」，保持静默。

**预期结果**：

- 仅关键词路径时能命中含该词的笔记；无匹配时静默，不报错。

---

## 4. 测试数据准备

| 数据名称 | 数据内容 | 用途 |
| -------- | -------- | ---- |
| 测试笔记 | 一条 memory/notes/*.md，内容含明确技术词或错误码（如 E4012、sqlite-vec） | TC-003 端到端验证 |
| 用户消息 | 以该技术词/错误码为核心的短句（如「E4012 怎么处理？」） | TC-003 触发检索 |

---

## 5. 验收检查清单（与 req 对齐）

- [ ] TC-001 通过：SKILL 中检索策略含双路径、并集、加权、top 0–3、候选放大，失败降级为语义→关键词→静默。
- [ ] TC-002 通过：memory-system（及必要时 architecture）中检索机制描述与 SKILL 一致。
- [ ] TC-003 通过：至少 1 个技术词 + 1 条对应笔记的端到端验证中，该记忆被命中并参与注入或优先排序。
- [ ] TC-004（可选）：降级路径与无匹配静默行为符合约定。
