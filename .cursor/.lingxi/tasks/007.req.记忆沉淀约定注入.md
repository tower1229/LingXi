# 007.req.记忆沉淀约定注入

| 属性     | 值         |
| -------- | ---------- |
| 版本     | 1.0        |
| 创建日期 | 2025-02-23 |
| 需求类型 | 简单功能   |
| 复杂度   | 简单       |

---

## 1. 概述

### 1.1 背景

- 灵犀记忆写入由主 Agent 在判断「本轮存在可沉淀」时，通过显式调用 lingxi-memory 子代理（`/lingxi-memory mode=auto input=...` 或自然语言）完成。
- 「何时视为可沉淀、何时调用 lingxi-memory」的说明目前仅写在 `.cursor/commands/req.md`、`.cursor/skills/about-lingxi/references/memory-system.md` 等文档中；主 Agent 是否加载这些文档具有不确定性，约定仅来自文档等同于**没有稳定生效的约定**。
- 用户希望该约定**明确定义在灵犀 plugin 内**，一旦安装灵犀 plugin 即**自动生效**，不依赖主 Agent 是否读过某篇文档。

### 1.2 问题描述

- 沉淀触发场景与调用方式未在「安装即生效」的上下文中注入，主 Agent 可能从未看到该约定，导致该调用 lingxi-memory 时未调用、或判断标准不一致。
- 需要一种与现有「记忆库约定」「审计约定」一致的机制，在会话开始时将「记忆沉淀约定」一并注入。

### 1.3 解决方案概述

- 复用现有 **sessionStart hook** 机制：在 `.cursor/hooks/session-init.mjs` 中，将「记忆沉淀约定」作为一段固定文案追加到 `additional_context`（与现有的【记忆库约定】【沟通约定】【审计约定】并列）。
- sessionStart 在**每个新会话开始时**执行一次，输出的 `additional_context` 由 Cursor 注入该会话，主 Agent 在本会话内始终可见该约定，安装灵犀 plugin 后新会话即自动带上，无需依赖对 req.md / memory-system 的加载。
- 约定文案需包含：**触发场景**（何时视为可沉淀）、**调用方式**（语法与自然语言示例）、**原则**（宁可多候选再门控，判断宜放宽）。

---

## 2. 目标

| 编号 | 目标 | 优先级   |
| ---- | ---- | -------- |
| G1   | 「记忆沉淀约定」在 plugin 内明确定义，并随 sessionStart 注入到每个新会话 | 必须实现 |
| G2   | 约定内容包含触发场景、调用方式与原则，与现有 memory-system / req 文档表述一致 | 必须实现 |

---

## 3. 功能需求

| 编号 | 需求描述 | 实现方案 | 验收标准 | 优先级   |
| ---- | -------- | -------- | -------- | -------- |
| F1   | 在 sessionStart 注入内容中增加「记忆沉淀约定」段落 | 在 `.cursor/hooks/session-init.mjs` 中新增常量（如 `PRECIPITATE_CONTEXT` 或等效），内容包含：**触发场景**（任务完成或关键决策出现；需求固化、范围调整、优先级变更；目标纠正、方案选择、约束添加；边界明确、验收调整、风险确认；用户拒绝、纠正、排除如「不要/别用/改成…」）；**调用方式**（`/lingxi-memory mode=auto input=<本轮要点>` 或自然语言「使用 lingxi-memory 子代理将可沉淀内容写入记忆库」）；**原则**（宁可多候选再门控，对「是否可沉淀」的判断宜放宽，交由子代理与用户门控做最终筛选）。将该段与现有 `BASE_CONTEXT`、`auditContext` 一起拼入 `additional_context` | 新会话开始时，主 Agent 可见的注入内容中包含上述触发场景、调用方式与原则；或打开 `session-init.mjs` 可看到新增的沉淀约定常量并已拼入输出 | 必须实现 |

---

## 4. 非目标

- 不修改 lingxi-memory 子代理（`.cursor/agents/lingxi-memory.md`）的职责与输入输出约定。
- 不修改 memory-retrieve 或 memory-system 的检索/注入逻辑。
- 不删除或弱化 req.md、memory-system 等文档中已有的沉淀说明；文档可保留作为补充，但「安装即生效」的单一事实来源为 session-init 的注入内容。

---

## 5. 验收检查清单

- [ ] `.cursor/hooks/session-init.mjs` 中存在「记忆沉淀约定」相关常量或文案，且已拼入 `additional_context`。
- [ ] 约定文案包含：触发场景（含用户拒绝/纠正/排除）、调用方式（mode=auto 与自然语言示例）、原则（宁可多候选再门控 / 判断宜放宽）。
- [ ] 新开会话后，注入的约定中可识别到上述沉淀约定内容（可通过会话上下文或本地阅读 session-init 输出逻辑验证）。
