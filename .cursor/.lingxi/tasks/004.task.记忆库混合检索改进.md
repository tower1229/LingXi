# 004.task.记忆库混合检索改进

| 属性     | 值       |
| -------- | -------- |
| 版本     | 1.0      |
| 状态     | 草稿     |
| 创建日期 | 2026-02-23 |
| 需求类型 | 后端     |
| 复杂度   | 中等     |

---

## 1. 概述

### 1.1 背景

- 灵犀记忆库当前仅依赖 Cursor 工作区**语义搜索**对 `.cursor/.lingxi/memory/notes/` 做检索，每轮由 sessionStart 约定触发 memory-retrieve，注入 0–3 条记忆以保持「心有灵犀」。
- 开发场景下，用户常需**精确命中**技术名词、错误码、配置项、API 名等；纯语义检索易漏掉仅字面匹配即可命中的笔记，或把精确标识符“模糊化”，降低用户对工作流检索能力的信任。
- 参考 OpenClaw 记忆系统：采用 BM25 关键词 + 向量语义的**混合检索**、**并集加权合并**、**召回优先**与**优雅降级**，在技术词与自然语言查询上均能取得更好召回；经对比分析，灵犀不引入自建索引与分块，仅借鉴「双路径并行 + 合并策略 + 降级」即可带来明显收益。

### 1.2 问题描述

- **痛点**：技术名词、错误码等需精确命中的内容仅靠语义检索易漏或排序靠后，漏掉本该匹配的记忆会降低用户对灵犀工作流的信任。
- **范围**：仅改进**检索与合并策略**，不改变记忆库存储形态（单条精炼、无大文档）、不引入自建 SQLite/向量索引。

### 1.3 解决方案概述（不含技术实现细节）

- **双路径检索**：在现有「对 notes/ 语义搜索」之外，增加**关键词路径**——对同一目录（及必要时 INDEX 的 Title/When to load）做关键词/短语匹配（依赖 Cursor 的 Grep / Search 能力），两条路径并行。
- **并集 + 加权合并**：两条路径取**并集**（不做“两路都命中才保留”），对每条候选按权重综合打分（如 0.7×语义分 + 0.3×关键词分），再取 top 0–3 做最小注入；**召回优先**，减少漏匹配。
- **候选放大再裁剪**：每条路径各取若干候选（如 8–10 条），合并去重后按综合分排序，再取最终 0–3 条，以提升最终注入列表质量。
- **优雅降级**：语义搜索不可用或失败时，降级为仅执行关键词路径；仍无匹配则静默，不向用户报“检索失败”。
- **实现载体**：检索由 Agent 按 memory-retrieve Skill 执行，无独立服务；通过**更新 Skill 文档**约定上述策略与步骤，使 Agent 在每轮 memory-retrieve 时按新流程执行（语义 + Grep，合并，取 top 0–3）；不新增脚本或后端服务。

---

## 2. 目标与指标

### 2.1 目标

| 编号 | 目标 | 优先级   |
| ---- | ---- | -------- |
| G1   | 在 memory-retrieve 中增加关键词路径，与语义路径并行，提升技术名词/错误码等精确命中的召回 | 必须实现 |
| G2   | 采用并集 + 加权合并，召回优先，减少“本该匹配却漏掉”的情况 | 必须实现 |
| G3   | 语义不可用时降级为关键词路径，仍无匹配则静默，不报错 | 必须实现 |
| G4   | 候选放大再裁剪（每路多取若干条，合并后取 top 0–3），提升最终注入质量 | 应该实现 |

### 2.2 非目标

- **不做**：自建 SQLite/FTS5/向量索引、嵌入流水线或索引重建逻辑。
- **不做**：记忆分块、重叠或大文档记忆支持；保持单条记忆精炼。
- **不做**：双层记忆（每日日志 + 持久）或会话压缩驱动的写入；与 OpenClaw 场景不同。
- **不做**：QMD 式查询扩展或交叉编码器重排序（成本高，收益对本场景有限）。
- **不做**：可配置权重的前端或配置文件（首版可写死权重，文档说明可调即可）。

### 2.3 成功标准（必须可验证）

| 标准 | 描述 | 验证方式 |
| ---- | ---- | -------- |
| S1   | 检索策略文档明确包含「语义 + 关键词双路径、并集、加权合并、取 top 0–3」 | 阅读 memory-retrieve SKILL 与 memory-system 相关章节 |
| S2   | 失败降级约定为：语义不可用 → 仅关键词路径；仍无匹配 → 静默 | 阅读 SKILL 中「失败降级」小节 |
| S3   | 执行 memory-retrieve 时 Agent 能按新策略执行（双路径、合并、降级） | 手工：在 notes 中放入含技术名词/错误码的笔记，用含该词的用户消息触发检索，观察是否命中并注入 |
| S4   | 候选放大再裁剪在策略中有明确描述（每路取 N 条、合并后取 0–3） | 阅读 SKILL 检索策略小节 |

---

## 3. 用户故事（至少 1 条）

### US-1: 开发时技术词能稳定命中记忆

**作为** 使用灵犀工作流的开发者  
**我想要** 在提到某个错误码、配置项或 API 名时，相关记忆能被检索到并注入  
**以便** 模型能按项目约定和排障经验回答，减少漏掉本该参考的记忆，保持对工作流的信任。

**验收标准：**

- [ ] memory-retrieve 的检索策略中包含关键词路径及与语义结果的合并方式
- [ ] 在 notes 中存在包含特定技术词/错误码的笔记时，用该词作为用户消息触发检索，能在注入中出现该记忆（或在其候选中被优先考虑）

---

## 4. 功能需求

| 编号 | 需求描述 | 实现方案 | 验收标准 | 优先级   |
| ---- | -------- | -------- | -------- | -------- |
| F1   | 在 memory-retrieve 中增加关键词路径，与语义路径并行 | 关键文件：`.cursor/skills/memory-retrieve/SKILL.md`。在「检索策略」中增加：对 `.cursor/.lingxi/memory/notes/`（及必要时 INDEX 中 Title/When to load）使用 Cursor 提供的 Grep/搜索能力，以当前用户消息中的技术词/短语为查询做关键词匹配；约定每路取候选数（如语义 Top 8–10，关键词 Top 8–10） | 文档中明确双路径、关键词来源与范围 | 必须实现 |
| F2   | 约定并集 + 加权合并与最终取 top 0–3 | 同上。在 SKILL 中约定：两路结果按并集合并；对每条候选赋予综合分（如 0.7×语义分 + 0.3×关键词分，关键词排名可映射为 0–1）；按综合分排序后取 top 0–3 做最小注入；说明召回优先、不做交集 | 文档中明确合并公式与取数规则 | 必须实现 |
| F3   | 语义不可用时降级为仅关键词路径，仍无匹配则静默 | 关键文件：`.cursor/skills/memory-retrieve/SKILL.md`。「失败降级」小节更新为：优先语义；若语义不可用或失败，则仅执行关键词路径；若仍无匹配则静默，不输出「检索失败」 | 文档与行为一致；手工或对话验证降级路径 | 必须实现 |
| F4   | 候选放大再裁剪（每路多取、合并后取 0–3） | 同上。在检索策略中明确：语义路径取 Top N（如 8–10），关键词路径取 Top N，合并去重后按综合分排序，再取 top 0–3 | 文档中有明确数字或范围说明 | 应该实现 |
| F5   | 记忆系统文档与 about-lingxi 中检索机制描述与新策略一致 | 关键文件：`.cursor/skills/about-lingxi/references/memory-system.md`（及必要时 architecture.md）。在「提取/注入」或检索相关小节中简述：memory-retrieve 采用语义 + 关键词双路径、并集加权合并、召回优先及降级策略 | 文档无矛盾、检索机制描述更新 | 应该实现 |

**实现说明**：执行层为 Agent 按 SKILL 约定操作，无需新增仓库内脚本；若后续需要辅助脚本（如从用户消息中提取关键词列表）可单独开需求。

---

## 5. UI 交互规范（前端需求）

不适用（本需求无前端界面）。

---

## 6. API 规范（后端需求）

不适用（无新增 HTTP API；检索由 Agent 在 Cursor 工作区内执行）。

---

## 7. 数据模型（后端中等+复杂度）

不适用（无新增数据表或持久化结构；记忆库仍为 INDEX.md + notes/*.md）。

---

## 8. 依赖与集成（中等+复杂度）

### 8.1 外部依赖

- **Cursor 工作区语义搜索**：现有能力，用于语义路径。
- **Cursor 提供的 Grep / Search files and folders（或等价能力）**：用于关键词路径，对 `memory/notes/` 及可选 INDEX 做文本匹配。

### 8.2 集成方式

- 检索完全在 Agent 执行 memory-retrieve 时完成：先发起语义搜索，再发起关键词搜索（查询词来源于当前用户消息或其提炼），在 Skill 约定下于同一轮内完成合并与取 top 0–3。

---

## 9. 技术可行性（后端需求）

### 9.1 技术难点

- **关键词提取**：从用户消息中得到用于 grep 的词/短语，需兼顾噪声与召回；Skill 层可约定“以用户消息中的技术词、错误码、配置项名等为主”，由 Agent 自然语言理解后执行，不强制脚本提取。
- **分数归一化**：语义结果为 Cursor 返回的排序/相关性，关键词结果为命中条数或排名；需在 SKILL 中约定简单映射（如关键词排名倒数 1/(1+rank) 到 0–1），以便与语义侧加权合并。

### 9.2 风险评估

- 若 Cursor 未暴露 grep 或等价能力给 Agent：则关键词路径退化为“按 INDEX 或 notes 文件名/标题做文本匹配”等现有能力，仍可部分达成精确命中；文档中可注明依赖 Cursor 的搜索能力边界。

### 9.3 可行性结论

- 在“仅更新 Skill 与文档、不新增服务”的前提下可行；依赖 Cursor 现有语义搜索与文件/内容搜索能力，风险可控。

---

## 10. 验收检查清单

- [ ] `.cursor/skills/memory-retrieve/SKILL.md` 中检索策略包含：语义路径 + 关键词路径、并集、加权合并、取 top 0–3、候选放大再裁剪的明确描述
- [ ] 失败降级更新为：语义不可用 → 仅关键词路径；仍无匹配 → 静默
- [ ] `.cursor/skills/about-lingxi/references/memory-system.md`（及必要时 architecture）中检索机制描述与上述策略一致
- [ ] 手工验证：含技术词/错误码的笔记能在以该词触发的 memory-retrieve 中被命中并参与注入或优先排序

---

## 11. 附录（复杂需求）

### 11.1 外部参考

- OpenClaw 记忆系统：混合检索（BM25 + 向量）、并集加权合并、召回优先、优雅降级（见项目内计划文档与 OpenClaw 官方 memory 文档）。
- 灵犀计划文档：`.cursor/plans/灵犀记忆库改进思路_e99807a3.plan.md`（若存在）或同主题分析结论。

### 11.2 关键决策记录

| 决策点 | 备选方案 | 最终选择 | 理由 |
| ------ | -------- | -------- | ---- |
| 关键词路径实现方式 | A) 自建 SQLite FTS5；B) 使用 Cursor Grep/搜索能力 | B | 零运维、与现有“无自建索引”一致；先验证收益再考虑 A |
| 权重是否可配置 | A) 配置文件；B) 写死 0.7/0.3，文档说明可调 | B | 降低首版复杂度，后续可按需加配置 |
| 是否做分块/重叠 | 做 / 不做 | 不做 | 灵犀保持单条精炼、不支持大文档记忆 |
| 是否引入 QMD/重排序 | 引入 / 不引入 | 不引入 | 成本高，技术词精确命中已由关键词路径覆盖 |
