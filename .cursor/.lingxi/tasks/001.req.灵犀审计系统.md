# 001.req.灵犀审计系统

| 属性     | 值         |
| -------- | ---------- |
| 版本     | 1.0        |
| 状态     | 草稿       |
| 创建日期 | 2025-02-03 |
| 需求类型 | 全栈       |
| 复杂度   | 中等       |

---

## 1. 概述

### 1.1 背景

- 灵犀的产品形态目标是尽可能隐形以减少对用户的打扰，因此需要审计能力以便事后追溯「谁在何时做了什么」。
- Cursor Hooks 官方能力边界明确支持「审计日志：记录命令执行和响应」；灵犀架构中 Hooks 已预留「可选审计/门控」。
- 记忆库写入发生在 lingxi-memory 子代理内部，主 Agent 的 Hooks 看不到具体对哪条 note 做了增删改，需要记忆侧主动上报事件以实现事件级审计与会话级关联。

### 1.2 问题描述

- 当前无统一审计日志，无法回答「刚才灵犀做了什么」「某会话里记忆库发生了什么」。
- 主 Agent 行为（用户输入、Agent 回复、工具调用、子代理启停）与记忆库演变缺乏会话级关联键，无法做联合查询与完整时间线还原。

### 1.3 解决方案概述（不含技术实现细节）

- **主审计**：通过 Cursor Hooks 在 agent 循环各阶段（beforeSubmitPrompt、afterAgentResponse、postToolUse、postToolUseFailure、subagentStart、subagentStop、sessionEnd、stop）触发同一审计脚本，将事件写入统一 NDJSON 日志；不调用大模型，仅追加写入。
- **记忆库审计**：在 lingxi-memory 子代理每次写 note/INDEX 后，在同一流程内追加一条事件级记录（memory_note_created/updated/deleted、memory_index_updated），与主审计共用同一日志文件；会话信息（conversation_id、generation_id）由主 Agent 在调用子代理时通过 input 传入。
- **会话级关联**：主日志与记忆库日志均包含 conversation_id（及可选 generation_id）；sessionStart 约定中注入「当前会话 ID，调用 lingxi-memory 时请在 input 中传入 conversation_id」。
- **INDEX 扩展**：在 memory/INDEX 表与 note Meta 中增加 CreatedAt、UpdatedAt、Source、Session（或 CreatedInSession/UpdatedInSession），用于「当前状态」的快速查看与治理，与事件级审计互补。

---

## 2. 目标与指标

### 2.1 目标

| 编号 | 目标                                                                               | 优先级   |
| ---- | ---------------------------------------------------------------------------------- | -------- |
| G1   | 主审计：用户提交、Agent 回复、工具调用、子代理启停、会话结束等事件可追溯           | 必须实现 |
| G2   | 记忆库审计：每次记忆创建/更新/删除记一条事件，与主审计共用同一日志                 | 必须实现 |
| G3   | 主日志与记忆库日志支持按 conversation_id（及可选 generation_id）做会话级关联       | 必须实现 |
| G4   | 审计全程不调用大模型、不增加用户操作，符合隐形与静默成功原则                       | 必须实现 |
| G5   | INDEX 扩展：每条记忆可查 CreatedAt、UpdatedAt、Source、Session，满足简易日志与治理 | 必须实现 |

### 2.2 非目标

- 本需求不包含：门控（拦截/拒绝）逻辑、审计数据的远端上报、审计日志的自动轮转与保留策略的详细实现（可约定路径与格式，具体策略可后续迭代）。
- 不包含：基于审计日志的「刚才灵犀做了什么」的问答 Skill/Command 实现（数据能力具备后可由单独任务实现）。

### 2.3 成功标准（必须可验证）

| 标准 | 描述                                                                                                 | 验证方式                          |
| ---- | ---------------------------------------------------------------------------------------------------- | --------------------------------- |
| S1   | 主审计：beforeSubmitPrompt 等 8 类事件触发时，audit 文件中出现对应 NDJSON 行                         | 触发各 Hook 后检查 audit 文件     |
| S2   | 记忆审计：子代理写 note/INDEX 后，audit 文件中出现 memory*note*\* / memory_index_updated 行          | 执行 /remember 或 auto 写入后检查 |
| S3   | 会话关联：主审计行与记忆审计行均含 conversation_id；同一会话内可过滤出完整事件集                     | 按 conversation_id 过滤并核对     |
| S4   | sessionStart 约定中包含「调用 lingxi-memory 时传入 conversation_id」的说明                           | 查看 session-init 输出约定        |
| S5   | INDEX 表含 CreatedAt、UpdatedAt、Source、Session（或等价字段）；新写/更新 note 后 INDEX 中对应行更新 | 写一条记忆后检查 INDEX 内容       |

---

## 3. 用户故事（至少 1 条）

### US-1: 事后追溯会话内行为

**作为** 灵犀使用者
**我想要** 在需要时能查到「某次会话里用户发了什么、Agent 用了哪些工具、记忆库发生了哪些变更」
**以便** 排障、合规或回答「刚才灵犀做了什么」。

**验收标准：**

- [ ] 存在统一审计日志文件（如 `.cursor/.lingxi/workspace/audit.log`），格式为 NDJSON。
- [ ] 可按 conversation_id 过滤出该会话的主审计事件与记忆审计事件，并按时间排序得到完整时间线。

### US-2: 记忆库演变可查

**作为** 灵犀使用者
**我想要** 知道某条记忆是何时创建/更新、由哪次会话触发
**以便** 治理记忆与排查「为什么某条记忆被改动了」。

**验收标准：**

- [ ] 每条记忆审计事件包含 event、note_id、conversation_id、ts、operation、source 等字段。
- [ ] INDEX 中每条记忆有 CreatedAt、UpdatedAt、Source、Session（或等价字段），便于快速查看「当前状态」。

---

## 4. 功能需求

| 编号 | 需求描述                                                                                                                                                                                          | 实现方案                                                                                                                           | 验收标准                                                    | 优先级   |
| ---- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------- | -------- |
| F1   | 主审计脚本：从 stdin 读 Hook 入参，写一条 NDJSON 到统一 audit 文件，并按事件类型返回最小合法 JSON                                                                                                 | `.cursor/hooks/lingxi-audit.mjs`；复用 `_hook-utils.mjs` 的 readStdinJson；appendFileSync 到 `.cursor/.lingxi/workspace/audit.log` | 各 Hook 触发后 audit 中有一行且主流程不中断                 | 必须实现 |
| F2   | hooks.json 中注册 beforeSubmitPrompt、afterAgentResponse、postToolUse、postToolUseFailure、subagentStart、subagentStop、sessionEnd、stop 调用审计脚本                                             | `.cursor/hooks.json` 增加上述 8 个事件的 command 指向 lingxi-audit.mjs                                                             | 配置存在且路径正确（项目级 `.cursor/hooks/...`）            | 必须实现 |
| F3   | 主审计记录包含 ts、conversation_id、generation_id、event 及事件特有字段摘要（如 prompt_preview、tool_name、duration 等），不落全文                                                                | lingxi-audit.mjs 内按 hook_event_name 分支生成 payload，控制体积与敏感信息                                                         | 抽查若干行，字段齐全且无超大 body                           | 必须实现 |
| F4   | sessionStart 约定中增加「当前会话 ID；调用 lingxi-memory 时请在 input 中传入 conversation_id（及可选 generation_id）」                                                                            | `.cursor/hooks/session-init.mjs` 的 ADDITIONAL_CONTEXT 中增加上述约定；session_id 来自 sessionStart 入参                           | 新会话开始时约定中包含会话 ID 与传入要求                    | 必须实现 |
| F5   | lingxi-memory 子代理从 input 解析 conversation_id、generation_id；每次写 note/INDEX 后追加一条记忆审计行到同一 audit 文件                                                                         | `.cursor/agents/lingxi-memory.md` 约定解析与写入；写入逻辑在子代理执行写入后追加 NDJSON 行                                         | 写记忆后 audit 中出现 memory*note*\* 行且含 conversation_id | 必须实现 |
| F6   | 记忆审计事件类型：memory_note_created、memory_note_updated、memory_note_deleted、memory_index_updated（可选）；字段含 ts、event、conversation_id、generation_id、note_id、operation、source、file | 子代理写入后根据操作类型生成对应 event 与字段，appendFileSync 同一 audit 文件                                                      | 创建/更新/删除 note 后对应 event 与字段正确                 | 必须实现 |
| F7   | INDEX 表与 note Meta 扩展：CreatedAt、UpdatedAt、Source、Session（或 CreatedInSession/UpdatedInSession）；写入/更新 note 时更新 INDEX 对应行与 note 内 Meta                                       | memory/INDEX.md 表头与行内容；memory/references/memory-note-template.md 与 memory-system 文档约定字段                              | 新写或更新一条记忆后 INDEX 与 note 内时间/会话字段正确      | 必须实现 |
| F8   | 审计脚本异常时仍返回「放行」JSON（如 continue: true、decision: "allow"），不阻塞主流程                                                                                                            | lingxi-audit.mjs 内 try/catch，catch 中 writeStdoutJson 放行并可选写 error 日志                                                    | 模拟脚本异常时 Hook 仍放行                                  | 必须实现 |

---

## 5. 依赖与集成

### 5.1 外部依赖

- Cursor Hooks：依赖 Cursor 提供的 Hook 事件与 stdio JSON 协议；项目级 hooks 路径为 `.cursor/hooks.json`，脚本从项目根执行。
- 无新增第三方 npm 包；使用 Node 内置 fs、path 等即可。

### 5.2 集成方式

- 主审计与现有 sessionStart（session-init.mjs）并存：sessionStart 继续负责记忆检索约定与会话 ID 注入；新增 8 个 Hook 仅调用审计脚本。
- 记忆审计由 lingxi-memory 子代理在现有「产候选 → 治理 → 门控 → 写入」流程末尾追加一次 append，不改变现有写入语义。

---

## 6. 技术可行性

### 6.1 技术难点

- **并发写同一 audit 文件**：主进程 Hook 与子代理可能并发 append。需使用 appendFileSync 或等价原子追加，避免交叉写坏行；若平台保证「单行 append」原子性，则 NDJSON 按行追加可接受。
- **子代理获取 conversation_id**：依赖主 Agent 在调用子代理时传入；若主 Agent 未传，记忆审计行中 conversation_id 可为空，会话关联降级为「仅主日志按会话查」。

### 6.2 风险评估

| 风险                          | 影响                   | 缓解措施                                                         |
| ----------------------------- | ---------------------- | ---------------------------------------------------------------- |
| Hook 脚本超时或异常           | 主流程被阻塞或被错误拦截     | 脚本内快速返回、catch 后统一返回放行 JSON；Hook 配置可设 timeout |
| audit 文件过大                | 查询与磁盘占用         | 后续可做按日轮转或按大小切割；本需求仅约定路径与格式             |
| 主 Agent 未传 conversation_id | 记忆事件无法按会话过滤 | 文档与约定明确要求传入；子代理侧对缺失做降级（留空或 unknown）   |

### 6.3 可行性结论

- 主审计与记忆审计均不调用大模型，仅文件追加；Cursor Hooks 文档已明确各事件入参与出参，可实现。
- 会话级关联依赖约定（sessionStart 注入 + 主 Agent 传入），无额外基础设施要求，可行。

---

## 7. 验收检查清单

- [ ] 主审计：8 类 Hook 事件均能触发并写入 audit.log，且返回正确放行/决策 JSON。
- [ ] 记忆审计：子代理创建/更新/删除 note 及更新 INDEX 后，audit 中出现对应 memory\_\* 行，且含 conversation_id（在主 Agent 传入时）。
- [ ] sessionStart 约定中包含会话 ID 与「调用 lingxi-memory 时传入 conversation_id」的说明。
- [ ] INDEX 与 note Meta 含 CreatedAt、UpdatedAt、Source、Session（或等价字段）；写入/更新后内容正确。
- [ ] 按 conversation_id 过滤 audit 文件可得到该会话的主事件与记忆事件，并按 ts 可排序。
- [ ] 审计脚本异常时主流程不被拦截（返回放行 JSON）。

---

## 8. 附录

### 8.1 关键决策记录

| 决策点         | 备选方案                                 | 最终选择            | 理由                                                    |
| -------------- | ---------------------------------------- | ------------------- | ------------------------------------------------------- |
| 主审计实现方式 | Command/Skill 显式调用 vs Hooks 自动触发 | Hooks               | 隐形、无需用户操作；符合官方「审计日志」适用场景        |
| 记忆审计粒度   | 仅 INDEX 扩展 vs 事件级流                | 事件级流            | 满足「记忆库事件级审计」与完整时间线                    |
| 记忆审计存储   | 独立文件 vs 与主审计同一文件             | 同一文件            | 统一时间线、按 conversation_id 一次过滤即可             |
| 会话 ID 传递   | 子代理环境变量 vs 主 Agent input 传入    | 主 Agent input 传入 | Cursor 未保证子代理继承主会话 env；input 可控且可文档化 |
| INDEX 扩展     | 不做 vs 做                               | 做                  | 简易日志与治理、当前状态快速查看，与事件级审计互补      |

### 8.2 审计事件字段约定

审计日志每行一条 NDJSON；字段类型与取值约定如下，便于实现与后续解析工具统一。

**类型约定**：`string`、`number`；未标注「可选」的字段为必填。时间统一为 ISO 8601 字符串（如 `2025-02-04T12:00:00.000Z`）。

#### 主审计（8 类事件）

公共字段（所有主审计行必含）：

| 字段              | 类型   | 说明                                        |
| ----------------- | ------ | ------------------------------------------- |
| `ts`              | string | 事件发生时间，ISO 8601                      |
| `event`           | string | 事件名，见下表                              |
| `conversation_id` | string | 会话 ID；来源为 sessionStart 入参或上游传入 |
| `generation_id`   | string | 可选。当前轮次/生成 ID，有则填              |

`event` 取值及事件特有字段：

| event                   | 说明           | 事件特有字段（均为可选，控制体积与敏感信息）                               |
| ----------------------- | -------------- | -------------------------------------------------------------------------- |
| `before_submit_prompt`  | 用户提交前     | `prompt_preview`: string，截断摘要（如前 200 字符）                        |
| `after_agent_response`  | Agent 回复后   | `duration_ms`: number；`reply_preview`: string，截断摘要                   |
| `post_tool_use`         | 工具调用成功后 | `tool_name`: string；`duration_ms`: number；`result_preview`: string，截断 |
| `post_tool_use_failure` | 工具调用失败后 | `tool_name`: string；`error_preview`: string，截断                         |
| `subagent_start`        | 子代理启动     | `agent_name`: string（如 `lingxi-memory`）                                 |
| `subagent_stop`         | 子代理结束     | `agent_name`: string；`duration_ms`: number                                |
| `session_end`           | 会话结束       | 无额外字段                                                                 |
| `stop`                  | 停止           | 无额外字段                                                                 |

事件名与 Cursor Hook 名的对应关系由审计脚本在实现时映射（如 `beforeSubmitPrompt` → `before_submit_prompt`），上表为写入 audit 的 `event` 取值。

#### 记忆审计（4 类事件）

公共字段（所有记忆审计行必含）：

| 字段              | 类型   | 说明                                         |
| ----------------- | ------ | -------------------------------------------- |
| `ts`              | string | 事件发生时间，ISO 8601                       |
| `event`           | string | 事件名，见下表                               |
| `conversation_id` | string | 可选。主 Agent 传入时填写；未传可为空或 `""` |
| `generation_id`   | string | 可选。主 Agent 传入时填写                    |

`event` 取值及事件特有字段：

| event                  | 说明       | 事件特有字段                                                                                                                   |
| ---------------------- | ---------- | ------------------------------------------------------------------------------------------------------------------------------ |
| `memory_note_created`  | 记忆创建   | `note_id`: string；`operation`: string（如 `create`）；`source`: string（如 `user`/`auto`）；`file`: string，note 文件相对路径 |
| `memory_note_updated`  | 记忆更新   | 同上                                                                                                                           |
| `memory_note_deleted`  | 记忆删除   | `note_id`: string；`operation`: string（如 `delete`）；`file`: string                                                          |
| `memory_index_updated` | INDEX 更新 | 无 `note_id`；可选 `reason`: string（如 `batch_refresh`）                                                                      |

记忆审计的 `source` 取值与 INDEX/note Meta 中的 Source 约定一致（参见 memory-system）；若尚未枚举，实现时先用自由字符串，后续在 memory 文档中收口。

### 8.3 参考

- Cursor Hooks 文档：https://cursor.com/docs/agent/hooks
- 灵犀架构：`.cursor/skills/about-lingxi/references/architecture.md`
- 记忆系统：`.cursor/skills/about-lingxi/references/memory-system.md`
- 组件指南（Hooks 适用场景）：`.cursor/skills/about-lingxi/references/component-guides.md`
