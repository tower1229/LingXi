# 001.testcase.灵犀审计系统

| 属性     | 值                       |
| -------- | ------------------------ |
| 关联需求 | 001.task.灵犀审计系统.md  |
| 关联规划 | 001.plan.灵犀审计系统.md |
| 创建日期 | 2025-02-04               |

---

## 1. 测试范围

### 1.1 覆盖的功能需求

| 需求编号 | 需求描述概要                                                  | 测试用例编号           |
| -------- | ------------------------------------------------------------- | ---------------------- |
| F1       | 主审计脚本：读 stdin、写 NDJSON、返回放行                     | TC-001, TC-002, TC-003 |
| F2       | hooks.json 注册 8 类事件                                      | TC-004                 |
| F3       | 主审计记录字段（ts、event、conversation_id 等）               | TC-001, TC-002         |
| F4       | sessionStart 约定含会话 ID 与 lingxi-memory 传入要求          | TC-005                 |
| F5       | 子代理解析 conversation_id；写 note/INDEX 后追加记忆审计行    | TC-006, TC-007         |
| F6       | 记忆审计事件类型与字段                                        | TC-006, TC-007         |
| F7       | INDEX 与 note Meta 扩展 CreatedAt、UpdatedAt、Source、Session | TC-008                 |
| F8       | 审计脚本异常时返回放行、不阻塞主流程                          | TC-009                 |

### 1.2 不覆盖的范围

- 审计日志轮转、保留策略、远端上报（非目标）
- 基于审计日志的「刚才灵犀做了什么」问答 Skill/Command（单独任务）

---

## 2. 集成/手工测试用例

### TC-001: 主审计 — 单次 Hook 触发后 audit 有一行 NDJSON

**前置条件**：

- T1、T2 已完成；audit 文件路径为 `.cursor/.lingxi/workspace/audit.log`（或 req 约定路径）
- 可触发至少一种 Hook（如 beforeSubmitPrompt：用户提交一条消息）

**测试步骤**：

1. 清空或备份现有 audit.log（可选）
2. 在 Cursor 中提交一条用户消息，触发 agent 循环
3. 打开 `.cursor/.lingxi/workspace/audit.log`，查看新增行

**预期结果**：

- 文件中出现至少一行 NDJSON
- 该行可被 `JSON.parse` 解析；包含 `ts`、`event`、`conversation_id`（或占位）
- 主流程未中断（对话正常进行）

**边界条件**：

- 首次运行：workspace 目录不存在时，脚本应先创建目录再写入（或由安装脚本预先创建）

---

### TC-002: 主审计 — 8 类事件均有对应 event 写入

**前置条件**：

- T1、T2 已完成；能触发到 8 类事件（beforeSubmitPrompt、afterAgentResponse、postToolUse、postToolUseFailure、subagentStart、subagentStop、sessionEnd、stop）

**测试步骤**：

1. 通过正常使用（发消息、用工具、启停子代理、结束会话等）尽量覆盖 8 类事件
2. 检查 audit.log 中出现的 `event` 取值

**预期结果**：

- 与 req §8.2 主审计 event 一致：`before_submit_prompt`、`after_agent_response`、`post_tool_use`、`post_tool_use_failure`、`subagent_start`、`subagent_stop`、`session_end`、`stop`
- 每类事件特有字段符合约定（如 post_tool_use 含 tool_name、duration_ms 等）

---

### TC-003: 主审计 — Hook 返回放行 JSON

**前置条件**：

- T1 完成；Hook 配置指向 lingxi-audit.mjs

**测试步骤**：

1. 触发任意已注册 Hook
2. 观察主流程是否被拦截（对话/工具调用是否正常继续）

**预期结果**：

- 主流程不中断；Cursor 收到脚本 stdout 的合法放行 JSON（如 continue: true / decision: "allow"）

---

### TC-004: hooks.json 配置正确

**前置条件**：

- T2 已完成

**测试步骤**：

1. 打开 `.cursor/hooks.json`
2. 检查 hooks 下是否存在：beforeSubmitPrompt、afterAgentResponse、postToolUse、postToolUseFailure、subagentStart、subagentStop、sessionEnd、stop
3. 检查每个 command 指向项目内 `lingxi-audit.mjs` 的路径是否正确

**预期结果**：

- 8 个 key 均存在；command 路径可解析（如 `node .cursor/hooks/lingxi-audit.mjs`）

---

### TC-005: sessionStart 约定包含会话 ID 与 lingxi-memory 传入要求

**前置条件**：

- T3 已完成

**测试步骤**：

1. 打开 `.cursor/hooks/session-init.mjs`
2. 查看 ADDITIONAL_CONTEXT（或等价输出）是否包含：当前会话 ID 的说明、以及「调用 lingxi-memory 时请在 input 中传入 conversation_id（及可选 generation_id）」的表述

**预期结果**：

- 约定文本中明确包含上述内容；新会话开始时该约定被注入

---

### TC-006: 记忆审计 — 写 note 后 audit 出现 memory*note*\* 行

**前置条件**：

- T1、T4 已完成；主 Agent 调用 lingxi-memory 时传入 conversation_id（及可选 generation_id）
- 能触发一次记忆写入（如 /remember 或 auto 写入）

**测试步骤**：

1. 触发一次记忆创建或更新（如执行 /remember 并完成门控写入）
2. 检查 audit.log 最新行

**预期结果**：

- 出现 `event` 为 `memory_note_created` 或 `memory_note_updated` 的 NDJSON 行
- 该行含 `ts`、`event`、`conversation_id`（在主 Agent 传入时非空）、`note_id`、`operation`、`source`、`file` 等（符合 req §8.2 记忆审计约定）

---

### TC-007: 记忆审计 — conversation_id 会话级关联

**前置条件**：

- 同一会话内既有主审计事件又有记忆审计事件

**测试步骤**：

1. 在同一会话中：提交消息（主审计）、触发记忆写入（记忆审计）
2. 用同一 conversation_id 过滤 audit.log

**预期结果**：

- 过滤结果包含该会话的主审计行与记忆审计行；按 ts 可排序得到完整时间线

---

### TC-008: INDEX 与 note Meta 含 CreatedAt、UpdatedAt、Source、Session

**前置条件**：

- T5、T4 已完成；已有一条新写或更新的记忆

**测试步骤**：

1. 新建或更新一条记忆并完成写入
2. 打开 `.cursor/.lingxi/memory/INDEX.md`，查看对应行
3. 打开对应 note 文件，查看 Meta 区

**预期结果**：

- INDEX 表头含 CreatedAt、UpdatedAt、Source、Session（或等价列名）；对应行有合理取值
- note 内 Meta 含上述字段（或 CreatedInSession/UpdatedInSession）；写入/更新后内容正确

---

### TC-009: 审计脚本异常时主流程放行

**前置条件**：

- T1 完成；可模拟脚本异常（如 audit 路径无写权限、或临时修改脚本在首行 throw）

**测试步骤**：

1. 人为使审计脚本抛出异常（如去掉写权限或脚本内 throw）
2. 触发任意已注册 Hook
3. 观察主流程是否被阻塞

**预期结果**：

- 脚本 catch 后向 stdout 输出放行 JSON（continue: true / decision: "allow"）；主流程不被拦截

---

## 3. 验收检查清单（与 req §7 对应）

- [ ] 主审计：8 类 Hook 事件均能触发并写入 audit.log，且返回正确放行/决策 JSON。
- [ ] 记忆审计：子代理创建/更新/删除 note 及更新 INDEX 后，audit 中出现对应 memory\_\* 行，且含 conversation_id（在主 Agent 传入时）。
- [ ] sessionStart 约定中包含会话 ID 与「调用 lingxi-memory 时传入 conversation_id」的说明。
- [ ] INDEX 与 note Meta 含 CreatedAt、UpdatedAt、Source、Session（或等价字段）；写入/更新后内容正确。
- [ ] 按 conversation_id 过滤 audit 文件可得到该会话的主事件与记忆事件，并按 ts 可排序。
- [ ] 审计脚本异常时主流程不被拦截（返回放行 JSON）。

---

## 4. 测试数据准备

| 数据名称     | 数据内容                                   | 用途                   |
| ------------ | ------------------------------------------ | ---------------------- |
| 单次会话     | 一次完整对话（含提交、工具、子代理、结束） | TC-001, TC-002, TC-007 |
| 记忆写入一次 | /remember 或 auto 触发并完成门控的一次写入 | TC-006, TC-008         |
| 异常脚本环境 | 无写权限或脚本内 throw                     | TC-009                 |
