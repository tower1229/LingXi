---
name: flow-router
description: 当用户输入 /flow 命令时必须激活此 Skill。负责路由 /flow 命令，驱动工作流阶段流转（req→plan→audit→work→review→archive）。支持三种用法：/flow <描述>（新需求）、/flow REQ-xxx（继续需求）、/flow（空参数自动查找）。
---

# Flow Router

## 激活验证（Fail Fast）

**首先确认**：你是否正在处理 `/flow` 命令？

如果是，你必须：

1. 已读取本 skill（flow-router）
2. 按下面的"输入解析"路由到正确路径
3. 不得直接执行用户描述的内容（如"我想改造 flow command"不是让你直接改，而是创建新需求）

**如果你没有按上述流程执行**，请立即停止并输出：

```
⚠️ /flow 命令路由异常：未正确激活 flow-router skill。
请重新输入 /flow 命令，或检查 .cursor/skills/flow-router/SKILL.md 是否存在。
```

## Instructions

### 输入解析（必须首先执行）

根据 `/flow` 命令的参数，确定进入哪条路径：

1. **空参数路径**：`/flow`（无参数）

   - **行为**：查询 INDEX.md，找出所有 Status != completed 的任务
   - **0 个任务**：输出"没有进行中的任务。使用 `/flow <描述>` 创建新需求。"
   - **1 个任务**：自动继续该任务（进入继续需求路径）
   - **多个任务**：按最后修改时间排序，展示列表让用户选择

2. **创建新需求路径**：`/flow <描述>`（参数不是 REQ-xxx 格式）

   - **行为**：直接进入 req 阶段，**禁止执行状态判断**
   - **原因**：用户明确表达了创建新需求的意图，必须尊重用户意图
   - **禁止**：在此路径下检查 INDEX.md 或文件存在性来判断阶段
   - **重要**：无论描述内容是什么（如"我想改造 flow command"），都是创建新需求，不是直接执行

3. **继续需求路径**：`/flow REQ-xxx`（参数匹配 REQ-xxx 格式）
   - **行为**：执行阶段状态判断，根据状态进入相应阶段
   - **原因**：用户明确指定了已有需求，需要读取状态确定当前阶段

### 关键原则

- **`/flow` 命令专注于需求工作流**（req → plan → audit → work → review → archive）
- **创建新需求路径必须直接进入 req 阶段**，不允许执行状态判断或检查文件存在性
- 只有"继续需求路径"才执行阶段状态判断
- 用户明确表达的意图具有最高优先级，不得被文件存在性或状态信息覆盖

### 阶段状态判断（AI Native，仅用于继续需求路径）

**适用范围**：仅在 `/flow REQ-xxx`（继续需求路径）时执行。

**禁止**：在创建新需求路径（`/flow <描述>`）时执行此判断，这是严重错误。

综合以下信息源判断当前所处阶段和状态：

**信息源及其特点**：

- INDEX.md 的 Status/Current Phase/Next Action：最权威的状态记录，通常最可靠
- plan.md 的状态摘要（Status Summary）：实时更新的执行状态，反映最新进展
- 文件存在性：基础判断依据，作为兜底推断

**判断策略**：

- 当信息源一致时，采用一致的结论
- 当信息源冲突时，优先采用最新、最详细的信息
- 当信息缺失时，通过文件存在性和用户意图推断
- 始终把用户明确表达的意图放在最高优先级

**避免**：

- 机械地"按优先级 1-2-3 依次检查"
- 忽略明显的冲突或异常
- 做出与用户意图相悖的判断
- **在创建新需求路径时执行此判断**（这是严重错误）

### 阶段执行（遵循对应 skill 的指引）

每个阶段有对应的 skill 提供执行指南：

| 阶段    | 对应 Skill | 说明               |
| ------- | ---------- | ------------------ |
| req     | `req`      | 需求澄清与定义     |
| plan    | `plan`     | 任务拆解与计划     |
| audit   | `audit`    | 技术审查与风险评估 |
| work    | `work`     | 实现与验证         |
| review  | `review`   | 多维度审查         |
| archive | `archive`  | 归档               |

Agent 会根据阶段自动激活相关 skill（基于 skill 的 description 匹配）。

**每个阶段执行前**，`experience-index` 会自动匹配历史经验提醒。

**按需**（存量/多服务项目），`service-loader` 可生成服务上下文降低"考古成本"。

### 阶段推进评估（AI Native）

在用户选择 B（进入下一阶段）后，评估当前阶段的完成质量：

**评估维度**（综合判断）：

- 核心产物是否完整
- 关键信息是否齐全
- 质量是否达标

**评估结果**：整体达标 → 静默推进；发现问题 → 展示缺陷，提供选项（强制推进 / 回退 / 继续完善）

### 自动生成轻量 plan（req → audit/work 跳转时）

当用户在 req 阶段选择 C（跳过 plan 进入 audit）或 D（跳过 plan 直接 work）时：

**生成策略**：使用文件操作提取，而非 LLM 生成，以提升速度（从 10-30 秒降至 1-3 秒）。

1. **读取 req 文件**：使用 `read_file` 读取 `.workflow/requirements/in-progress/REQ-xxx.md`
2. **文件操作提取**（不使用 LLM）：
   - **检查提取标记**：检查 req 文件中是否包含 `PLAN-EXTRACT:` 标记
     - 如果**没有标记**（旧格式），回退到当前的 LLM 生成方式（向后兼容）
     - 如果**有标记**，继续文件操作提取
   - **提取标记内容**：
     - 提取 `<!-- PLAN-EXTRACT:GOAL-START -->` 到 `<!-- PLAN-EXTRACT:GOAL-END -->` 之间的内容作为"目标回放"
     - 提取 `<!-- PLAN-EXTRACT:TASKS-START -->` 到 `<!-- PLAN-EXTRACT:TASKS-END -->` 之间的表格作为"任务清单"
     - 提取 `<!-- PLAN-EXTRACT:VALIDATION-START -->` 到 `<!-- PLAN-EXTRACT:VALIDATION-END -->` 之间的内容作为"验收检查清单"
   - **提取文件路径**（简单正则）：
     - 从功能需求表格的"实现方案"列中，使用正则提取文件路径（如 `` `([^\`]+\.(ts|tsx|js|jsx|py|md))` ``）
     - 如果功能需求表格缺少"实现方案"列，文件变更清单为空
3. **模板填充**：使用固定模板，直接填充提取的内容
4. **静默写入**：符合静默成功原则，不输出确认信息
5. **更新 INDEX**：Status = `in-progress`，Current Phase = `audit` 或 `work`
6. **继续进入下一阶段**：进入 audit 或 work

**轻量 plan 模板**（固定模板，直接填充）：

```markdown
# REQ-xxx Plan (Auto-generated, Minimal)

> **注意**：这是从 req 自动生成的轻量 plan，内容可能不完整。文件变更清单、任务粒度、测试规格等可能在 audit/work 阶段按需补充。

## 目标回放（1-3 行）

{直接复制 req 中 PLAN-EXTRACT:GOAL 标记的内容，如果没有则为空}

## 状态摘要（Status Summary）

- **当前阶段**：{audit 或 work}
- **进度**：0/{功能需求表格行数}（注：任务粒度可能与实际执行不一致）
- **当前任务**：无
- **阻塞项**：无
- **上次更新**：{DATE}
- **自动生成**：是（从 req 文件操作提取，Minimal 版本）

## 文件变更清单（Files to Change）

> **注意**：此清单仅包含 req 中"实现方案"列明确提及的关键文件，可能不完整。测试文件、配置文件、依赖文件等可能在 work 阶段按需补充。

{从功能需求表格"实现方案"列正则提取的文件路径，如果提取不到则为空}

| 操作 | 文件路径         | 说明                         |
| ---- | ---------------- | ---------------------------- |
| 修改 | {提取的文件路径} | 从实现方案提取（可能不完整） |

{如果没有提取到文件，则显示：}

> 文件变更清单为空（req 中未明确提及文件路径，将在 work 阶段按需补充）

## 任务清单（Tasks）

> **注意**：此任务清单直接映射自 req 的功能需求表格，任务粒度可能与实际执行不一致。依赖关系、任务拆解等可能在 audit/work 阶段按需补充。

{直接复制 req 中 PLAN-EXTRACT:TASKS 标记的表格，转换为任务格式}

{将表格行转换为：}

- [ ] F1: {需求描述}
  - 实现方案: {实现方案，如果有}
  - 验收标准: {验收标准，如果有}
  - 依赖: 无（注：依赖关系待补充）
- [ ] F2: ...

{如果 req 中没有功能需求表格，则显示：}

> 任务清单为空（req 中无功能需求表格，将在 work 阶段按需补充）

## 交付物（Deliverables）

- [ ] 代码变更完成
- [ ] 验收检查清单全部通过

## 测试规格（Test Specifications）

> **注意**：此测试规格仅包含 req 中的验收检查清单（手工验证步骤），可能不完整。可测试行为提取、单元测试规格、集成测试场景等可能在 audit/work 阶段按需补充。

### 手工验证步骤

{直接复制 req 中 PLAN-EXTRACT:VALIDATION 标记的内容，转换为表格格式}

{将验收检查清单转换为表格格式：}
| 步骤 | 操作 | 预期行为 |
|-----|-----|---------|
| 1 | {验收项 1} | 通过 |
| ... | ... | ... |

{如果没有验收检查清单，则显示：}

> 测试规格为空（req 中无验收检查清单，将在 audit/work 阶段按需补充）

## 复利候选（Compounding Candidates）

- [ ] （待补充）
```

**提取规则**（文件操作，不使用 LLM）：

| req 标记                  | plan 章节    | 提取方式                                   |
| ------------------------- | ------------ | ------------------------------------------ |
| `PLAN-EXTRACT:GOAL`       | 目标回放     | 直接复制标记间的内容                       |
| `PLAN-EXTRACT:TASKS`      | 任务清单     | 复制表格，转换为任务格式（简单字符串处理） |
| `PLAN-EXTRACT:VALIDATION` | 手工验证步骤 | 复制清单，转换为表格格式（简单字符串处理） |
| 功能需求表格"实现方案"列  | 文件变更清单 | 正则提取文件路径                           |

**向后兼容处理**：

- 如果功能需求表格缺少"实现方案"列（旧格式），文件变更清单显示为空并标记"待补充"
- 如果 req 中没有功能需求表格，任务清单显示为空并标记"待补充"

### 人工闸门（必须）

每一轮结束都必须输出菜单，让用户选择下一步。菜单格式为每行一个选项，选项文案根据当前阶段动态变化：

- req 阶段：选项 A 显示"继续修改/补充 需求"，选项 B 显示"进入 plan（复杂任务推荐）"，选项 C 显示"跳过 plan 进入 audit"，选项 D 显示"跳过 plan 直接 work"
- plan 阶段：选项 A 显示"继续修改/补充 计划"，选项 B 显示"进入 audit"，选项 C 显示"跳过 audit 直接 work"
- audit 阶段：选项 A 显示"继续修改/补充 审查"，选项 B 显示"进入 work"
- work 阶段：选项 A 显示"继续修改/补充 实现"，选项 B 显示"进入 review"，选项 C 显示"跳过 review 直接 archive"
- review 阶段：选项 A 显示"继续修改/补充 审查"，选项 B 显示"进入 archive"

**关键规则**：

- 用户选择 B 或 C 后，检查推进判据：满足则静默进入，不满足则输出检查清单（仅在异常时展示）
- **用户选择 A（继续修改/补充）后，执行完用户请求的修改操作，必须再次输出菜单**，确保用户能够继续选择下一步，避免只能使用空 `/flow` 命令继续

### 阶段完成输出（静默成功原则）

**正常完成**：人类友好的提示语 + 菜单（每行一个选项）

示例格式（req 阶段）：

```
需求文档已创建，您可以：

A) 继续修改/补充 需求
B) 进入 plan（复杂任务推荐）
C) 跳过 plan 进入 audit
D) 跳过 plan 直接 work
E) 回退
F) 退出
```

**有阻塞项**：输出阻塞详情和处理建议

### 复利候选（通过 EXP-CANDIDATE 自动收集）

当你识别到可沉淀点时，在回复中输出结构化注释：

```html
<!-- EXP-CANDIDATE {
  "stage": "work",
  "trigger": "...",
  "decision": "...",
  "solution": "...",
  "verify": "...",
  "pointers": [...]
} -->
```

> experience-collector 会在后台自动收集并暂存到 `.workflow/context/session/pending-compounding-candidates.json`；用户必须主动选择确认（如直接输入编号 `1,3` 选择候选）后，才允许写入 `.workflow/context/experience/`。
