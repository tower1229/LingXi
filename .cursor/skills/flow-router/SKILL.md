---
name: flow-router
description: 此 Skill 路由 /flow 命令，驱动工作流阶段流转（req→plan→audit→work→review→archive）。当用户输入 /flow <REQ-xxx|描述> 命令时激活，负责判断当前阶段、支持重复执行（如 audit 多次）、并在推进前请求用户确认（人工闸门）。
---

# Flow Router

## Instructions

### 输入解析（必须首先执行）

根据 `/flow` 命令的参数，确定进入哪条路径：

1. **创建新需求路径**：`/flow <描述>`（参数不是 REQ-xxx 格式，且不是"沉淀"或"采纳质量准则"）
   - **行为**：直接进入 req 阶段，**禁止执行状态判断**
   - **原因**：用户明确表达了创建新需求的意图，必须尊重用户意图
   - **禁止**：在此路径下检查 INDEX.md 或文件存在性来判断阶段

2. **继续需求路径**：`/flow REQ-xxx`（参数匹配 REQ-xxx 格式）
   - **行为**：执行阶段状态判断，根据状态进入相应阶段
   - **原因**：用户明确指定了已有需求，需要读取状态确定当前阶段

3. **沉淀确认路径**：`/flow 沉淀 ...` 或 `/flow 忽略沉淀`
   - **输入**：`.workflow/context/session/pending-compounding-candidates.json`
   - **忽略沉淀**：删除暂存文件，输出"已忽略"
   - **沉淀 N,M**：
     - 读取 `experience-depositor` Skill，展示候选摘要
     - 按序号解析用户选择（1-based index）
     - 执行沉淀分流，写入 experience/INDEX
     - 若新增经验，触发 `experience-curator`
   - **输出**：简短说明沉淀结果

4. **质量准则采纳路径**：`/flow 采纳质量准则 ...` 或 `/flow 忽略质量准则`
   - **输入**：对话上下文中的质量准则建议列表
   - **忽略质量准则**：输出"已忽略质量准则建议"
   - **采纳质量准则 N,M**：
     - 按序号解析用户选择（1-based index）
     - 读取 `rules-creator` Skill，执行规则创建
     - 配置 frontmatter，更新索引
   - **输出**：简短说明采纳结果

**关键原则**：
- **创建新需求路径必须直接进入 req 阶段**，不允许执行状态判断或检查文件存在性
- 只有"继续需求路径"才执行阶段状态判断
- 用户明确表达的意图具有最高优先级，不得被文件存在性或状态信息覆盖

### 阶段状态判断（AI Native，仅用于继续需求路径）

**适用范围**：仅在 `/flow REQ-xxx`（继续需求路径）时执行。

**禁止**：在创建新需求路径（`/flow <描述>`）时执行此判断，这是严重错误。

综合以下信息源判断当前所处阶段和状态：

**信息源及其特点**：
- INDEX.md 的 Status/Current Phase/Next Action：最权威的状态记录，通常最可靠
- plan.md 的状态摘要（Status Summary）：实时更新的执行状态，反映最新进展
- 文件存在性：基础判断依据，作为兜底推断

**判断策略**：
- 当信息源一致时，采用一致的结论
- 当信息源冲突时，优先采用最新、最详细的信息
- 当信息缺失时，通过文件存在性和用户意图推断
- 始终把用户明确表达的意图放在最高优先级

**避免**：
- 机械地"按优先级 1-2-3 依次检查"
- 忽略明显的冲突或异常
- 做出与用户意图相悖的判断
- **在创建新需求路径时执行此判断**（这是严重错误）

### 阶段执行（遵循对应 skill 的指引）

每个阶段有对应的 skill 提供执行指南：

| 阶段 | 对应 Skill | 说明 |
|------|-----------|------|
| req | `req` | 需求澄清与定义 |
| plan | `plan` | 任务拆解与计划 |
| audit | `audit` | 技术审查与风险评估 |
| work | `work` | 实现与验证 |
| review | `review` | 多维度审查 |
| archive | `archive` | 归档 |

Agent 会根据阶段自动激活相关 skill（基于 skill 的 description 匹配）。

**每个阶段执行前**，`experience-index` 会自动匹配历史经验提醒。

**每个阶段开始前**，若上一阶段产生了候选，则展示给用户（参考 `references/trade-off-record.md`）：
1. 检查 `session/pending-compounding-candidates.json`
2. 筛选上一阶段的候选，去重后按时间倒序展示
3. 提供选项：A) 现在沉淀 / B) 稍后再说 / C) 忽略这批

**按需**（存量/多服务项目），`service-loader` 可生成服务上下文降低"考古成本"。

### 阶段推进评估（AI Native）

在用户选择 B（进入下一阶段）后，评估当前阶段的完成质量：

**评估维度**（综合判断）：
- 核心产物是否完整
- 关键信息是否齐全
- 质量是否达标

**评估结果**：整体达标 → 静默推进；发现问题 → 展示缺陷，提供选项（强制推进 / 回退 / 继续完善）

### REQ 文档候选提取（req → plan 时）

在 `req → plan` 判据检查后、进入 plan 前（判据满足时），执行 REQ 文档候选提取：

1. **读取 REQ 文档**：读取 `.workflow/requirements/in-progress/REQ-xxx.md`
2. **提取高信号片段**：
   - 非目标（2.2 非目标）
   - 关键决策记录（6.2 关键决策记录）
   - 风险与对策（如有）
   - 验收口径背后的判断（验收检查清单中的取舍）
   - 业务边界/规则/术语（从需求描述中识别）
3. **生成候选**：
   - **EXP-CANDIDATE**（经验候选）：从非目标、关键决策记录、风险与对策、验收口径中提取，使用 `references/trade-off-record.md` 定义的格式转写
   - **SEM-CANDIDATE**（语义候选）：从业务边界/规则/术语中提取，使用 `references/semantics-capsule.md` 定义的 JSON 格式
4. **交给 experience-collector**：将候选交给 `experience-collector` 暂存（静默处理，不打断推进）
5. **继续进入 plan**：符合静默成功原则，不输出确认信息

**检查清单格式**（仅用于判据不满足时）：
```markdown
## 可推进判据检查清单（<当前阶段> → <下一阶段>）

| 判据 | 状态 | 说明 |
|------|------|------|
| 判据1 | ✅ 已满足 | ... |
| 判据2 | ❌ 未满足 | ...（未满足原因）|

**未满足项**：
- 判据2：具体未满足原因

**处理选项**：
A) 强制推进（需说明原因）
B) 回退到上一阶段
C) 继续本阶段（完善后再推进）
```

### 人工闸门（必须）

每一轮结束都必须输出菜单，让用户选择下一步：

```text
A) 补充/修改  B) 下一阶段  C) 回退  D) 退出
```

用户选择 B 后，检查推进判据：满足则静默进入，不满足则输出检查清单。

### 阶段完成输出（静默成功原则）

**正常完成**：一行状态 + 菜单
```
✅ <阶段> 完成 → <下一阶段> | A)补充/修改 B)下一阶段 C)回退 D)退出
```

**有阻塞项**：输出阻塞详情和处理建议

### 复利候选（通过 EXP-CANDIDATE 自动收集）

当你识别到可沉淀点时，在回复中输出结构化注释：

```html
<!-- EXP-CANDIDATE {
  "stage": "work",
  "trigger": "...",
  "decision": "...",
  "solution": "...",
  "verify": "...",
  "pointers": [...]
} -->
```

> experience-collector 会在后台自动收集并暂存到 `.workflow/context/session/pending-compounding-candidates.json`；用户必须用 `/flow 沉淀 ...` 明确确认后，才允许写入 `.workflow/context/experience/`。
