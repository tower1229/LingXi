---
name: flow-router
description: 当用户输入 /flow 命令时必须激活此 Skill。负责路由 /flow 命令，驱动工作流阶段流转（req→plan→audit→work→review→archive）。支持三种用法：/flow <描述>（新需求）、/flow REQ-xxx（继续需求）、/flow（空参数自动查找）。
---

# Flow Router

## 激活验证（Fail Fast）

**首先确认**：你是否正在处理 `/flow` 命令？

如果是，你必须：
1. 已读取本 skill（flow-router）
2. 按下面的"输入解析"路由到正确路径
3. 不得直接执行用户描述的内容（如"我想改造 flow command"不是让你直接改，而是创建新需求）

**如果你没有按上述流程执行**，请立即停止并输出：
```
⚠️ /flow 命令路由异常：未正确激活 flow-router skill。
请重新输入 /flow 命令，或检查 .cursor/skills/flow-router/SKILL.md 是否存在。
```

## Instructions

### 输入解析（必须首先执行）

根据 `/flow` 命令的参数，确定进入哪条路径：

1. **空参数路径**：`/flow`（无参数）
   - **行为**：查询 INDEX.md，找出所有 Status != completed 的任务
   - **0 个任务**：输出"没有进行中的任务。使用 `/flow <描述>` 创建新需求。"
   - **1 个任务**：自动继续该任务（进入继续需求路径）
   - **多个任务**：按最后修改时间排序，展示列表让用户选择

2. **创建新需求路径**：`/flow <描述>`（参数不是 REQ-xxx 格式）
   - **行为**：直接进入 req 阶段，**禁止执行状态判断**
   - **原因**：用户明确表达了创建新需求的意图，必须尊重用户意图
   - **禁止**：在此路径下检查 INDEX.md 或文件存在性来判断阶段
   - **重要**：无论描述内容是什么（如"我想改造 flow command"），都是创建新需求，不是直接执行

3. **继续需求路径**：`/flow REQ-xxx`（参数匹配 REQ-xxx 格式）
   - **行为**：执行阶段状态判断，根据状态进入相应阶段
   - **原因**：用户明确指定了已有需求，需要读取状态确定当前阶段

### 不支持的用法（必须拒绝）

以下用法已不再支持，必须拒绝并引导：

- `/flow 沉淀 ...` 或 `/flow 忽略沉淀`
- `/flow 采纳质量准则 ...` 或 `/flow 忽略质量准则`

**拒绝时输出**：
```
⚠️ 此用法已不再支持。

- 经验沉淀请使用：/remember <描述>
- 质量准则采纳通过其他机制实现

/flow 命令只支持三种用法：
- /flow <描述>    创建新需求
- /flow REQ-xxx   继续已有需求
- /flow           自动查找进行中任务
```

### 关键原则

- **`/flow` 命令专注于需求工作流**（req → plan → audit → work → review → archive）
- **创建新需求路径必须直接进入 req 阶段**，不允许执行状态判断或检查文件存在性
- 只有"继续需求路径"才执行阶段状态判断
- 用户明确表达的意图具有最高优先级，不得被文件存在性或状态信息覆盖

### 阶段状态判断（AI Native，仅用于继续需求路径）

**适用范围**：仅在 `/flow REQ-xxx`（继续需求路径）时执行。

**禁止**：在创建新需求路径（`/flow <描述>`）时执行此判断，这是严重错误。

综合以下信息源判断当前所处阶段和状态：

**信息源及其特点**：
- INDEX.md 的 Status/Current Phase/Next Action：最权威的状态记录，通常最可靠
- plan.md 的状态摘要（Status Summary）：实时更新的执行状态，反映最新进展
- 文件存在性：基础判断依据，作为兜底推断

**判断策略**：
- 当信息源一致时，采用一致的结论
- 当信息源冲突时，优先采用最新、最详细的信息
- 当信息缺失时，通过文件存在性和用户意图推断
- 始终把用户明确表达的意图放在最高优先级

**避免**：
- 机械地"按优先级 1-2-3 依次检查"
- 忽略明显的冲突或异常
- 做出与用户意图相悖的判断
- **在创建新需求路径时执行此判断**（这是严重错误）

### 阶段执行（遵循对应 skill 的指引）

每个阶段有对应的 skill 提供执行指南：

| 阶段 | 对应 Skill | 说明 |
|------|-----------|------|
| req | `req` | 需求澄清与定义 |
| plan | `plan` | 任务拆解与计划 |
| audit | `audit` | 技术审查与风险评估 |
| work | `work` | 实现与验证 |
| review | `review` | 多维度审查 |
| archive | `archive` | 归档 |

Agent 会根据阶段自动激活相关 skill（基于 skill 的 description 匹配）。

**每个阶段执行前**，`experience-index` 会自动匹配历史经验提醒。

**按需**（存量/多服务项目），`service-loader` 可生成服务上下文降低"考古成本"。

### 阶段推进评估（AI Native）

在用户选择 B（进入下一阶段）后，评估当前阶段的完成质量：

**评估维度**（综合判断）：
- 核心产物是否完整
- 关键信息是否齐全
- 质量是否达标

**评估结果**：整体达标 → 静默推进；发现问题 → 展示缺陷，提供选项（强制推进 / 回退 / 继续完善）

### 人工闸门（必须）

每一轮结束都必须输出菜单，让用户选择下一步。菜单格式为每行一个选项，选项文案根据当前阶段动态变化：

- req 阶段：选项A显示"继续修改/补充 需求"，选项B显示"进入 plan"
- plan 阶段：选项A显示"继续修改/补充 计划"，选项B显示"进入 audit"，选项C显示"跳过audit 直接 work"
- audit 阶段：选项A显示"继续修改/补充 审查"，选项B显示"进入 work"
- work 阶段：选项A显示"继续修改/补充 实现"，选项B显示"进入 review"，选项C显示"跳过review 直接 archive"
- review 阶段：选项A显示"继续修改/补充 审查"，选项B显示"进入 archive"

用户选择 B 或 C 后，检查推进判据：满足则静默进入，不满足则输出检查清单（仅在异常时展示）。

### 阶段完成输出（静默成功原则）

**正常完成**：人类友好的提示语 + 菜单（每行一个选项）

示例格式：
```
需求文档已创建，您可以：

A) 继续修改/补充 需求
B) 进入 plan
C) 回退
D) 退出
```

**有阻塞项**：输出阻塞详情和处理建议

### 复利候选（通过 EXP-CANDIDATE 自动收集）

当你识别到可沉淀点时，在回复中输出结构化注释：

```html
<!-- EXP-CANDIDATE {
  "stage": "work",
  "trigger": "...",
  "decision": "...",
  "solution": "...",
  "verify": "...",
  "pointers": [...]
} -->
```

> experience-collector 会在后台自动收集并暂存到 `.workflow/context/session/pending-compounding-candidates.json`；用户必须用 `/remember ...` 明确确认后，才允许写入 `.workflow/context/experience/`。
