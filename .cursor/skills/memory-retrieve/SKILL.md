---
name: memory-retrieve
description: 以检索查询为参数检索记忆库并最小注入。query 可为用户 prompt 或 Agent 构建的决策点描述。调用形式 /memory-retrieve <query>；无匹配静默。
---

# Memory Retrieve

## 本 Skill 会用到的能力

- **语义检索**：对 `.cursor/.lingxi/memory/notes/`（及 `share/` 子目录）做概念级匹配。
- **关键词搜索**：对同一目录及 `memory/INDEX.md` 的 **Title、When to load** 列（以及 notes 正文）使用 Cursor 提供的 **Grep** 或 **Search files and folders / 工作区内容搜索** 等做文本匹配，以 query 中的技术词、错误码、配置项名、API 名、场景/维度词等为查询。若当前环境仅支持路径/文件名搜索，可退化为读取 INDEX 或 notes 内容后做文本匹配。
- 按需读取候选文件，不做文件写入。

## 调用形式

- **/memory-retrieve** \<query\>
- 参数：检索查询。**主流程**：当前用户消息；**嗅探场景**：Agent 构建的决策点描述（如「在方案对比中，用户更倾向于体验优先还是成本可控？」）。

## 目标

在不打扰用户的前提下，以**传入的 query** 为查询，从 `.cursor/.lingxi/memory/notes/` 中检索出可能有用的记忆，并以“最小高信号”的形式注入到你的回答决策中。

## 输入

- **必需**：检索查询（即 /memory-retrieve 的唯一参数）
- **主流程**：用户本轮的 prompt（当前用户消息）
- **嗅探场景**：拟做品味嗅探提问前，可传入 Agent 构建的决策点描述；若检索到相关记忆且能覆盖当前选择，则不再问、直接按该记忆行为
- **可选**：当前上下文（最近对话、打开文件、当前任务阶段等，如可获得）

## 执行流程

### 步骤 1：理解判断

判断用户输入能否独立理解（是否包含可检索的实质：技术词、决策点、任务描述等）。若**不能**（指代、省略、延续性指令、纯确认等，如「好的」「继续」「改一下」「上次那个」），则结合最近 1～2 轮对话推断完整含义。

### 步骤 2：提炼

产出「语义摘要」和「关键词」：

- **语义摘要**：核心问题 / 决策点 / 约束 / 认可内容
- **关键词**：技术词、错误码、配置项名、API 名、场景词等

### 步骤 3：检索必要性判断

若语义摘要无实质（仅社交/元表达，如问候、致谢、告别）且关键词为空 → 跳过检索，静默；否则进入步骤 4。

### 步骤 4：双路径检索

用步骤 2 产出的「语义摘要」和「关键词」执行检索，按以下策略合并与注入。

## 检索策略（混合检索：语义 + 关键词，召回优先）

采用**双路径并行、并集加权合并、候选放大再裁剪**，召回优先（漏掉相关记忆比多一条边缘结果代价更大）。

### 1. 双路径检索

- **语义路径**：对 `.cursor/.lingxi/memory/notes/` 做语义搜索（概念级匹配）。使用步骤 2 产出的**语义摘要**构建查询，用自然语言说明“用户要解决的核心问题/决策点/约束”和“希望查找的记忆类型（原则/模式/风险/约束/排障路径等）”。取 **Top 0–5** 条候选。
- **关键词路径**：对同一目录及 INDEX 的 **Title、When to load** 列用 **Grep** 或工作区内容搜索，以步骤 2 产出的**关键词**为查询做关键词/短语匹配。取 **Top 0–5** 条候选。

### 2. 并集与加权合并

- 两路结果取**并集**（不做“两路都命中才保留”的交集）。
- 对每条候选赋予综合分：**0.7 × 语义分 + 0.3 × 关键词分**。语义分来自 Cursor 返回的相关性/排序；关键词侧将排名映射为 0–1（如 `1/(1+rank)`，rank 0 → 1.0）。
- 按综合分排序后，取 **top 0–2** 条做最小注入。

### 3. 最小化与一次检索

- **仅基于提炼后的语义摘要与关键词做一次检索与重排**，不做多轮放宽或换问法再查，以与「先理解意图」并存且不增加响应延迟。
- 对最终 0–2 条候选按需读取原文，判定是否直接相关；不相关则不注入。

## 最小注入格式（不打扰用户）

- **无匹配**：完全静默
- **有匹配**：每条记忆压缩为 1-2 句：
  - 一句“可执行提醒”（你希望自己立刻记住的那个约束/原则）
  - 轻量引用（例如：`[MEM-xxx]`），添加在可执行提醒后，不单独占行

**示例**：

- "此项目 API 错误响应统一使用 { code, message } 格式 [MEM-api-error-format]"
- "新增组件优先复用现有 UI 库，避免重复造轮子 [MEM-component-reuse]"

## 输出行为（重要）

- 这些注入信息应该影响你的方案选择、默认约束、风险提示等
- **不要在对外输出中显式声明“我检索了记忆库”**（除非用户明确要求）
- 不要为了“完成注入”而勉强注入不相关内容：不相关就不注入
- **引用约定**：若本轮回答**依据**检索到的某条记忆做方案选择、默认约束或风险提示，应在对用户的表述中**自然引用**该记忆（如简要提及「按项目约定…」或「[MEM-xxx] 中约定…」），不单独罗列「我检索了记忆库」，但也不完全隐去来源。

## 失败降级

1. **优先语义**：正常时双路径（语义 + 关键词）并行，按上述策略合并。
2. **语义不可用或失败**：则**仅执行关键词路径**（对 notes/ 及 INDEX 的 Title、When to load 做 Grep/文本匹配）；仍按综合分取 top 0–2，若无关键词命中则注入为空。
3. **仍无匹配**：静默，不向用户输出「检索失败」或任何报错；继续回答即可。
