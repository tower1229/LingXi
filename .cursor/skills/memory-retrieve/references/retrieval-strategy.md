# Memory Retrieve — 检索策略与执行流程

本文档为 memory-retrieve 的详细检索策略、步骤、最小注入格式与失败降级；SKILL.md 仅保留意图与关键约束。

## 执行流程

### 步骤 1：理解判断

判断用户输入能否独立理解（是否包含可检索的实质：技术词、决策点、任务描述等）。若不能（指代、省略、延续性指令、纯确认等，如「好的」「继续」「改一下」「上次那个」），则结合最近 1～2 轮对话推断完整含义。

### 步骤 2：提炼

产出「语义摘要」和「关键词」：语义摘要 = 核心问题/决策点/约束/认可内容；关键词 = 技术词、错误码、配置项名、API 名、场景词等。

### 步骤 3：检索必要性判断

若语义摘要无实质（仅社交/元表达）且关键词为空 → 跳过检索，静默；否则进入步骤 4。

### 步骤 4：双路径检索

用步骤 2 产出的「语义摘要」和「关键词」执行检索，按以下策略合并与注入。

## 检索策略（混合检索：语义 + 关键词，召回优先）

- **双路径**：语义路径对 `.cursor/.lingxi/memory/notes/`（及 `share/`）做概念级匹配，取 Top 0–5；关键词路径对同一目录及 INDEX 的 Title、When to load 列用 Grep/工作区搜索，取 Top 0–5。
- **并集与加权**：两路取并集；综合分 = 0.7×语义分 + 0.3×关键词分；按综合分排序取 top 0–2。
- **最小化与一次检索**：仅基于提炼后的语义摘要与关键词做一次检索与重排；对最终 0–2 条候选按需读取原文，不相关则不注入。

## 最小注入格式

- 无匹配：完全静默。
- 有匹配：每条压缩为 1–2 句（可执行提醒 + 轻量引用如 `[MEM-xxx]`），不单独占行。

## 输出行为

注入信息应影响方案选择、默认约束、风险提示等。不在对外输出中显式声明「我检索了记忆库」（除非用户要求）。不相关则不注入。若本轮回答依据某条记忆做方案选择或约束，应在表述中自然引用该记忆（如「按项目约定…」或「[MEM-xxx] 中约定…」）。

## 失败降级

语义不可用或失败 → 仅执行关键词路径；仍取 top 0–2。仍无匹配 → 静默，不输出「检索失败」。
