---
name: experience-capture
description: 此 Skill 在执行 /req、/plan 001、/build 001、/review 001 等命令时自动激活，自动检测当前阶段和任务编号，提供统一的 EXP-CANDIDATE 捕获逻辑。
---

# Experience Capture

## Instructions

### 1. 阶段和任务编号检测逻辑

**统一检测策略：对话历史优先 + 文件验证补充**

采用分层检测策略，确保检测的准确性和可靠性：

**检测层级**（按优先级顺序）：

| 层级 | 检测方式   | 用途                   | 可靠性             |
| ---- | ---------- | ---------------------- | ------------------ |
| L1   | 对话历史   | 确定当前阶段和任务编号 | 高（唯一权威来源） |
| L2   | 文件存在性 | 验证任务状态、显示进度 | 中（辅助信息）     |
| L3   | 用户确认   | 兜底（历史缺失时）     | 高（用户明确指定） |

#### 1.1 L1：对话历史检测（主要来源）

1. 检测用户最近输入的命令（`/plan 001`、`/build 001`、`/review 001` 等）
2. 提取命令名（plan/build/review）和参数（001）
3. 命令名直接对应阶段：`/plan` → plan 阶段，`/build` → build 阶段，`/review` → review 阶段
4. 命令参数直接对应任务编号：`001` → 任务编号 001

**特殊命令**：

- `/req <描述>` → 阶段：req，任务编号：自动生成（待写入文件后确定）
- `/req-review 001` → 阶段：req-review，任务编号：001

#### 1.2 L2：文件存在性验证（辅助来源）

用于验证任务状态和显示任务进度，**不用于判断当前阶段**：

```
扫描 .workflow/requirements/ 目录：
- 001.req.*.md 存在 → 任务 001 已创建 req
- 001.plan.*.md 存在 → 任务 001 已创建 plan
- 001.testcase.*.md 存在 → 任务 001 已创建 testcase
```

**使用场景**：

- 执行 `/plan 001` 前验证 `001.req.*.md` 是否存在
- 显示任务进度（如 "任务 001：req ✅ plan ✅ build ⏳"）
- 提供任务状态概览

#### 1.3 L3：用户确认兜底

当对话历史缺失（如新会话）时：

- 提示用户明确指定任务编号
- 或通过命令参数获取（如 `/build 001`）

**为什么文件推断不能作为主要来源**：

- **并行任务切换**：用户可能在任务 001 和 002 之间切换，文件系统无法判断当前正在处理哪个任务
- **文件修改时间**：最近修改的文件可能是之前任务留下的，不代表当前任务
- **文件存在性**：文件存在性只能说明任务曾经执行过某个阶段，不能说明当前正在执行哪个阶段

### 2. 统一的 EXP-CANDIDATE 捕获逻辑

#### 2.1 混合触发机制

**核心原则**：所有经验都直接或间接来自用户输入，因此以用户每次输入为触发点。

**三层触发机制**：

1. **基础层：用户输入扫描**（每次用户输入时）
   - 检测关键词信号（"必须"、"不要"、"改成"、"接受"、"拒绝"、"改成"、"换成"、"确认"、"明确"等）
   - 检测语义信号（调整、选择、拒绝、确认、纠正、切换、定位、发现等）
   - 检测结构信号（用户明确表达判断、取舍、边界、约束、规范等）

2. **过滤层：轻量级判断**
   - 如果无信号 → 静默跳过，不执行捕获流程
   - 如果有信号 → 进入完整捕获流程

3. **确认层：完整捕获流程**
   - 自动检测当前阶段和任务编号（使用上述检测逻辑）
   - 匹配触发场景（参考 references 目录的场景列表，但不作为唯一依据）
   - 生成 EXP-CANDIDATE
   - 静默输出（HTML 注释包裹）

**触发场景参考**：
- 场景列表（`references/req-triggers.md` 等）作为参考，但不作为唯一触发依据
- 更依赖 AI 的语义理解能力，识别用户输入中的经验信号
- 场景列表用于帮助理解经验类型和结构，而非限制捕获范围

#### 2.2 捕获时机

在以下时机捕获经验候选（基于用户输入识别）：

- **用户主动调整**：用户调整决策、方案、范围、优先级等（如"改成这样"、"不要做那个"）
- **用户明确诉求**：用户明确表达需求、约束、边界、规范等（如"必须兼容X"、"不能超过Y"）
- **用户发表看法**：用户表达判断、取舍、拒绝、确认等（如"用方案A"、"这个风险接受"）
- **用户肯定方案**：用户明确肯定会话中的方案、观点、模式等（如"对"、"就是这样"、"记住了"）
- **用户 prompt 自带经验**：用户输入中包含经验性内容（如"记住：用户是唯一拥有价值判断能力的人"）
- **问题解决过程**：从问题发现到根因定位到解决方案的完整过程（如"原来是因为..."、"根本原因是..."）

#### 2.3 输出格式

```html
<!-- EXP-CANDIDATE
{
  "taskId": "001",
  "stage": "plan",
  "trigger": "当任务 T2 依赖从A改为B",
  "decision": "任务/验收/测试策略的取舍",
  "alternatives": ["原方案A（放弃，因为...）"],
  "signal": "判断依据/风险信号",
  "solution": "新的任务拆解/验收/测试策略",
  "verify": "后续如何验证该决策",
  "pointers": ["path/to/plan-file 或相关模块"],
  "reqFile": ".workflow/requirements/001.req.<标题>.md",
  "notes": "可选补充"
}
-->
```

**关键字段**：

- `taskId`：任务编号（001, 002, ...）
- `stage`：当前阶段（req/plan/build/review）
- `reqFile`：关联的 req 文件路径（用于后续匹配和追溯）

#### 2.4 触发场景参考

触发场景列表（`references/req-triggers.md` 等）作为参考，用于：

- 帮助理解经验类型和结构
- 提供典型信号示例
- 指导经验提取要点

**但不作为唯一触发依据**，实际触发基于用户输入的语义理解。

### 3. 捕获规则

#### 3.1 静默捕获

- 捕获时不干扰对话，使用 HTML 注释包裹
- 不输出确认信息（如"已捕获经验候选"）
- 符合静默成功原则

#### 3.2 格式要求

- 必须包含所有关键字段（taskId, stage, trigger, decision, solution, verify, reqFile）
- alternatives 字段可选，但如果存在决策取舍，应包含至少一个备选方案
- pointers 字段应指向相关文件或模块，便于追溯

#### 3.3 质量要求

- 只捕获有价值的经验（有明确的触发条件、决策依据、解决方案）
- 避免捕获过于具体或临时的决策（无法复用的经验）
- 确保经验的通用性（可在类似场景下复用）

---

## 与 1.0 的主要区别

1. **统一捕获**：从各阶段 Skill 中抽取统一捕获逻辑
2. **阶段检测**：统一检测策略（对话历史优先 + 文件验证补充）
3. **混合触发机制**：以用户输入为触发点，结合轻量级过滤和完整捕获流程
4. **语义理解优先**：更依赖 AI 的语义理解能力，场景列表仅作为参考
5. **关联字段**：新增 taskId 和 reqFile 字段，便于后续匹配和追溯
