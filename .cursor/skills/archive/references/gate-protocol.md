# 闸门协议：可推进判据检查清单

## 概述

本文档定义各阶段切换时的**可推进判据检查清单**，确保阶段切换前所有关键条件都已满足。每个判据都是可验证的，AI 必须严格检查后才能推进。

## 设计原则

1. **可验证性**：每个判据都有明确的验证方式（文件存在性、内容检查、状态检查等）
2. **格式化输出**：检查结果以表格形式展示，明确标注"已满足/未满足"
3. **强制执行**：AI 必须检查所有判据，未满足的判据必须明确标注
4. **判据满足时静默进入，判据不满足时输出**：判据满足时，内部检查，不输出检查清单，直接进入下一阶段；判据不满足时，输出完整检查清单，展示未满足项

## 阶段切换检查清单

### req → plan

| 检查项 | 验证方式 | 说明 |
|--------|---------|------|
| Requirement 文件已写入 | 检查 `.workflow/requirements/in-progress/REQ-xxx.md` 是否存在 | 文件必须存在且非空 |
| Requirement 内容完整 | 检查文件是否包含：概述、目标、用户故事、功能需求、验收清单 | 至少包含概述和目标 |
| 关键缺失项=0 | 检查需求中是否标注"关键缺失项"或"待澄清项"，且数量为 0 | 如有缺失项，必须明确列出 |
| INDEX 已更新 | 检查 `.workflow/requirements/INDEX.md` 中是否包含该 REQ 的记录 | Status = in-progress, Current Phase = req |

**注意**：判据满足时，不输出检查清单，直接进入下一阶段。以下格式仅用于判据不满足时。

### plan → audit

| 检查项 | 验证方式 | 说明 |
|--------|---------|------|
| plan 文件已写入 | 检查 `.workflow/requirements/in-progress/REQ-xxx.plan.md` 是否存在 | 文件必须存在且非空 |
| plan 含 Tasks 小节 | 检查 plan 文件是否包含 `## 任务清单（Tasks）` 或 `## Tasks` | 必须包含任务列表 |
| plan 含 Validation 小节 | 检查 plan 文件是否包含 `## 测试规格（Test Specifications）` 或 `## Validation` | 必须包含验证方式 |
| plan 含复利候选小节 | 检查 plan 文件是否包含 `## 复利候选（Compounding Candidates）` | 必须包含复利候选小节（可为空） |
| INDEX 已更新 | 检查 `.workflow/requirements/INDEX.md` 中该 REQ 的 Status = planned | Status = planned, Current Phase = plan |

**注意**：判据满足时，不输出检查清单，直接进入下一阶段。以下格式仅用于判据不满足时。

### audit → work

| 检查项 | 验证方式 | 说明 |
|--------|---------|------|
| Blockers=0 | 检查 audit 审查报告中的"阻塞项"部分，确认无阻塞项 | 阻塞项列表为空或不存在 |
| 技术风险已评估 | 检查 audit 审查报告是否包含"技术风险评估"部分 | 必须包含风险评估结果 |
| 未决问题有明确处理方式 | 检查 audit 审查报告中的"建议项"是否都有处理方式（修正/接受/延期） | 建议项可以存在，但必须有处理方式 |
| 可执行性评分 ≥ 3 | 检查 audit 审查报告中的"可执行性评分"，必须 ≥ 3 | 评分标准：5=可直接执行，4=可执行，3=建议修正后执行，2/1=需修正 |

**注意**：判据满足时，不输出检查清单，直接进入下一阶段。以下格式仅用于判据不满足时。

### work → review

| 检查项 | 验证方式 | 说明 |
|--------|---------|------|
| Deliverables 关键项完成 | 检查 plan 的 Deliverables 部分，关键项（标记为"必须实现"）已完成 | 所有关键交付物已创建/修改 |
| 验证记录可复现 | 检查 plan 的 Test Specifications 是否完整，或 Status Summary 中是否有测试状态记录 | 验证方式必须可复现（Test Specifications 已定义，或测试已执行并记录状态） |
| 所有实现任务已完成 | 检查 plan 的 Tasks 部分，所有实现任务（非测试任务）已勾选 | 实现任务全部勾选 |
| 测试任务已完成（如适用） | 检查 plan 的 Tasks 部分，所有测试任务已勾选 | 测试任务全部勾选（如有） |

**注意**：判据满足时，不输出检查清单，直接进入下一阶段。以下格式仅用于判据不满足时。

### review → archive

| 检查项 | 验证方式 | 说明 |
|--------|---------|------|
| review 文件已写入 | 检查 `.workflow/requirements/in-progress/REQ-xxx.review.md` 是否存在 | 文件必须存在且非空 |
| Blockers/High 已处理 | 检查 review 文件中的"问题清单"，Blockers 和 High 级别问题已处理或明确拒绝 | Blockers 必须处理，High 可处理或明确拒绝并记录原因 |
| 审查结论明确 | 检查 review 文件是否包含"审查结论"部分，且结论明确（通过/需修复/拒绝） | 必须包含明确的审查结论 |
| 用户明确确认任务完成 | 检查用户是否明确确认"任务完成"（通过选择进入 archive 或明确声明） | 必须用户明确确认 |

**注意**：判据满足时，不输出检查清单，直接进入下一阶段。以下格式仅用于判据不满足时。

## 判据不满足时的处理

当判据不满足时，系统应：

1. **展示未满足项**：明确列出哪些判据未满足，以及未满足的原因
2. **提供选项**：
   - **强制推进**：用户明确要求即使判据不满足也要推进（需记录原因）
   - **回退**：回到上一阶段修正
   - **继续本阶段**：继续完善当前阶段，直到判据满足

**输出格式**：
```markdown
## 可推进判据检查清单（plan → audit）

| 判据 | 状态 | 说明 |
|------|------|------|
| plan 文件已写入 | ✅ 已满足 | REQ-004.plan.md 已创建 |
| plan 含 Tasks 小节 | ❌ 未满足 | plan 文件缺少 Tasks 小节 |
| plan 含 Validation 小节 | ✅ 已满足 | 包含测试规格 |
| plan 含复利候选小节 | ✅ 已满足 | 包含复利候选 |
| INDEX 已更新 | ✅ 已满足 | Status = planned |

**未满足项**：
- plan 含 Tasks 小节：plan 文件缺少 `## 任务清单（Tasks）` 小节

**处理选项**：
- A) 强制推进（需说明原因）
- B) 回退到 plan 阶段补充 Tasks
- C) 继续本阶段（plan）补充 Tasks
```

## 实现要求

1. **在 flow-router Skill 中实现判据检查函数**：读取对应文件，检查判据满足情况
2. **统一输出格式**：所有阶段切换都使用相同的表格格式（仅用于判据不满足时）
3. **强制执行**：AI 必须检查所有判据，不能跳过任何一项
4. **判据满足时静默进入**：用户选择 B 后，判据满足时，内部检查，不输出检查清单，直接进入下一阶段
5. **判据不满足时输出**：判据不满足时，输出完整检查清单，展示未满足项，提供选项（强制推进 / 回退 / 继续本阶段）
