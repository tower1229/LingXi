# candidate-evaluator 实现

## 概述

`candidate-evaluator` 是统一候选评估机制的核心 Skill，替代了原来分散的"噪音过滤器"、"成长过滤器"和"沉淀分流"逻辑，提供统一、严谨的多维度评估框架。

## 源码位置

`.cursor/skills/candidate-evaluator/SKILL.md`

## 配置

```yaml
---
name: candidate-evaluator
description: 统一候选评估机制，评估 EXP-CANDIDATE 的质量和分类决策。在 experience-collector 和 experience-depositor 中调用，执行结构完整性、判断结构质量、可复用性和沉淀载体适配性评估。
---
```

## 职责

1. **结构完整性评估**：检查必要字段（decision/alternatives/signal/solution/verify）
2. **判断结构质量评估**：评估是否包含"如何判断"的结构，而非"做了什么"的步骤
3. **可复用性评估**：评估时间维度（长期价值）、空间维度（跨项目价值）、抽象层次
4. **沉淀载体适配性评估**：推荐最适合的载体（experience/rules/skills/services/session）

## 输入输出

### 输入

- EXP-CANDIDATE JSON 对象
- 评估阶段（`stage1` 自动评估 或 `stage2` 详细评估）

### 输出

评估结果 JSON，包含各维度评估结果、推荐载体、理由等。

**输出格式**：

```json
{
  "structuralIntegrity": {
    "passed": true,
    "missingFields": [],
    "reason": ""
  },
  "decisionShapeQuality": {
    "passed": true,
    "reason": ""
  },
  "reusability": {
    "temporalDimension": {
      "passed": true,
      "score": 0.9,
      "reason": ""
    },
    "spatialDimension": {
      "passed": true,
      "score": 0.8,
      "reason": ""
    },
    "abstractionLevel": {
      "passed": true,
      "score": 0.85,
      "reason": ""
    },
    "overall": "high",
    "confidence": 0.85
  },
  "depositionTarget": {
    "recommended": ["experience"],
    "alternatives": ["session"],
    "reason": "",
    "expectedBenefit": ""
  },
  "requiresHumanJudgment": false,
  "filterReason": ""
}
```

## 评估维度

### 1. 结构完整性（Structural Integrity）

评估候选是否包含完整的判断结构。

**评估项**：
- ✅ 包含 `decision` 字段（判断了什么）
- ✅ 包含 `alternatives` 字段（拒绝了什么，至少 1 个）
- ✅ 包含 `signal` 字段（判断依据）
- ✅ 包含 `solution` 字段（解决方案）
- ✅ 包含 `verify` 字段（验证方式）

**分类标准**：
- **通过**：满足所有评估项，或至少包含关键字段（decision/alternatives/signal）→ 继续评估
- **不通过**：缺少关键字段（decision/alternatives/signal）→ 过滤，记录理由

### 2. 判断结构质量（Decision Shape Quality）

评估候选是否包含"如何判断"的结构，而非"做了什么"的步骤。

**评估项**：
- ✅ 能明确回答"Decision being made"（当时在判断什么）
- ✅ 能明确回答"Alternatives rejected"（拒绝了哪些备选方案，至少 1 个）
- ✅ 能明确回答"Discriminating signal"（靠什么可观测信号做出分叉）

**分类标准**：
- **通过**：能抽象出判断结构（有明确的决策点、备选方案、判断依据）→ 继续评估
- **不通过**：只是步骤描述，无法抽象出判断结构 → 过滤，记录理由

### 3. 可复用性（Reusability）

评估候选是否能在不同场景下复用。包含三个维度：

#### 3.1 时间维度（长期价值）

**评估问题**：一年后在完全不同的项目里，这条信息还能帮我提前做出正确判断吗？

**评估标准**：
- ✅ 能抽象出通用判断模式
- ✅ 不依赖特定项目/技术栈版本
- ✅ 包含可迁移的判断依据（signal）

#### 3.2 空间维度（跨项目价值）

**评估问题**：这条判断是否只适用于当前项目的特定约束？

**评估标准**：
- ✅ 判断依据（signal）具有通用性
- ✅ 解决方案（solution）可适用于类似场景
- ✅ 不依赖项目特定的配置/路径

#### 3.3 抽象层次

**评估问题**：这条候选能否抽象为更高层次的原则？

**评估标准**：
- ✅ 能从具体案例中抽象出判断原则
- ✅ 能适用于一类问题，而非单个问题
- ✅ 包含边界条件（什么情况下不适用）

#### 总体可复用性

根据三个维度的评分，计算总体可复用性：

- **高可复用性**（平均分 ≥ 0.8，且所有维度 ≥ 0.7）：适合 experience（长期资产）
- **中等可复用性**（平均分 0.5-0.8，或部分维度 ≥ 0.7）：适合 session/worklog（项目记录），或由人判断
- **低可复用性**（平均分 < 0.5）：过滤或仅保留为项目记录

### 4. 沉淀载体适配性（Deposition Target Fitness）

评估候选最适合沉淀到哪个载体。

**载体类型**：

| 载体 | 适用场景 | 评估信号 |
|------|---------|---------|
| **experience**（经验库） | 长期判断资产，需要提醒/指针 | ✅ 高可复用性 + ✅ 判断结构完整 |
| **rules**（规则库） | 可自动判定且高频的约束 | ✅ 可自动检查 + ✅ 高频出现 |
| **skills**（流程能力） | 可复用的流程或重复步骤 | ✅ 流程性质 + ✅ 多次重复 |
| **services**（服务上下文） | 服务边界/配置规范/考古知识 | ✅ 服务特定 + ✅ 长期有效 |
| **session/worklog**（项目记录） | 项目特定的临时记录 | ✅ 低可复用性 + ✅ 项目特定 |

## 评估阶段

### 阶段 1：自动评估（experience-collector）

**时机**：检测到 EXP-CANDIDATE 时自动执行

**流程**：
1. **结构完整性评估** → 不通过则过滤
2. **判断结构质量评估** → 不通过则过滤
3. **可复用性评估**（初步）→ 记录评估结果和置信度
4. **沉淀载体适配性评估**（初步）→ 记录推荐载体

**输出**：
- 通过所有评估的候选 → 暂存，记录评估结果和推荐载体
- 不通过的候选 → 过滤，记录过滤理由

**特点**：
- 静默处理，不干扰主对话
- 只过滤明显不通过的候选
- 边界模糊的候选仍暂存，标记"需要人工判断"

### 阶段 2：详细评估（experience-depositor）

**时机**：用户选择候选后，或展示候选前

**流程**：
1. 对阶段 1 的评估结果进行细化
2. 详细评估可复用性（3 个维度）
3. 详细评估沉淀载体适配性
4. 提供完整的评估结果和推荐载体

**输出**：
- 完整的评估结果，包括各维度评估结果、推荐载体、理由、预期收益等

**特点**：
- 详细的二次评估，提供充分的判断依据
- 用户可查看评估结果和调整推荐载体

## 使用场景

### 场景 1：experience-collector 自动评估（阶段 1）

- **时机**：检测到 EXP-CANDIDATE 时自动调用
- **目的**：初步过滤明显不通过的候选，避免暂存无价值的候选
- **特点**：静默处理，只过滤明显不通过的候选，边界模糊的候选仍暂存

### 场景 2：experience-depositor 详细评估（阶段 2）

- **时机**：用户选择候选后，或展示候选前
- **目的**：对候选进行详细评估，提供充分的判断依据和推荐载体
- **特点**：详细的二次评估，用户可查看评估结果和调整推荐载体

## 与旧设计的对比

### 移除的内容

1. **成长过滤器（单独机制）**：合并到"可复用性评估"维度中
2. **重复的评估逻辑**：统一为两阶段评估流程
3. **噪音过滤器（分散实现）**：整合为"结构完整性评估"和"判断结构质量评估"
4. **沉淀分流（分散逻辑）**：整合为"沉淀载体适配性评估"

### 改进的内容

1. **多维度评估**：从单一问题升级为多维度评估
2. **明确分类标准**：每个评估项都有明确的通过/不通过标准
3. **统一实现**：所有评估逻辑集中在候选评估机制中，避免重复
4. **用户体验优化**：用户选择后再进行详细评估，避免选择后又被过滤

## 注意事项

1. **保护品味**：边界模糊的候选不应强制过滤，应标记为需要人工判断
2. **可解释性**：每个评估结果都必须提供明确理由，支持人工复核
3. **评估一致性**：同一候选在不同阶段的评估结果应保持一致（阶段 2 是阶段 1 的细化）
4. **载体推荐**：推荐载体应基于评估结果，但最终决定权在用户

## 参考

- [候选评估机制设计](../../docs/02-design/candidate-evaluation.md)
- [知识沉淀机制设计](../../docs/02-design/knowledge-compounding.md)
- [experience-collector 实现](../subagents/experience-collector.md)
- [experience-depositor 实现](../subagents/experience-depositor.md)
- [噪音过滤器设计](../../docs/02-design/noise-filter.md)（已整合到本 Skill）
