# 设计原则与硬约束（由价值观推导）

本文档阐述灵犀（cursor-workflow）的**设计原则（系统不变量）**与硬约束：它们由价值观推导，用来约束系统在演进中不走偏。

- 价值观（核心原则 / SSoT）：见《[灵犀宪章](./lingxi-charter.md)》
- 分层与映射：见《[原则阶梯](./principle-ladder.md)》

## 设计原则（系统不变量）

### 1. Single Entrypoint（单入口）

**原则**：只使用 `/flow <REQ-xxx|描述>` 一个入口驱动整个工作流。

**为什么**：
- **降低认知负担**：用户不需要记忆多个命令
- **统一体验**：所有操作都通过同一个入口，体验一致
- **简化路由**：系统内部统一处理路由，而不是分散到多个命令

**实现**：
- 所有需求操作：`/flow <描述>` 或 `/flow REQ-xxx`
- 沉淀确认：`/flow 沉淀 ...` 或 `/flow 忽略沉淀`
- 质量准则采纳：`/flow 采纳质量准则 ...` 或 `/flow 忽略质量准则`

**禁止**：
- 不允许直接调用 `/req`、`/plan`、`/work` 等子命令
- 不允许绕过 `/flow` 直接操作底层组件

**参考**：[flow 命令实现](../03-implementation/commands/flow-command.md)

### 2. Human Gates（人工闸门）

**原则**：关键决策点必须有人工确认，不能自动推进。

**为什么**：
- **过程可控**：避免 AI 自动推进导致偏离预期
- **质量保证**：关键决策需要人的判断
- **可观测性**：每个阶段切换都是明确的，便于追踪

**实现**：
- **阶段推进**：每轮结束必须输出循环选项菜单，等待用户选择
- **质量闸门**：阶段切换前给出"可推进判据"，等待用户确认
- **循环选项**：
  ```
  A) 继续本阶段
  B) 进入下一阶段（等待确认）
  C) 回退到上一阶段
  D) 退出
  ```

**禁止**：
- 不允许静默自动推进到下一阶段
- 不允许跳过人工确认直接执行

**参考**：[工作流生命周期设计](../02-design/workflow-lifecycle.md)

### 3. Confirm-only Knowledge Capture（确认式知识捕获）

**原则**：未收到明确确认前，不得写入长期知识库。

**为什么**：
- **质量控制**：避免低质量信息污染知识库
- **责任归属**：关键决策需要人的明确授权
- **上下文理解**：人比 AI 更理解项目的长期目标和约束

**实现**：
- **经验写入**：必须通过 `/flow 沉淀 ...` 明确确认
- **质量准则采纳**：必须通过 `/flow 采纳质量准则 ...` 明确确认
- **暂存机制**：候选先暂存到 `session/pending-compounding-candidates.json`，等待确认

**禁止**：
- 不允许在未确认时写入 `.workflow/context/experience/`
- 不允许在未确认时写入 `.cursor/rules/qs-*`

**参考**：[知识沉淀机制设计](../02-design/knowledge-compounding.md)

### 4. 即时捕获，分层处理

**原则**：经验候选在工作过程中即时输出结构化 EXP-CANDIDATE，由后台 subagent 收集，前台 subagent 写入。

**为什么**：
- **不漏**：在工作过程中自动识别可沉淀点，不依赖人的记忆
- **不干扰**：后台静默处理，不打断主对话
- **分层**：区分短期项目记录（session）和长期判断资产（experience）

**实现**：
- **即时捕获**：Skills 在工作过程中输出 `<!-- EXP-CANDIDATE {...} -->` 注释
- **后台收集**：`experience-collector` 自动解析并暂存
- **成长过滤器**：判断是否进入长期知识库
- **前台写入**：`experience-depositor` 在用户确认后写入

**禁止**：
- 不允许在主对话中复制长日志来"传递上下文"
- 不允许跳过 EXP-CANDIDATE 机制直接写入经验

**参考**：
- [知识沉淀机制设计](../02-design/knowledge-compounding.md)
- [experience-collector 实现](../03-implementation/subagents/experience-collector.md)

### 5. 最小高信号上下文（Minimal High-Signal Context）

**原则**：在正确的时刻给到最小高信号信息，避免上下文膨胀。

**为什么**：
- **避免偏航**：上下文膨胀会导致 AI 关注无关信息
- **提高效率**：只加载必要信息，减少处理时间
- **可维护性**：避免文档膨胀，保持知识库精炼

**实现**：
- **指针优先**：先给文件路径、函数名、配置项等指针
- **按需加载**：只在需要时加载具体内容
- **分层加载**：按需展开，避免一次性加载所有信息
- **经验匹配**：通过 Trigger 匹配，只在相关场景加载对应经验

**禁止**：
- 不允许一次性加载所有可能相关的信息
- 不允许在主对话中复制长文本

**参考**：
- [Context Engineering Skill](../../.cursor/skills/context-engineering/SKILL.md)
- [experience-index 实现](../03-implementation/skills/foundation-skills/experience-index.md)

### 6. Skills-first 设计

**原则**：将高质量提示词、模板、检查清单下沉到 Skills，而不是硬编码在主命令中。

**为什么**：
- **可维护性**：Skills 独立维护，易于更新和扩展
- **可复用性**：Skills 可在不同场景复用
- **可测试性**：Skills 可以独立测试和验证
- **可组合性**：Skills 可以组合使用，形成复杂工作流

**实现**：
- **阶段 Playbook**：req、plan、audit、work、review、archive 各阶段的执行指南都在对应 Skill 中
- **底座能力**：index-manager、plan-manager、experience-index 等基础设施作为独立 Skill
- **工具能力**：service-loader、context-engineering、rules-creator 等辅助工具作为独立 Skill

**禁止**：
- 不允许在命令文件中硬编码大量提示词
- 不允许将阶段逻辑直接写在命令文件中

**参考**：
- [设计理念：Skills-first 设计](./philosophy.md#5-skills-first-设计)
- [各 Skills 实现](../03-implementation/skills/)

## 硬约束

### 约束 1：Single Entrypoint

- **必须**：所有需求操作都通过 `/flow` 入口
- **禁止**：直接调用底层 Skills 或子命令

### 约束 2：Human Gates

- **必须**：阶段推进必须输出菜单，等待用户选择
- **禁止**：静默自动推进到下一阶段

### 约束 3：Confirm-only Knowledge Capture

- **必须**：经验写入必须通过 `/flow 沉淀 ...` 明确确认
- **禁止**：在未确认时写入 `.workflow/context/experience/`

### 约束 4：即时捕获，分层处理

- **必须**：经验候选通过 EXP-CANDIDATE 结构化捕获
- **禁止**：在主对话中复制长日志

### 约束 5：最小高信号上下文

- **必须**：指针优先，按需加载
- **禁止**：一次性加载所有可能相关的信息

### 约束 6：Skills-first

- **必须**：阶段逻辑和检查清单在 Skills 中
- **禁止**：在命令文件中硬编码大量提示词

## 原则的权衡

### 可控性 vs 自动化

- **选择**：优先可控性，关键决策必须人工确认
- **权衡**：牺牲部分自动化，换取过程可控和质量保证

### 简洁性 vs 完整性

- **选择**：优先简洁性，最小高信号上下文
- **权衡**：可能遗漏部分信息，但避免上下文膨胀导致偏航

### 灵活性 vs 一致性

- **选择**：优先一致性，Single Entrypoint 和 Skills-first
- **权衡**：可能限制部分灵活性，但提高可维护性和可复用性

## 违反原则的后果

### 违反 Single Entrypoint

- **后果**：用户需要记忆多个命令，体验不一致
- **影响**：降低易用性，增加学习成本

### 违反 Human Gates

- **后果**：AI 自动推进可能导致偏离预期
- **影响**：过程不可控，难以追踪和回退

### 违反 Confirm-only Knowledge Capture

- **后果**：低质量信息污染知识库
- **影响**：知识库质量下降，后续匹配准确性降低

### 违反即时捕获，分层处理

- **后果**：依赖人的记忆，容易遗漏
- **影响**：知识沉淀不完整，成长能力受限

### 违反最小高信号上下文

- **后果**：上下文膨胀，AI 关注无关信息
- **影响**：处理效率下降，可能产生偏航

### 违反 Skills-first

- **后果**：提示词难以维护，无法复用
- **影响**：系统难以扩展和维护

## 原则的演进

这些原则不是一成不变的，但任何变更都需要：

1. **明确理由**：为什么需要变更
2. **影响评估**：变更对现有系统的影响
3. **文档更新**：更新本文档和相关设计文档
4. **决策记录**：在 [decision-log.md](../02-design/decision-log.md) 中记录

## 总结

这些核心原则是 cursor-workflow 设计的基石，任何实现都必须遵循。它们共同保证了系统的：

- **可控性**：过程可控，质量可保证
- **可维护性**：结构清晰，易于扩展
- **可复用性**：知识可沉淀，能力可复用
- **可观测性**：过程可追踪，状态可查询

违反这些原则会导致系统偏离设计目标，降低系统价值。
