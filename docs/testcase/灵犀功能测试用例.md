---
name: 灵犀功能测试用例
overview: 端到端测试灵犀核心功能，验证经验捕获、经验索引、经验沉淀等机制是否正常工作
---

# 灵犀功能测试用例

## 测试目标

验证灵犀 2.2 优化后的核心功能是否正常工作，包括：
1. 经验捕获机制（experience-capture）- AI Native 触发
2. 经验索引匹配（experience-index）- 上下文组织原则
3. 经验沉淀流程（experience-depositor）
4. 经验治理（experience-curator）
5. 各阶段命令执行（req, plan, build, review）

---

## 测试场景 1：经验捕获机制测试

### 测试目标
验证 experience-capture 的 AI Native 触发机制是否正常工作，能够基于语义理解捕获经验。

### 测试步骤

#### 步骤 1.1：创建需求并触发经验捕获

1. **执行命令**：
   ```
   /req 实现用户登录功能，必须支持手机号和邮箱两种登录方式
   ```

2. **预期行为**：
   - ✅ req-executor 激活，生成 req 文档
   - ✅ experience-index 激活，匹配相关经验（如果有）
   - ✅ experience-capture 激活，扫描用户输入

3. **验证点**：
   - [ ] req 文档成功生成（`.cursor/.lingxi/requirements/001.req.*.md`）
   - [ ] experience-index 输出经验提醒（如果有匹配的经验）
   - [ ] experience-capture 静默工作，不输出确认信息

#### 步骤 1.2：用户调整需求，触发经验捕获

1. **用户输入**（在 req 阶段）：
   ```
   改成只支持手机号登录，邮箱登录先不做，因为用户量不大
   ```

2. **预期行为**：
   - ✅ experience-capture 基于语义理解识别到"范围调整"经验信号
   - ✅ 生成 EXP-CANDIDATE（HTML 注释格式）
   - ✅ 静默捕获，不干扰对话

3. **验证点**：
   - [ ] 对话中不出现"已捕获经验候选"等确认信息
   - [ ] 检查对话历史中是否有 EXP-CANDIDATE HTML 注释
   - [ ] EXP-CANDIDATE 包含正确的 taskId、stage、trigger、decision 等字段

#### 步骤 1.3：用户明确约束，触发经验捕获

1. **用户输入**（在 req 阶段）：
   ```
   必须兼容 IE11，不能使用 ES6+ 语法
   ```

2. **预期行为**：
   - ✅ experience-capture 识别到"约束添加"经验信号
   - ✅ 生成 EXP-CANDIDATE

3. **验证点**：
   - [ ] EXP-CANDIDATE 正确捕获约束信息
   - [ ] trigger 字段包含"技术约束"相关描述

#### 步骤 1.4：用户肯定方案，触发经验捕获

1. **用户输入**（在 plan 阶段）：
   ```
   对，就用这个方案，记住了
   ```

2. **预期行为**：
   - ✅ experience-capture 识别到"用户肯定方案"经验信号
   - ✅ 生成 EXP-CANDIDATE

3. **验证点**：
   - [ ] EXP-CANDIDATE 正确捕获方案选择信息

---

## 测试场景 2：经验索引匹配测试

### 测试目标
验证 experience-index 是否能够正确匹配相关经验并提醒，遵循上下文组织原则。

### 前置条件
- 已有至少 1 条 active 经验在 team/INDEX.md 或 project/INDEX.md 中

### 测试步骤

#### 步骤 2.1：触发经验匹配

1. **执行命令**：
   ```
   /req 设计一个新的命令，需要判断是创建独立命令还是子命令
   ```

2. **预期行为**：
   - ✅ experience-index 读取 team/INDEX.md 和 project/INDEX.md（根据命令决定）
   - ✅ 匹配到 `command-design-separation` 经验（如果存在）
   - ✅ 输出简洁提醒（风险级别 + 指针）

3. **验证点**：
   - [ ] 输出格式：`⚠️ 高风险：XXX（参考 EXP-001.md）`
   - [ ] 不输出完整的结构化表格
   - [ ] 遵循"最小高信号"原则

#### 步骤 2.2：无匹配时静默

1. **执行命令**：
   ```
   /req 实现一个简单的按钮组件
   ```

2. **预期行为**：
   - ✅ experience-index 读取 team/INDEX.md 和 project/INDEX.md（根据命令决定）
   - ✅ 无匹配经验
   - ✅ 完全静默，不输出任何内容

3. **验证点**：
   - [ ] 不输出"无相关经验"等信息
   - [ ] 完全静默

---

## 测试场景 3：经验沉淀流程测试

### 测试目标
验证经验沉淀流程是否正常工作，包括候选展示、冲突检测、治理方案生成。

### 前置条件
- 测试场景 1 中已生成至少 1 个 EXP-CANDIDATE

### 测试步骤

#### 步骤 3.1：查看待沉淀候选

1. **检查文件**：
   ```
   .cursor/.lingxi/context/session/pending-compounding-candidates.json
   ```

2. **预期内容**：
   - ✅ 包含测试场景 1 中生成的 EXP-CANDIDATE
   - ✅ JSON 格式正确

3. **验证点**：
   - [ ] 文件存在且格式正确
   - [ ] 包含 taskId、stage、trigger 等字段

#### 步骤 3.2：沉淀经验（编号选择）

1. **执行命令**：
   ```
   /remember 1
   ```
   或直接输入：
   ```
   1
   ```

2. **预期行为**：
   - ✅ experience-depositor 激活
   - ✅ 读取候选列表
   - ✅ 展示候选及评估结果
   - ✅ 请求用户选择存储目标（团队级标准/经验或项目级经验）

3. **验证点**：
   - [ ] 候选展示包含评估结果（推荐载体、理由、预期收益）
   - [ ] 提供存储目标选择（A/B/C：团队级标准/经验或项目级经验）

#### 步骤 3.3：选择存储目标并确认

1. **用户选择**：
   ```
   A（存入团队级标准）
   ```
   或
   ```
   B（存入团队级经验）
   ```
   或
   ```
   C（存入项目级经验）
   ```

2. **预期行为**：
   - ✅ 冲突检测（根据 Level 检查对应的 INDEX.md：team/INDEX.md 或 project/INDEX.md）
   - ✅ 如有冲突，调用 experience-curator 生成治理方案
   - ✅ 用户确认治理方案
   - ✅ 写入经验文件（team/standards/、team/knowledge/ 或 project/）
   - ✅ 更新对应的 INDEX.md

3. **验证点**：
   - [ ] 经验文件成功写入（`team/standards/`、`team/knowledge/` 或 `project/` 目录）
   - [ ] 对应的 INDEX.md（team/INDEX.md 或 project/INDEX.md）成功更新
   - [ ] 经验文件包含 Decision Shape 和 Judgment Capsule

#### 步骤 3.4：沉淀经验（直接经验表达）

1. **执行命令**：
   ```
   /remember 测试用例必须包含前置条件和验证点
   ```

2. **预期行为**：
   - ✅ 从用户输入提取经验
   - ✅ 执行成长过滤器判断
   - ✅ 展示预览和存储目标选择
   - ✅ 用户确认后写入

3. **验证点**：
   - [ ] 经验成功提取并结构化
   - [ ] 成长过滤器正确判断（是否进入长期知识库）
   - [ ] 经验成功写入

---

## 测试场景 4：经验治理测试

### 测试目标
验证 experience-curator 的合并/取代机制是否正常工作。

### 前置条件
- 已有至少 2 条相似经验在 team/INDEX.md 或 project/INDEX.md 中

### 测试步骤

#### 步骤 4.1：沉淀相似经验

1. **沉淀新经验**（与现有经验相似）：
   ```
   /remember 设计新功能时，必须考虑向后兼容性
   ```

2. **预期行为**：
   - ✅ 冲突检测识别到相似经验
   - ✅ experience-curator 方案模式生成治理方案
   - ✅ 展示治理方案（合并/取代建议）

3. **验证点**：
   - [ ] 治理方案包含动作、理由、影响
   - [ ] 用户可以选择确认或调整

#### 步骤 4.2：执行治理

1. **用户确认治理方案**

2. **预期行为**：
   - ✅ experience-curator 执行模式执行治理
   - ✅ 备份对应的 INDEX.md（根据 Level）
   - ✅ 更新对应的 INDEX.md（合并/取代）
   - ✅ 建立 Replaces/ReplacedBy 关系
   - ✅ 删除备份文件

3. **验证点**：
   - [ ] 对应的 INDEX.md（team/INDEX.md 或 project/INDEX.md）正确更新
   - [ ] 旧经验 Status 改为 deprecated
   - [ ] 新经验 Replaces 字段包含旧经验 Tag
   - [ ] 备份文件已删除

---

## 测试场景 5：上下文组织原则测试

### 测试目标
验证上下文组织原则是否在 experience-index 中正确应用。

### 测试步骤

#### 步骤 5.1：验证分层加载

1. **执行命令**：
   ```
   /req 实现用户权限管理功能
   ```

2. **预期行为**：
   - ✅ experience-index 先读取 team/INDEX.md 和 project/INDEX.md（索引层）
   - ✅ 匹配到经验后，按需加载经验文件（细节层）

3. **验证点**：
   - [ ] 遵循"先指针后细节"原则
   - [ ] 输出时先给文件指针，而非直接输出详细内容

#### 步骤 5.2：验证最小高信号

1. **检查 experience-index 输出**

2. **预期行为**：
   - ✅ 仅输出关键信息（风险级别 + 指针）
   - ✅ 省略冗长的结构化格式

3. **验证点**：
   - [ ] 输出简洁（1-2 行）
   - [ ] 不包含完整的结构化表格

---

## 测试场景 6：端到端流程测试

### 测试目标
验证完整的 req → plan → build → review 流程是否正常工作。

### 测试步骤

#### 步骤 6.1：创建需求

1. **执行命令**：
   ```
   /req 实现用户注册功能，支持手机号和邮箱注册
   ```

2. **验证点**：
   - [ ] req 文档成功生成
   - [ ] experience-index 匹配相关经验（如果有）
   - [ ] experience-capture 静默工作

#### 步骤 6.2：任务规划

1. **执行命令**：
   ```
   /plan 001
   ```

2. **验证点**：
   - [ ] plan 文档成功生成
   - [ ] testcase 文档成功生成
   - [ ] experience-capture 捕获规划过程中的经验（如果有）

#### 步骤 6.3：执行构建

1. **执行命令**：
   ```
   /build 001
   ```

2. **验证点**：
   - [ ] 代码实现成功
   - [ ] 测试通过
   - [ ] experience-capture 捕获实现过程中的经验（如果有）

#### 步骤 6.4：审查

1. **执行命令**：
   ```
   /review 001
   ```

2. **验证点**：
   - [ ] 审查报告生成
   - [ ] experience-capture 捕获审查过程中的经验（如果有）

---

## 测试检查清单

### 功能检查

- [ ] experience-capture 基于语义理解触发，不进行关键词匹配
- [ ] experience-index 正确匹配相关经验并提醒
- [ ] experience-index 无匹配时完全静默
- [ ] experience-depositor 正确展示候选和评估结果
- [ ] experience-depositor 正确执行冲突检测
- [ ] experience-curator 正确生成和执行治理方案
- [ ] 经验文件包含 Decision Shape 和 Judgment Capsule
- [ ] team/INDEX.md 和 project/INDEX.md 正确更新

### 原则检查

- [ ] 遵循 AI Native 原则（依赖语义理解，不硬编码规则）
- [ ] 遵循上下文组织原则（先指针后细节、最小高信号、分层加载）
- [ ] 遵循静默成功原则（文件写入成功时静默）
- [ ] 遵循确认机制（经验沉淀需要用户确认）

### 文件检查

- [ ] `.cursor/.lingxi/requirements/` 目录下文件正确生成
- [ ] `.cursor/.lingxi/context/experience/` 目录下经验文件正确生成
- [ ] `.cursor/.lingxi/context/experience/team/INDEX.md` 和 `project/INDEX.md` 正确更新
- [ ] `.cursor/.lingxi/context/session/pending-compounding-candidates.json` 正确生成和清理

---

## 测试结果记录

### 测试日期
_________

### 测试环境
- Cursor 版本：_________
- 操作系统：_________

### 测试结果

| 测试场景 | 状态 | 问题描述 | 备注 |
|---------|------|---------|------|
| 场景 1：经验捕获机制 | ⬜ 通过 / ⬜ 失败 | | |
| 场景 2：经验索引匹配 | ⬜ 通过 / ⬜ 失败 | | |
| 场景 3：经验沉淀流程 | ⬜ 通过 / ⬜ 失败 | | |
| 场景 4：经验治理 | ⬜ 通过 / ⬜ 失败 | | |
| 场景 5：上下文组织原则 | ⬜ 通过 / ⬜ 失败 | | |
| 场景 6：端到端流程 | ⬜ 通过 / ⬜ 失败 | | |

### 发现的问题

1. 
2. 
3. 

---

## 注意事项

1. **测试顺序**：建议按场景顺序执行，因为后续场景可能依赖前置场景的结果
2. **清理数据**：测试完成后，可以清理测试生成的文件，避免影响后续测试
3. **验证方式**：检查文件系统、对话历史、输出内容等多维度验证
4. **AI Native 验证**：重点验证是否依赖语义理解而非硬编码规则
